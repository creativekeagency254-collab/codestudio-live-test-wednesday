<!DOCTYPE html>
<html lang="en" data-theme="light" data-surface="glass">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Dashboard - CODESTUDIO.KENYA</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <link href="https://unpkg.com/aos@next/dist/aos.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script>
    if (window.protectDashboard) protectDashboard();
  </script>
  <style>
    /* """"""""""""""""""""""""""""""""""""""""""""""
   THEME SYSTEM  dark is default
"""""""""""""""""""""""""""""""""""""""""""""" */
    :root {
      /* DARK (default) */
      --bg-page: #0A0A0A;
      --bg-sidebar: #000000;
      --bg-card: #111111;
      --bg-inset: #1A1A1A;
      --bg-hover: #242424;
      --bg-btn: #2E2E2E;

      --text-1: #FFFFFF;
      --text-2: #E4E4E4;
      --text-3: #C0C0C0;
      --text-4: #909090;
      --text-5: #606060;
      --text-6: #3A3A3A;

      --border-0: rgba(255, 255, 255, 0.04);
      --border-1: rgba(255, 255, 255, 0.08);
      --border-2: rgba(255, 255, 255, 0.14);
      --border-3: rgba(255, 255, 255, 0.26);

      --green: #22C55E;
      --gbg: rgba(34, 197, 94, .09);
      --gbdr: rgba(34, 197, 94, .22);
      --amber: #EAB308;
      --abg: rgba(234, 179, 8, .09);
      --abdr: rgba(234, 179, 8, .22);
      --red: #EF4444;
      --rbg: rgba(239, 68, 68, .09);
      --rbdr: rgba(239, 68, 68, .22);
      --blue: #60A5FA;
      --bbg: rgba(96, 165, 250, .09);
      --bbdr: rgba(96, 165, 250, .22);

      --r4: 4px;
      --r8: 8px;
      --r12: 12px;
      --r16: 16px;
      --r20: 20px;
      --rpill: 9999px;
      --shadow: 0 1px 3px rgba(0, 0, 0, .5);
    }

    [data-theme="light"] {
      --bg-page: #F5F5F5;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-inset: #F0F0F0;
      --bg-hover: #E8E8E8;
      --bg-btn: #E0E0E0;

      --text-1: #0A0A0A;
      --text-2: #1A1A1A;
      --text-3: #3A3A3A;
      --text-4: #606060;
      --text-5: #909090;
      --text-6: #C0C0C0;

      --border-0: rgba(0, 0, 0, 0.05);
      --border-1: rgba(0, 0, 0, 0.09);
      --border-2: rgba(0, 0, 0, 0.15);
      --border-3: rgba(0, 0, 0, 0.25);

      --green: #16A34A;
      --gbg: rgba(22, 163, 74, .08);
      --gbdr: rgba(22, 163, 74, .2);
      --amber: #B45309;
      --abg: rgba(180, 83, 9, .08);
      --abdr: rgba(180, 83, 9, .2);
      --red: #DC2626;
      --rbg: rgba(220, 38, 38, .08);
      --rbdr: rgba(220, 38, 38, .2);
      --blue: #2563EB;
      --bbg: rgba(37, 99, 235, .08);
      --bbdr: rgba(37, 99, 235, .2);
      --shadow: 0 1px 4px rgba(0, 0, 0, .1);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   BASE
"""""""""""""""""""""""""""""""""""""""""""""" */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      -webkit-font-smoothing: antialiased;
      transition: background .2s;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-page);
      color: var(--text-2);
      display: flex;
      min-height: 100vh;
      height: 100vh;
      overflow-x: hidden;
      overflow-y: hidden;
      line-height: 1.5;
      transition: background .2s, color .2s;
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-btn);
      border-radius: var(--rpill);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   SIDEBAR
"""""""""""""""""""""""""""""""""""""""""""""" */
    .sidebar {
      width: 230px;
      min-width: 230px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-1);
      display: flex;
      flex-direction: column;
      padding: 16px 11px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: background .2s, border-color .2s;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 3px 6px;
      margin-bottom: 20px;
    }

    .logo-mark {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, .92);
      color: #000;
      border: 1.6px solid #000;
      border-radius: var(--r8);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: border-color .2s, color .2s;
    }

    .logo-mark svg {
      width: 18px;
      height: 18px;
      stroke: #000;
      fill: none;
      stroke-width: 1.8;
    }

    .logo-name {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 6px;
      padding-top: 1px;
      min-width: 0;
      line-height: 1;
    }

    .brand-cursor {
      font-size: 11px;
      font-weight: 800;
      letter-spacing: .08em;
      color: var(--text-1);
      white-space: nowrap;
      overflow: hidden;
      width: 17ch;
      border-right: 1px solid var(--text-3);
      display: inline-block;
      vertical-align: top;
      animation: brandTypingLoop 8s steps(17, end) infinite, brandCaret .9s step-end infinite;
    }

    .brand-roll {
      position: relative;
      height: 14px;
      perspective: 360px;
      transform-style: preserve-3d;
      overflow: hidden;
      margin-top: 2px;
      width: 17ch;
      text-align: left;
    }

    .brand-roll span {
      position: absolute;
      inset: 0;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--text-5);
      transform-origin: center center -10px;
      backface-visibility: hidden;
      opacity: 0;
      animation: brandCubePause 12.5s infinite;
    }

    .brand-roll span:nth-child(1) {
      animation-delay: 0s;
    }

    .brand-roll span:nth-child(2) {
      animation-delay: 2.5s;
    }

    .brand-roll span:nth-child(3) {
      animation-delay: 5s;
    }

    .brand-roll span:nth-child(4) {
      animation-delay: 7.5s;
    }

    .brand-roll span:nth-child(5) {
      animation-delay: 10s;
    }

    @keyframes brandTypingLoop {
      0% {
        width: 0;
      }

      25%,
      75% {
        width: 17ch;
      }

      100% {
        width: 0;
      }
    }

    @keyframes brandCubePause {
      0%,
      8% {
        opacity: 1;
        transform: rotateX(0deg) translateZ(10px);
      }

      12% {
        opacity: 0;
        transform: rotateX(-90deg) translateZ(10px);
      }

      39%,
      100% {
        opacity: 0;
        transform: rotateX(-90deg) translateZ(10px);
      }
    }

    @keyframes brandCaret {
      50% {
        border-color: transparent;
      }
    }

    /* Avatar */
    .sb-user {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 9px;
      border-radius: var(--r8);
      border: 1px solid color-mix(in srgb, var(--green) 35%, var(--border-1));
      background:
        linear-gradient(120deg, rgba(125, 200, 112, 0.16), rgba(96, 165, 250, 0.09)),
        var(--bg-inset);
      margin-bottom: 16px;
      cursor: pointer;
      transition: border-color .15s, background .2s, box-shadow .2s;
    }

    .sb-user:hover {
      border-color: var(--border-2);
      box-shadow: 0 8px 20px rgba(0, 0, 0, .18);
    }

    .av {
      width: 32px;
      height: 32px;
      border-radius: var(--r8);
      flex-shrink: 0;
      overflow: hidden;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-3);
      border: 1px solid var(--border-1);
      position: relative;
    }

    .av img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .av-lg {
      width: 40px;
      height: 40px;
      border-radius: var(--r12);
      font-size: 14px;
    }

    .sb-uname {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-1);
    }

    .sb-urole {
      font-size: 9.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text-5);
      margin-top: 1px;
    }

    /* Nav */
    .nav-sec {
      font-size: 9px;
      font-weight: 800;
      letter-spacing: .13em;
      text-transform: uppercase;
      color: var(--text-6);
      padding: 0 7px;
      margin: 12px 0 4px;
    }

    .ni {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6.5px 8px;
      border-radius: var(--r8);
      color: var(--text-5);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      border: 1px solid transparent;
      margin-bottom: 1px;
      text-decoration: none;
      user-select: none;
    }

    .ni:hover {
      color: var(--text-2);
      background: var(--bg-inset);
    }

    .ni.active {
      color: var(--text-1);
      background: var(--bg-inset);
      border-color: var(--border-1);
    }

    .ni svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
    }

    .nc {
      margin-left: auto;
      font-size: 9px;
      font-weight: 800;
      color: var(--text-5);
      background: var(--bg-hover);
      padding: 1px 6px;
      border-radius: var(--rpill);
      border: 1px solid var(--border-0);
    }

    /* Sidebar footer */
    .sb-foot {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid var(--border-0);
    }

    /* Theme toggle */
    .theme-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6.5px 8px;
      border-radius: var(--r8);
      color: var(--text-5);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      background: none;
      border: 1px solid transparent;
      width: 100%;
      font-family: 'DM Sans', sans-serif;
      margin-bottom: 3px;
    }

    .theme-btn:hover {
      color: var(--text-2);
      background: var(--bg-inset);
    }

    .theme-btn svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    /* theme toggle pill */
    .theme-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 10px;
      border-radius: var(--r8);
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      margin-bottom: 6px;
      cursor: pointer;
      transition: all .15s;
    }

    .theme-pill:hover {
      border-color: var(--border-2);
    }

    .theme-pill-lbl {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
    }

    .theme-switch {
      width: 36px;
      height: 20px;
      border-radius: var(--rpill);
      background: var(--bg-btn);
      border: 1px solid var(--border-2);
      position: relative;
      transition: background .2s;
      cursor: pointer;
      flex-shrink: 0;
    }

    .theme-switch.on {
      background: var(--text-1);
    }

    .theme-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg-card);
      transition: all .2s;
    }

    .theme-switch.on::after {
      left: 18px;
      background: var(--bg-sidebar);
    }

    /* premium surface themes */
    .surface-pill {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: var(--r8);
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      margin-bottom: 7px;
      transition: border-color .15s;
    }

    .surface-pill:hover {
      border-color: var(--border-2);
    }

    .surface-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 0;
      width: 100%;
    }

    .surface-opt {
      border: 1px solid var(--border-2);
      background: var(--bg-btn);
      color: var(--text-4);
      border-radius: var(--rpill);
      padding: 4px 10px;
      min-height: 20px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: all .2s;
      white-space: nowrap;
    }

    .surface-opt:hover {
      border-color: var(--border-2);
      color: var(--text-2);
    }

    .surface-opt.active {
      border-color: var(--bbdr);
      color: var(--text-1);
      background: linear-gradient(120deg, var(--bbg), var(--bg-card));
    }

    .btn-live {
      background: var(--green);
      color: #041408;
      border: 1px solid var(--gbdr);
    }

    .btn-live:hover {
      filter: brightness(.95);
    }

    .cardfx-pill {
      padding: 8px 10px;
      border-radius: var(--r8);
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      margin-bottom: 7px;
    }

    .cardfx-label {
      font-size: 10.5px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--text-5);
      margin-bottom: 7px;
    }

    .cardfx-select {
      width: 100%;
      border: 1px solid var(--border-1);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-3);
      padding: 7px 9px;
      font-size: 11px;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      outline: none;
    }

    .cardfx-select:focus {
      border-color: var(--text-1);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, .08);
    }

    .card,
    .sc,
    .modal-card {
      position: relative;
      isolation: isolate;
      overflow: hidden;
    }

    .card::before,
    .sc::before,
    .modal-card::before {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background: var(--cardfx-bg, transparent);
      opacity: var(--cardfx-opacity, 0);
      mix-blend-mode: screen;
      animation: var(--cardfx-anim, none);
      transition: opacity .3s ease;
    }

    .card>*,
    .sc>*,
    .modal-card>* {
      position: relative;
      z-index: 1;
    }

    @keyframes cardFxGradientFlow {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 100% 50%;
      }
    }

    @keyframes cardFxGlassSweep {
      0% {
        transform: translateX(-120%) skewX(-16deg);
      }

      100% {
        transform: translateX(170%) skewX(-16deg);
      }
    }

    @keyframes cardFxBlobFloat {
      0% {
        transform: translate(0, 0) scale(1);
      }

      50% {
        transform: translate(-6px, 8px) scale(1.07);
      }

      100% {
        transform: translate(4px, -5px) scale(0.98);
      }
    }

    @keyframes cardFxGridShift {
      0% {
        background-position: 0 0, 0 0;
      }

      100% {
        background-position: 24px 24px, -24px -24px;
      }
    }

    @keyframes cardFxWaveDrift {
      0% {
        background-position: 0% 0%, 0% 100%;
      }

      100% {
        background-position: 100% 0%, -80% 100%;
      }
    }

    @keyframes cardFxParallax {
      0% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-6px);
      }

      100% {
        transform: translateY(3px);
      }
    }

    @keyframes cardFxGlowPulse {
      0% {
        opacity: .12;
      }

      50% {
        opacity: .22;
      }

      100% {
        opacity: .13;
      }
    }

    @keyframes cardFxDiagonalSweep {
      0% {
        transform: translateX(-110%);
      }

      45% {
        transform: translateX(160%);
      }

      100% {
        transform: translateX(160%);
      }
    }

    @keyframes cardFxNoiseShift {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 20px 26px;
      }
    }

    html[data-cardfx="gradient-flow"] {
      --cardfx-bg: linear-gradient(115deg, rgba(0, 184, 255, .28), rgba(58, 123, 213, .20), rgba(0, 242, 254, .28));
      --cardfx-opacity: .24;
      --cardfx-anim: cardFxGradientFlow 15s linear infinite;
    }

    html[data-cardfx="glass-reflection"] {
      --cardfx-bg: linear-gradient(90deg, transparent 28%, rgba(255, 255, 255, .38) 49%, transparent 72%);
      --cardfx-opacity: .42;
      --cardfx-anim: cardFxGlassSweep 8.5s linear infinite;
    }

    html[data-cardfx="floating-blobs"] {
      --cardfx-bg: radial-gradient(circle at 20% 26%, rgba(56, 189, 248, .30), transparent 42%), radial-gradient(circle at 76% 78%, rgba(37, 99, 235, .24), transparent 48%);
      --cardfx-opacity: .24;
      --cardfx-anim: cardFxBlobFloat 9s ease-in-out infinite alternate;
    }

    html[data-cardfx="particle-network"] {
      --cardfx-bg: radial-gradient(circle at center, rgba(102, 170, 255, .19) 0.6px, transparent 0.8px);
      --cardfx-opacity: .24;
      --cardfx-anim: cardFxGradientFlow 22s linear infinite;
    }

    html[data-cardfx="particle-network"] .card::before,
    html[data-cardfx="particle-network"] .sc::before,
    html[data-cardfx="particle-network"] .modal-card::before {
      background-size: 18px 18px;
    }

    html[data-cardfx="moving-grid"] {
      --cardfx-bg: linear-gradient(rgba(148, 163, 184, .16) 1px, transparent 1px), linear-gradient(90deg, rgba(148, 163, 184, .16) 1px, transparent 1px);
      --cardfx-opacity: .22;
      --cardfx-anim: cardFxGridShift 14s linear infinite;
    }

    html[data-cardfx="moving-grid"] .card::before,
    html[data-cardfx="moving-grid"] .sc::before,
    html[data-cardfx="moving-grid"] .modal-card::before {
      background-size: 22px 22px;
    }

    html[data-cardfx="animated-waves"] {
      --cardfx-bg: radial-gradient(120% 80% at 0% 100%, rgba(0, 122, 255, .22), transparent 60%), radial-gradient(120% 80% at 100% 0%, rgba(34, 197, 94, .18), transparent 58%);
      --cardfx-opacity: .22;
      --cardfx-anim: cardFxWaveDrift 16s ease-in-out infinite alternate;
    }

    html[data-cardfx="parallax-layers"] {
      --cardfx-bg: linear-gradient(140deg, rgba(255, 255, 255, .12), transparent 30%, rgba(255, 255, 255, .05) 60%, transparent 100%);
      --cardfx-opacity: .24;
      --cardfx-anim: cardFxParallax 8s ease-in-out infinite;
    }

    html[data-cardfx="glow-pulse"] {
      --cardfx-bg: radial-gradient(circle at 50% 24%, rgba(250, 204, 21, .30), transparent 56%);
      --cardfx-opacity: .22;
      --cardfx-anim: cardFxGlowPulse 3.8s ease-in-out infinite;
    }

    html[data-cardfx="diagonal-sweep"] {
      --cardfx-bg: linear-gradient(112deg, transparent 30%, rgba(255, 255, 255, .30) 50%, transparent 70%);
      --cardfx-opacity: .27;
      --cardfx-anim: cardFxDiagonalSweep 7.8s ease-in-out infinite;
    }

    html[data-cardfx="noise-grain"] {
      --cardfx-bg: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, .09) 0.6px, transparent 0.7px);
      --cardfx-opacity: .20;
      --cardfx-anim: cardFxNoiseShift 1.4s steps(2, jump-none) infinite;
    }

    html[data-cardfx="noise-grain"] .card::before,
    html[data-cardfx="noise-grain"] .sc::before,
    html[data-cardfx="noise-grain"] .modal-card::before {
      background-size: 7px 7px;
    }

    @keyframes glassReflect {
      0% {
        transform: translateX(-150%) skewX(-18deg);
      }

      55% {
        transform: translateX(170%) skewX(-18deg);
      }

      100% {
        transform: translateX(170%) skewX(-18deg);
      }
    }

    html[data-surface="glass"] .card,
    html[data-surface="glass"] .sc,
    html[data-surface="glass"] .modal-card {
      position: relative;
      overflow: hidden;
      background:
        linear-gradient(140deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .02)),
        color-mix(in srgb, var(--bg-card) 88%, transparent 12%);
      border-color: color-mix(in srgb, var(--border-2) 88%, rgba(255, 255, 255, .2) 12%);
      backdrop-filter: blur(14px) saturate(128%);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, .18),
        0 14px 28px rgba(0, 0, 0, .22);
    }

    html[data-surface="glass"] .card::after,
    html[data-surface="glass"] .sc::after,
    html[data-surface="glass"] .modal-card::after {
      content: '';
      position: absolute;
      top: -40%;
      left: -80%;
      width: 52%;
      height: 220%;
      pointer-events: none;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .26), transparent);
      animation: glassReflect 9.5s linear infinite;
      opacity: .32;
    }

    html[data-surface="grid"] .card,
    html[data-surface="grid"] .sc,
    html[data-surface="grid"] .modal-card {
      position: relative;
      overflow: hidden;
      background:
        linear-gradient(var(--border-0) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-0) 1px, transparent 1px),
        color-mix(in srgb, var(--bg-card) 94%, transparent 6%);
      background-size: 18px 18px, 18px 18px, auto;
      border-color: color-mix(in srgb, var(--border-2) 92%, rgba(255, 255, 255, .08) 8%);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, .05),
        0 10px 18px rgba(0, 0, 0, .20);
    }

    html[data-surface="grid"] .card::after,
    html[data-surface="grid"] .sc::after,
    html[data-surface="grid"] .modal-card::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(180deg, rgba(255, 255, 255, .04), transparent 55%);
      opacity: .32;
    }

    .so-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6.5px 8px;
      border-radius: var(--r8);
      color: var(--text-5);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      background: none;
      border: none;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
    }

    .so-btn:hover {
      color: var(--red);
      background: var(--rbg);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   MAIN AREA
"""""""""""""""""""""""""""""""""""""""""""""" */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
      min-height: 0;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 26px;
      border-bottom: 1px solid var(--border-0);
      background: var(--bg-page);
      position: sticky;
      top: 0;
      z-index: 50;
      transition: background .2s, border-color .2s;
    }

    .pg-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--text-1);
    }

    .pg-sub {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 1px;
    }

    .tb-right {
      display: flex;
      align-items: center;
      gap: 7px;
    }

    /* Connection indicator */
    .db-status {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: var(--rpill);
      font-size: 10.5px;
      font-weight: 600;
      background: var(--gbg);
      border: 1px solid var(--gbdr);
      color: var(--green);
      cursor: default;
    }

    .db-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    /* PAGES  only active shows */
    .page {
      display: none;
      padding: 22px 26px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable both-edges;
    }

    .page.active {
      display: block;
    }

    .msg-filter-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   BUTTONS
"""""""""""""""""""""""""""""""""""""""""""""" */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: 'DM Sans', sans-serif;
      font-size: 12.5px;
      font-weight: 600;
      padding: 7px 14px;
      border-radius: var(--r8);
      cursor: pointer;
      transition: all .15s;
      border: none;
      white-space: nowrap;
    }

    .btn-w {
      background: var(--text-1);
      color: var(--bg-sidebar);
    }

    .btn-w:hover {
      opacity: .88;
    }

    .btn-g {
      background: transparent;
      border: 1px solid var(--border-2);
      color: var(--text-3);
    }

    .btn-g:hover {
      border-color: var(--border-3);
      color: var(--text-1);
      background: var(--bg-inset);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11.5px;
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   CARDS
"""""""""""""""""""""""""""""""""""""""""""""" */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-1);
      border-radius: var(--r16);
      padding: 18px;
      transition: border-color .2s, background .2s;
      box-shadow: var(--shadow);
    }

    .card:hover {
      border-color: var(--border-2);
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 12.5px;
      font-weight: 700;
      color: var(--text-2);
      letter-spacing: -.01em;
    }

    .card-lnk {
      font-size: 11.5px;
      color: var(--text-5);
      cursor: pointer;
      transition: color .15s;
    }

    .card-lnk:hover {
      color: var(--text-1);
    }

    /* Stat cards */
    .sc {
      background: var(--bg-card);
      border: 1px solid var(--border-1);
      border-radius: var(--r16);
      padding: 16px 18px;
      transition: all .2s;
      cursor: default;
      box-shadow: var(--shadow);
    }

    .sc:hover {
      border-color: var(--border-2);
      background: var(--bg-inset);
    }

    .sc-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--r8);
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      margin-bottom: 11px;
    }

    .sc-icon svg,
    .tx-ico svg,
    .qa-ico svg,
    .notif-ico svg,
    #profile-camera-trigger svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
    }

    .sc-val {
      font-family: 'DM Mono', monospace;
      font-size: 20px;
      font-weight: 500;
      color: var(--text-1);
      letter-spacing: -.03em;
      margin-bottom: 2px;
    }

    .sc-lbl {
      font-size: 11px;
      color: var(--text-5);
      font-weight: 500;
    }

    .sc-d {
      font-size: 11px;
      margin-top: 5px;
    }

    .up {
      color: var(--green);
    }

    .dn {
      color: var(--red);
    }

    .neu {
      color: var(--text-5);
    }

    .sc-d.up::before {
      content: '+ ';
    }

    .sc-d.dn::before {
      content: '- ';
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   BADGES
"""""""""""""""""""""""""""""""""""""""""""""" */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--rpill);
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    .b-g {
      background: var(--gbg);
      color: var(--green);
      border: 1px solid var(--gbdr);
    }

    .b-a {
      background: var(--abg);
      color: var(--amber);
      border: 1px solid var(--abdr);
    }

    .b-r {
      background: var(--rbg);
      color: var(--red);
      border: 1px solid var(--rbdr);
    }

    .b-b {
      background: var(--bbg);
      color: var(--blue);
      border: 1px solid var(--bbdr);
    }

    .b-w {
      background: var(--bg-hover);
      color: var(--text-2);
      border: 1px solid var(--border-1);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   TABLE
"""""""""""""""""""""""""""""""""""""""""""""" */
    .tbl {
      width: 100%;
      border-collapse: collapse;
    }

    .tbl th {
      text-align: left;
      padding: 0 10px 8px;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--text-6);
      border-bottom: 1px solid var(--border-1);
    }

    .tbl td {
      padding: 9px 10px;
      font-size: 12.5px;
      border-bottom: 1px solid var(--border-0);
      vertical-align: middle;
      color: var(--text-2);
    }

    .tbl tr:last-child td {
      border-bottom: none;
    }

    .tbl tr:hover td {
      background: var(--bg-inset);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   PROGRESS
"""""""""""""""""""""""""""""""""""""""""""""" */
    .pbg {
      background: var(--bg-hover);
      border-radius: var(--rpill);
      height: 3px;
      overflow: hidden;
    }

    .pf {
      height: 100%;
      border-radius: var(--rpill);
      background: var(--text-1);
      transition: width .8s cubic-bezier(.16, 1, .3, 1);
    }

    .pf-g {
      background: var(--green);
    }

    .pf-a {
      background: var(--amber);
    }

    /* """"""""""""""""""""""""""""""""""""""""""""""
   MISC
"""""""""""""""""""""""""""""""""""""""""""""" */
    .sl {
      font-size: 9px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-6);
      margin-bottom: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sl::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-0);
    }

    .mono {
      font-family: 'DM Mono', monospace;
    }

    .div {
      height: 1px;
      background: var(--border-0);
      margin: 12px 0;
    }

    .g4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 11px;
      margin-bottom: 18px;
    }

    .g2l {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 13px;
      margin-bottom: 18px;
    }

    .g2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 13px;
      margin-bottom: 18px;
    }

    .g2b {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* milestone tracker */
    .ms-row {
      display: flex;
      align-items: flex-start;
      gap: 11px;
    }

    .ms-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 14px;
      flex-shrink: 0;
      padding-top: 1px;
    }

    .ms-dot {
      width: 13px;
      height: 13px;
      border-radius: 50%;
      border: 2px solid var(--border-2);
      background: var(--bg-inset);
      flex-shrink: 0;
    }

    .ms-dot.done {
      background: var(--green);
      border-color: var(--gbdr);
    }

    .ms-dot.cur {
      background: var(--text-1);
      border-color: var(--text-1);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, .1);
    }

    .ms-dot.locked {
      background: var(--bg-inset);
      border-color: var(--border-1);
    }

    .ms-line {
      width: 1px;
      flex: 1;
      min-height: 18px;
      background: var(--border-1);
      margin: 3px 0;
    }

    .ms-line.done {
      background: var(--gbdr);
    }

    .ms-body {
      padding-bottom: 14px;
      flex: 1;
      min-width: 0;
    }

    .ms-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-3);
    }

    .ms-title.done {
      color: var(--green);
    }

    .ms-title.cur {
      color: var(--text-1);
    }

    .ms-title.locked {
      color: var(--text-6);
    }

    .ms-sub {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 1px;
    }

    /* project row in cards */
    .proj-row {
      padding: 11px 0;
      border-bottom: 1px solid var(--border-0);
    }

    .proj-row:last-child {
      border-bottom: none;
    }

    /* ring chart */
    .ring-wrap {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 4px 0 12px;
    }

    .ring-chart {
      position: relative;
      width: 100px;
      height: 100px;
      flex-shrink: 0;
    }

    .ring-chart svg {
      transform: rotate(-90deg);
    }

    .ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .ring-val {
      font-family: 'DM Mono', monospace;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-1);
    }

    .ring-lbl {
      font-size: 9px;
      color: var(--text-5);
    }

    .legend {
      display: flex;
      flex-direction: column;
      gap: 7px;
      flex: 1;
    }

    .leg {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
    }

    .leg-dot {
      width: 7px;
      height: 7px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .leg-lbl {
      color: var(--text-4);
      flex: 1;
    }

    .leg-val {
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--text-2);
    }

    /* transaction */
    .tx {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-0);
    }

    .tx:last-child {
      border-bottom: none;
    }

    .tx-ico {
      width: 28px;
      height: 28px;
      border-radius: var(--r8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .tx-info {
      flex: 1;
    }

    .tx-name {
      font-size: 12.5px;
      font-weight: 600;
      color: var(--text-2);
    }

    .tx-date {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 1px;
    }

    .tx-amt {
      font-family: 'DM Mono', monospace;
      font-size: 12.5px;
      font-weight: 500;
    }

    /* messages */
    .msg {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 9px 6px;
      cursor: pointer;
      border-radius: var(--r8);
      border-bottom: 1px solid var(--border-0);
      transition: background .15s;
    }

    .msg:last-child {
      border-bottom: none;
    }

    .msg:hover {
      background: var(--bg-inset);
    }

    .project-row-action {
      cursor: pointer;
    }

    .project-row-action td {
      transition: background .16s ease;
    }

    .project-row-action:hover td {
      background: var(--bg-inset);
    }

    .msg-body {
      flex: 1;
      min-width: 0;
    }

    .msg-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .msg-sender {
      font-size: 12.5px;
      font-weight: 700;
      color: var(--text-1);
    }

    .msg-time {
      font-size: 10px;
      color: var(--text-6);
    }

    .msg-prev {
      font-size: 11.5px;
      color: var(--text-5);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .unread-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-1);
      flex-shrink: 0;
      margin-top: 5px;
    }

    /* dev list */
    .dev-row {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 9px;
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      border-radius: var(--r12);
      margin-bottom: 6px;
      transition: border-color .15s;
    }

    .dev-row:hover {
      border-color: var(--border-2);
    }

    .dev-row:last-child {
      margin-bottom: 0;
    }

    .dev-info {
      flex: 1;
    }

    .dev-name {
      font-size: 12.5px;
      font-weight: 700;
      color: var(--text-1);
    }

    .dev-spec {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 1px;
    }

    .online {
      font-size: 11px;
      font-weight: 600;
      color: var(--green);
    }

    .away {
      font-size: 11px;
      font-weight: 600;
      color: var(--amber);
    }

    .offline {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-6);
    }

    .online::before,
    .away::before,
    .offline::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }

    .online::before {
      background: var(--green);
    }

    .away::before {
      background: var(--amber);
    }

    .offline::before {
      background: var(--text-6);
    }

    /* quick actions */
    .qa {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 3px;
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      border-radius: var(--r12);
      padding: 11px;
      cursor: pointer;
      transition: all .15s;
      text-align: left;
      width: 100%;
    }

    .qa:hover {
      border-color: var(--border-2);
      background: var(--bg-hover);
    }

    .qa-ico {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .qa-lbl {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-1);
    }

    .qa-desc {
      font-size: 10.5px;
      color: var(--text-5);
    }

    /* notification item */
    .notif {
      display: flex;
      gap: 9px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-0);
    }

    .notif:last-child {
      border-bottom: none;
    }

    .notif-ico {
      width: 30px;
      height: 30px;
      border-radius: var(--r8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
      background: var(--bg-inset);
    }

    .notif-body {
      flex: 1;
    }

    .notif-title {
      font-size: 12.5px;
      font-weight: 600;
      color: var(--text-2);
    }

    .notif-sub {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 1px;
    }

    .notif-time {
      font-size: 10px;
      color: var(--text-6);
      margin-top: 3px;
    }

    /* billing */
    .plan-card {
      background: var(--bg-inset);
      border: 1px solid var(--border-2);
      border-radius: var(--r12);
      padding: 16px;
      margin-bottom: 12px;
    }

    .plan-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-1);
      margin-bottom: 3px;
    }

    .plan-price {
      font-family: 'DM Mono', monospace;
      font-size: 22px;
      font-weight: 500;
      color: var(--text-1);
    }

    .plan-sub {
      font-size: 11px;
      color: var(--text-5);
      margin-top: 2px;
    }

    /* input */
    .input {
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      color: var(--text-1);
      border-radius: var(--r8);
      padding: 8px 11px;
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
      outline: none;
      transition: border-color .15s;
    }

    .input:focus {
      border-color: var(--border-3);
    }

    .input::placeholder {
      color: var(--text-6);
    }

    .input-lbl {
      display: block;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--text-5);
      margin-bottom: 4px;
    }

    .action-form {
      margin-top: 10px;
      padding: 12px;
      border: 1px solid var(--border-1);
      border-radius: var(--r12);
      background: var(--bg-inset);
      display: block;
    }

    .action-form.hidden {
      display: none;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .select {
      background: var(--bg-inset);
      border: 1px solid var(--border-1);
      color: var(--text-1);
      border-radius: var(--r8);
      padding: 8px 11px;
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
      outline: none;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 18px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal-card {
      width: min(560px, 96vw);
      background: var(--bg-card);
      border: 1px solid var(--border-1);
      border-radius: var(--r16);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-1);
      margin-bottom: 4px;
    }

    .modal-sub {
      font-size: 11.5px;
      color: var(--text-5);
      margin-bottom: 14px;
    }

    .detail-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 12px 0 14px;
    }

    .detail-item {
      border: 1px solid var(--border-1);
      border-radius: var(--r10);
      background: var(--bg-inset);
      padding: 9px 10px;
    }

    .detail-k {
      font-size: 10px;
      color: var(--text-5);
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .detail-v {
      font-size: 12px;
      color: var(--text-1);
      font-weight: 600;
      margin-top: 2px;
      word-break: break-word;
    }

    .project-detail-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0 0;
      padding: 10px;
      border: 1px solid var(--border-1);
      border-radius: var(--r10);
      background: var(--bg-inset);
      font-size: 11px;
      color: var(--text-3);
    }

    .project-detail-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .support-fab-client {
      position: fixed;
      right: 20px;
      bottom: 22px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #242424, #050505 65%);
      border: 1px solid #3a3a3a;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .16);
      color: #fff;
      z-index: 980;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      animation: supportFloatClient 2.8s ease-in-out infinite;
    }

    .support-fab-client::before {
      content: 'Message us';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      font-size: 9.5px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--text-4);
      white-space: nowrap;
    }

    .support-fab-client svg {
      width: 24px;
      height: 24px;
      stroke: #fff;
      fill: none;
      stroke-width: 1.8;
      animation: supportSpinClient 2s ease-in-out infinite;
    }

    .support-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .56);
      backdrop-filter: blur(3px);
      z-index: 990;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .support-overlay.open {
      display: flex;
    }

    .support-panel {
      width: min(420px, 92vw);
      border-radius: var(--r16);
      border: 1px solid var(--border-2);
      background: var(--bg-card);
      padding: 16px;
      box-shadow: 0 20px 48px rgba(0, 0, 0, .35);
    }

    .support-panel h3 {
      font-size: 16px;
      color: var(--text-1);
      margin-bottom: 4px;
    }

    .support-panel p {
      font-size: 12px;
      color: var(--text-4);
      margin-bottom: 12px;
    }

    .support-contact-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border-1);
      border-radius: var(--r10);
      background: var(--bg-inset);
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-2);
    }

    .support-contact-main {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex: 1;
    }

    .support-main-stack {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .support-main-line {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .support-fast-badge {
      display: inline-flex;
      align-items: center;
      width: fit-content;
      max-width: 100%;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: #06311b;
      background: #9AE6B4;
      border: 1px solid #34d399;
      border-radius: 999px;
      padding: 2px 8px;
    }

    .support-contact-actions {
      display: flex;
      gap: 8px;
    }

    .support-icon-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--r8);
      border: 1px solid var(--border-2);
      background: var(--bg-page);
      color: var(--text-2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }

    .support-icon-btn:hover {
      border-color: var(--border-3);
      background: var(--bg-hover);
    }

    .support-wa-btn {
      height: 32px;
      border-radius: var(--r8);
      border: 1px solid #34d399;
      background: linear-gradient(145deg, #31d26a, #1db954);
      color: #06210f;
      font-size: 11px;
      font-weight: 700;
      padding: 0 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform .15s ease, filter .15s ease;
    }

    .support-wa-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
    }

    @keyframes supportFloatClient {
      0%,
      100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-8px);
      }
    }

    @keyframes supportSpinClient {
      0%,
      75%,
      100% {
        transform: rotate(0deg);
      }
      82% {
        transform: rotate(18deg);
      }
      90% {
        transform: rotate(-18deg);
      }
    }

    /* toast */
    .toast {
      position: fixed;
      bottom: 22px;
      right: 22px;
      background: var(--text-1);
      color: var(--bg-sidebar);
      padding: 9px 16px;
      border-radius: var(--r8);
      font-size: 12.5px;
      font-weight: 700;
      z-index: 9999;
      animation: fadeUp .25s ease;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .fu {
      animation: fadeUp .28s ease both;
    }

    .d1 {
      animation-delay: .04s
    }

    .d2 {
      animation-delay: .08s
    }

    .d3 {
      animation-delay: .12s
    }

    .d4 {
      animation-delay: .16s
    }

    /* loading state */
    .skeleton {
      background: var(--bg-hover);
      border-radius: var(--r8);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        opacity: .6
      }

      50% {
        opacity: 1
      }

      100% {
        opacity: .6
      }
    }

    .loading-text {
      font-size: 12px;
      color: var(--text-5);
      text-align: center;
      padding: 20px;
    }

    .dashboard-prelayout {
      margin-bottom: 12px;
      border: 1px solid var(--border-1);
      border-radius: var(--r12);
      padding: 12px;
      background: linear-gradient(145deg, var(--bg-card), var(--bg-inset));
      display: none;
      box-shadow: var(--shadow-soft);
    }

    .dashboard-prelayout.active {
      display: block;
    }

    .dashboard-prelayout-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .dashboard-prelayout-cube {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid var(--border-2);
      background: linear-gradient(145deg, rgba(125, 200, 112, .24), rgba(96, 165, 250, .12));
      animation: preCubeSpin 1.8s ease-in-out infinite;
      transform-style: preserve-3d;
    }

    .dashboard-prelayout-text {
      font-size: 11.5px;
      color: var(--text-3);
      font-weight: 600;
      letter-spacing: .02em;
    }

    .dashboard-prelayout-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .dashboard-prelayout-cell {
      height: 36px;
      border-radius: var(--r8);
      background: var(--bg-hover);
      animation: shimmer 1.4s ease-in-out infinite;
    }

    @keyframes preCubeSpin {
      0% {
        transform: rotateX(0deg) rotateY(0deg);
      }
      50% {
        transform: rotateX(180deg) rotateY(180deg);
      }
      100% {
        transform: rotateX(360deg) rotateY(360deg);
      }
    }

    /*  Enhanced profile avatar  */
    .av {
      position: relative;
      border-radius: var(--r8);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 11px;
      color: var(--text-1);
      background: var(--bg-inset);
      flex-shrink: 0;
      border: 2px solid var(--border-1);
      transition: border-color .2s, box-shadow .2s;
    }

    .av img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    .sb-user {
      border-radius: var(--r12);
      transition: background .15s, border-color .15s;
    }

    .sb-user:hover .av {
      border-color: var(--border-2);
      box-shadow: 0 0 0 3px var(--gbg, rgba(34, 197, 94, .08));
    }

    /* Status dot on avatar */
    .av-wrap {
      position: relative;
      display: inline-flex;
      flex-shrink: 0;
    }

    .av-online {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--green);
      border: 2px solid var(--bg-sidebar, var(--bg-page));
      z-index: 2;
    }

    /* """""""""""""""""""""""""""""""""""""""""""""""""""
   UNIVERSAL SIDEBAR  retractable on ALL screen sizes
""""""""""""""""""""""""""""""""""""""""""""""""""" */

    /* Backdrop for mobile/tablet overlay */
    .sb-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 199;
      opacity: 0;
      transition: opacity .3s ease;
      pointer-events: none;
    }

    .sb-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    /*  Sidebar base  */
    .sidebar {
      transition: width .3s cubic-bezier(.25, .46, .45, .94),
        transform .3s cubic-bezier(.25, .46, .45, .94),
        padding .3s ease,
        background .2s, border-color .2s;
      will-change: transform;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 100;
    }

    /*  Sidebar COLLAPSED on desktop  */
    body.sb-collapsed .sidebar {
      width: 58px !important;
      min-width: 58px !important;
      overflow: hidden;
    }

    body.sb-collapsed .sidebar .sb-uname,
    body.sb-collapsed .sidebar .sb-urole,
    body.sb-collapsed .sidebar .nav-sec,
    body.sb-collapsed .sidebar .logo-name {
      opacity: 0;
      width: 0;
      overflow: hidden;
      white-space: nowrap;
      transition: opacity .2s, width .2s;
    }

    body.sb-collapsed .sidebar .logo-name {
      display: none;
    }

    body.sb-collapsed .sidebar .ni span,
    body.sb-collapsed .sidebar .ni em {
      opacity: 0;
      width: 0;
      overflow: hidden;
      white-space: nowrap;
    }

    body.sb-collapsed .sidebar .ni {
      justify-content: center;
      padding: 10px 0;
    }

    body.sb-collapsed .sidebar .ni svg {
      margin: 0;
    }

    body.sb-collapsed .sidebar .avail-label,
    body.sb-collapsed .sidebar .avail-toggle-label {
      display: none;
    }

    body.sb-collapsed .sidebar .sb-user {
      justify-content: center;
      padding: 8px 0;
    }

    body.sb-collapsed .sidebar .sb-user .av-wrap,
    body.sb-collapsed .sidebar .sb-user>div:last-child {
      /* hide text column, keep avatar */
    }

    body.sb-collapsed .sidebar .sb-user>div:last-child {
      display: none;
    }

    body.sb-collapsed .sidebar .logo {
      justify-content: center;
      padding: 3px 0;
    }

    /*  Toggle button (always visible in topbar)  */
    .sb-toggle {
      width: 34px;
      height: 34px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-1, var(--bd1));
      border-radius: 8px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background .15s, border-color .15s;
      padding: 0;
    }

    .sb-toggle:hover {
      background: var(--bg-inset, var(--b3));
      border-color: var(--border-2, var(--bd2));
    }

    .sb-toggle-bar {
      width: 14px;
      height: 1.5px;
      background: var(--text-2, var(--s2));
      border-radius: 2px;
      transition: transform .25s, opacity .25s, width .25s;
      flex-shrink: 0;
    }

    /* Animate to X when open on mobile */
    .sb-toggle.is-open .sb-toggle-bar:nth-child(1) {
      transform: translateY(5.5px) rotate(45deg);
    }

    .sb-toggle.is-open .sb-toggle-bar:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }

    .sb-toggle.is-open .sb-toggle-bar:nth-child(3) {
      transform: translateY(-5.5px) rotate(-45deg);
    }

    /*  MOBILE (0900px)  full overlay slide-in  */
    @media(max-width:900px) {
      body {
        height: auto;
        min-height: 100vh;
        overflow-y: auto;
      }

      .sidebar {
        position: fixed !important;
        left: 0;
        top: 0;
        height: 100vh !important;
        width: 230px !important;
        min-width: 230px !important;
        transform: translateX(-100%);
        z-index: 200;
        box-shadow: 6px 0 40px rgba(0, 0, 0, .25);
      }

      .sidebar.mob-open {
        transform: translateX(0) !important;
      }

      .sb-backdrop {
        display: block;
      }

      .main {
        width: 100% !important;
        min-height: 100vh;
      }

      .page,
      .content {
        padding: 14px 14px !important;
        scrollbar-gutter: auto;
      }

      .topbar {
        padding: 11px 16px !important;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-start;
      }

      .tb-right {
        width: 100%;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      .g4,
      .g2l,
      .g2,
      .g2b {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }

      /* Collapse classes don't apply on mobile */
      body.sb-collapsed .sidebar {
        width: 230px !important;
        min-width: 230px !important;
      }

      body.sb-collapsed .sidebar .sb-uname,
      body.sb-collapsed .sidebar .sb-urole,
      body.sb-collapsed .sidebar .nav-sec,
      body.sb-collapsed .sidebar .logo-name,
      body.sb-collapsed .sidebar .ni span,
      body.sb-collapsed .sidebar .ni em {
        opacity: 1;
        width: auto;
      }

      body.sb-collapsed .sidebar .logo-name {
        display: block;
      }

      body.sb-collapsed .sidebar .ni {
        justify-content: flex-start;
        padding: 10px 9px;
      }

      body.sb-collapsed .sidebar .ni svg {
        margin: 0;
      }

      body.sb-collapsed .sidebar .sb-user {
        justify-content: flex-start;
        padding: 8px 9px;
      }

      body.sb-collapsed .sidebar .sb-user>div:last-child {
        display: block;
      }

      body.sb-collapsed .sidebar .logo {
        justify-content: flex-start;
        padding: 3px 6px;
      }

      /* Stat grids */
      .stats-row,
      .sc-row,
      .sc-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }

      .cards-grid,
      .feat-grid,
      .dp-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }

      .tbl-wrap,
      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tbl,
      .data-table {
        min-width: 580px;
      }

      .msg-filter-row {
        flex-direction: column;
      }

      .detail-list {
        grid-template-columns: 1fr;
      }

      #msg-role-filter {
        width: 100% !important;
      }

      #chat-compose,
      #chat-input-area {
        flex-direction: column;
      }

      #chat-send-btn {
        width: 100%;
      }

      .support-fab-client {
        right: 14px;
        bottom: 14px;
      }
    }

    /*  Small phone 0500px  */
    @media(max-width:500px) {

      .stats-row,
      .sc-row,
      .sc-grid {
        grid-template-columns: 1fr !important;
      }

      .cards-grid,
      .feat-grid,
      .dp-grid {
        grid-template-columns: 1fr !important;
      }

      .action-grid {
        grid-template-columns: 1fr !important;
      }

      .modal-card {
        padding: 14px;
      }

      .page,
      .content {
        padding: 10px 10px !important;
      }

      .tb-right {
        justify-content: stretch;
      }

      .tb-right .btn {
        flex: 1 1 calc(50% - 6px);
      }
    }

    .onboard-guide {
      border: 1px solid var(--border-2);
      background: linear-gradient(140deg, var(--bg-card), var(--bg-inset));
      border-radius: var(--r16);
      padding: 14px;
      margin-bottom: 12px;
      animation: fadeLift .35s ease both;
    }

    .onboard-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-1);
      margin-bottom: 6px;
    }

    .onboard-steps {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin: 10px 0 14px;
    }

    .onboard-step {
      border: 1px solid var(--border-1);
      border-radius: var(--r10);
      padding: 8px;
      background: var(--bg-page);
    }

    .onboard-step strong {
      display: block;
      font-size: 11px;
      color: var(--text-1);
      margin-bottom: 2px;
    }

    .onboard-step span {
      font-size: 10.5px;
      color: var(--text-4);
    }

    .onboard-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .avatar-presets {
      display: grid;
      grid-template-columns: repeat(8, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .avatar-preset {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--border-2);
      background: var(--bg-inset);
      cursor: pointer;
      overflow: hidden;
      padding: 0;
      transition: transform .15s ease, border-color .15s ease;
    }

    .avatar-preset:hover {
      transform: translateY(-1px);
      border-color: var(--text-3);
    }

    .avatar-preset img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    @media(max-width:900px) {
      .onboard-steps {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .avatar-presets {
        grid-template-columns: repeat(6, minmax(0, 1fr));
      }
    }

    @media(max-width:500px) {
      .onboard-steps {
        grid-template-columns: 1fr;
      }

      .avatar-presets {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }
  </style>

</head>

<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 3 4 7.5v9L12 21l8-4.5v-9z" />
          <path d="M12 21v-9" />
          <path d="m4 7.5 8 4.5 8-4.5" />
        </svg>
      </div>
      <div class="logo-name">
        <span class="brand-cursor">CODESTUDIO.KENYA</span>
        <span class="brand-roll" aria-hidden="true">
          <span>Websites</span>
          <span>Apps</span>
          <span>CRM</span>
          <span>ERP</span>
          <span>Customs</span>
        </span>
      </div>
    </div>
    <div class="sb-user" onclick="showPage('profile')">
      <div class="av-wrap">
        <div class="av av-lg" id="sb-av"><img id="sb-av-img"
            src="" alt=""
            onerror="this.style.display='none'"><span id="sb-initials">U</span></div>
        <div class="av-online"></div>
      </div>
      <div>
        <div class="sb-uname" id="sb-name">Client User</div>
        <div class="sb-urole">Client</div>
      </div>
    </div>
    <!-- NAV -->
    <div class="nav-sec">Overview</div><a class="ni active" data-page="dashboard" onclick="showPage('dashboard')"><svg
        viewBox="0 0 24 24">
        <rect x="3" y="3" width="7" height="7" rx="1" />
        <rect x="14" y="3" width="7" height="7" rx="1" />
        <rect x="3" y="14" width="7" height="7" rx="1" />
        <rect x="14" y="14" width="7" height="7" rx="1" />
      </svg>Dashboard </a><a class="ni" data-page="projects" onclick="showPage('projects')"><svg viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
      </svg>My Projects <span class="nc" id="nav-proj-count">0</span></a><a class="ni" data-page="escrow"
      onclick="showPage('escrow')"><svg viewBox="0 0 24 24">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
      </svg>Escrow Funds </a>
    <div class="nav-sec">Communicate</div><a class="ni" data-page="messages" onclick="showPage('messages')"><svg
        viewBox="0 0 24 24">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
      </svg>Messages <span class="nc" id="nav-msg-count">0</span></a><a class="ni" data-page="notifications"
      onclick="showPage('notifications')"><svg viewBox="0 0 24 24">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
      </svg>Notifications <span class="nc" id="nav-notif-count">0</span></a>
    <div class="nav-sec">Account</div><a class="ni" data-page="billing" onclick="showPage('billing')"><svg
        viewBox="0 0 24 24">
        <rect x="2" y="5" width="20" height="14" rx="2" />
        <line x1="2" y1="10" x2="22" y2="10" />
      </svg>Billing </a><a class="ni" data-page="profile" onclick="showPage('profile')"><svg viewBox="0 0 24 24">
        <circle cx="12" cy="8" r="4" />
        <path d="M6 20v-2a6 6 0 0 1 12 0v2" />
      </svg>Profile Settings </a>
    <div class="sb-foot">
      <div class="surface-pill">
        <div class="surface-row">
          <button class="surface-opt" id="surface-opt-glass" onclick="setSurfaceTheme('glass')">Glass Reflection</button>
        </div>
      </div>
      <!-- Theme toggle -->
      <div class="theme-pill" onclick="toggleTheme()"><span class="theme-pill-lbl" id="theme-lbl">Dark
          Mode</span>
        <div class="theme-switch" id="theme-sw"></div>
      </div><button class="so-btn" onclick="signOut()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="1.8" width="14" height="14">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" y1="12" x2="9" y2="12" />
        </svg>Sign Out </button>
    </div>
  </aside>
  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="pg-title" id="topbar-title">Client Dashboard</div>
        <div class="pg-sub" id="topbar-sub">Live project summary</div>
      </div>
      <div class="tb-right">
        <div class="db-status" id="db-status">
          <div class="db-dot"></div><span id="db-status-text">Connecting</span>
        </div><button class="btn btn-g" onclick="showPage('projects')">View Projects</button><button class="btn btn-w"
          onclick="jumpToEscrowTeam()">Escrow & Team</button><button class="btn btn-w"
          onclick="showModal('new-project')"><svg width="11" height="11" fill="none" stroke="currentColor"
            stroke-width="2.5" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>New Project </button>
      </div>
    </div>
    <!-- """ PAGE: DASHBOARD """ -->
    <div id="page-dashboard" class="page active">
      <div id="dashboard-prelayout" class="dashboard-prelayout active">
        <div class="dashboard-prelayout-head">
          <div class="dashboard-prelayout-cube" aria-hidden="true"></div>
          <div class="dashboard-prelayout-text">Loading dashboard data... (check your internet)</div>
        </div>
        <div class="dashboard-prelayout-grid">
          <div class="dashboard-prelayout-cell"></div>
          <div class="dashboard-prelayout-cell"></div>
          <div class="dashboard-prelayout-cell"></div>
        </div>
      </div>
      <div class="sl fu d1">Overview</div>
      <div class="onboard-guide" id="client-onboard-guide" style="display:none;">
        <div class="onboard-title">Quick Start Guide</div>
        <div style="font-size:11px;color:var(--text-4);">Use this flow for your first project. You can skip this anytime.</div>
        <div class="onboard-steps">
          <div class="onboard-step"><strong>1. Update Profile</strong><span>Add your business + contact details.</span></div>
          <div class="onboard-step"><strong>2. Create Project</strong><span>Add scope, budget, and expected timeline.</span></div>
          <div class="onboard-step"><strong>3. Fund Escrow</strong><span>Top up or pay invoice via Paystack.</span></div>
          <div class="onboard-step"><strong>4. Track & Approve</strong><span>Review milestones and release payments.</span></div>
        </div>
        <div id="client-sales-assignment-note" style="display:none;margin-top:8px;padding:9px 10px;border:1px solid var(--gbdr);background:var(--gbg);border-radius:var(--r8);font-size:11px;color:var(--text-2);"></div>
        <div class="onboard-actions">
          <button class="btn btn-g btn-sm" onclick="skipClientGuide()">Skip</button>
          <button class="btn btn-w btn-sm" onclick="openClientGuideProject()">Create First Project</button>
        </div>
      </div>
      <div class="g4 fu d1">
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 6H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H7"/></svg></div>
          <div class="sc-val" id="s-escrow">KSh 0</div>
          <div class="sc-lbl">Total Escrow Value</div>
          <div class="sc-d neu">Awaiting live data</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
          <div class="sc-val" id="s-proj">0</div>
          <div class="sc-lbl">Active Projects</div>
          <div class="sc-d neu">Awaiting live data</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="sc-val" id="s-ms">0/0</div>
          <div class="sc-lbl">Milestones Done</div>
          <div class="sc-d neu">Awaiting live data</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
          <div class="sc-val" id="s-msg">0</div>
          <div class="sc-lbl">Unread Messages</div>
          <div class="sc-d neu">Awaiting live data</div>
        </div>
      </div>
      <div class="sl fu d2">Active Projects</div>
      <div class="g2l fu d2">
        <div class="card">
          <div class="card-head">
            <div class="card-title">My Projects</div><span class="card-lnk" onclick="showPage('projects')">View
              All</span>
          </div>
          <div id="dash-projects">
            <div class="loading-text">Loading projects</div>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">Milestone Tracker</div><span class="badge b-a">Live</span>
          </div>
          <div id="dash-milestones">
            <div class="loading-text" style="padding:20px; text-align:center; color:var(--text-5);">No milestones yet. Milestone activity will appear here.</div>
          </div>
        </div>
      </div>
      <div class="sl fu d3" id="escrow-team-anchor">Escrow & Team</div>
      <div class="g2 fu d3">
        <div class="card">
          <div class="card-head">
            <div class="card-title">Escrow Breakdown</div><span class="card-lnk" onclick="showPage('escrow')">Full
              History</span>
          </div>
          <div class="ring-wrap">
            <div class="ring-chart"><svg width="100" height="100" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="38" fill="none" stroke="var(--bg-hover)" stroke-width="10" />
                <circle id="escrow-ring-released" cx="50" cy="50" r="38" fill="none" stroke="var(--green)" stroke-width="10"
                  stroke-dasharray="0 239" stroke-linecap="round" />
                <circle id="escrow-ring-held" cx="50" cy="50" r="38" fill="none" stroke="var(--text-1)" stroke-width="10"
                  stroke-dasharray="0 239" stroke-dashoffset="0" stroke-linecap="round" />
                <circle id="escrow-ring-pending" cx="50" cy="50" r="38" fill="none" stroke="var(--amber)" stroke-width="10"
                  stroke-dasharray="0 239" stroke-dashoffset="0" stroke-linecap="round" />
              </svg>
              <div class="ring-center">
                <div class="ring-val" id="escrow-ring-total">KSh 0</div>
                <div class="ring-lbl">Total</div>
              </div>
            </div>
            <div class="legend">
              <div class="leg">
                <div class="leg-dot" style="background:var(--green)"></div>
                <div class="leg-lbl">Released</div>
                <div class="leg-val" id="escrow-legend-released">KSh 0</div>
              </div>
              <div class="leg">
                <div class="leg-dot" style="background:var(--text-1)"></div>
                <div class="leg-lbl">In Escrow</div>
                <div class="leg-val" id="escrow-legend-held">KSh 0</div>
              </div>
              <div class="leg">
                <div class="leg-dot" style="background:var(--amber)"></div>
                <div class="leg-lbl">Pending</div>
                <div class="leg-val" id="escrow-legend-pending">KSh 0</div>
              </div>
            </div>
          </div>
          <div class="div"></div>
          <div class="loading-text" id="escrow-activity-note" style="padding:14px;text-align:center;color:var(--text-5);">No escrow activity yet.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="card">
            <div class="card-head">
              <div class="card-title">Messages</div><span class="card-lnk" onclick="showPage('messages')">Open All
                </span>
            </div>
            <div id="dash-messages">
              <div class="loading-text">Loading</div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">My Developers</div>
            </div>
            <div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">Assigned developers will appear here.</div>
          </div>
          <div class="card">
            <div class="card-head" style="margin-bottom:9px">
              <div class="card-title">Quick Actions</div>
            </div>
            <div class="g2b"><button class="qa" onclick="showPage('escrow')">
                <div class="qa-ico"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
                <div class="qa-lbl">Approve</div>
                <div class="qa-desc">Release milestone</div>
              </button><button class="qa" onclick="showPage('messages')">
                <div class="qa-ico"><svg viewBox="0 0 24 24"><path d="M10.3 3.9 1.8 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.9a2 2 0 0 0-3.4 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                <div class="qa-lbl">Dispute</div>
                <div class="qa-desc">Flag an issue</div>
              </button><button class="qa" onclick="showPage('escrow')">
                <div class="qa-ico"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
                <div class="qa-lbl">Invoice</div>
                <div class="qa-desc">Download PDF</div>
              </button><button class="qa" onclick="showPage('projects')">
                <div class="qa-ico"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
                <div class="qa-lbl">Review</div>
                <div class="qa-desc">Rate developer</div>
              </button></div>
          </div>
        </div>
      </div>
    </div>
    <!-- """ PAGE: MY PROJECTS """ -->
    <div id="page-projects" class="page">
      <div class="sl">All My Projects</div>
      <div class="card fu d1">
        <div class="card-head">
          <div class="card-title">Active & Historical Projects</div><button class="btn btn-w btn-sm"
            onclick="showModal('new-project')">+New Project</button>
        </div>
        <table class="tbl">
          <thead>
            <tr>
              <th>Project</th>
              <th>Developer</th>
              <th>Value</th>
              <th>Progress</th>
              <th>Due</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="projects-table-body">
            <tr>
              <td colspan="6" class="loading-text">Loading projects</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- """ PAGE: ESCROW FUNDS """ -->
    <div id="page-escrow" class="page">
      <div class="sl">Escrow Funds</div>
      <div class="g4 fu d1">
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 6H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H7"/></svg></div>
          <div class="sc-val" id="escrow-held-val">KSh 0</div>
          <div class="sc-lbl">Currently Held</div>
          <div class="sc-d neu" id="escrow-held-sub">Across 0 projects</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="sc-val" id="escrow-released-val">KSh 0</div>
          <div class="sc-lbl">Released</div>
          <div class="sc-d up" id="escrow-released-sub">0 paid invoices</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><path d="M10.3 3.9 1.8 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.9a2 2 0 0 0-3.4 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
          <div class="sc-val" id="escrow-pending-val">KSh 0</div>
          <div class="sc-lbl">Pending Release</div>
          <div class="sc-d neu" id="escrow-pending-sub">Awaiting approval</div>
        </div>
        <div class="sc">
          <div class="sc-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
          <div class="sc-val" id="escrow-total-val">KSh 0</div>
          <div class="sc-lbl">Total Committed</div>
          <div class="sc-d neu" id="escrow-total-sub">All-time</div>
        </div>
      </div>
      <div class="card fu d2">
        <div class="card-head">
          <div class="card-title">Invoices & Payments</div>
        </div>
        <table class="tbl">
          <thead>
            <tr>
              <th>Invoice</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="invoices-table-body">
            <tr>
              <td colspan="5" class="loading-text">Loading invoices</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- """ PAGE: MESSAGES """ -->
    <div id="page-messages" class="page">
      <div class="sl">Messages</div>
      <div class="g2l fu d1">
        <div class="card">
          <div class="card-head">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
              <div class="card-title">Conversations</div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <button class="btn btn-live btn-xs" onclick="openClientSupportModal()">Live Support</button>
                <button class="btn btn-g btn-xs" onclick="focusClientMessageComposer()">New Message</button>
              </div>
            </div>
            <div class="msg-filter-row">
              <input id="msg-search" class="input" placeholder="Search name, role, project" oninput="window.loadClientMessageThreads&&window.loadClientMessageThreads()" style="flex:1;height:32px;">
              <select id="msg-role-filter" class="input" onchange="window.loadClientMessageThreads&&window.loadClientMessageThreads()" style="width:138px;height:32px;">
                <option value="all">All</option>
                <option value="client">Clients</option>
                <option value="developer">Developers</option>
                <option value="commissioner">Commissioners</option>
                <option value="unread">Unread</option>
              </select>
            </div>
          </div>
          <div id="messages-list">
            <div class="loading-text">Loading messages</div>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title" id="chat-header-title">Select a conversation</div>
            <div id="chat-header-meta" style="margin-top:4px;font-size:11px;color:var(--text-5);">Role: - | Project: -</div>
          </div>
          <div id="chat-thread-pane"
            style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--text-5);font-size:13px;">
            Click a message to open it</div>
          <div id="chat-compose" style="margin-top:12px;display:flex;gap:8px;border-top:1px solid var(--border-1);padding-top:12px;">
            <input id="chat-input" class="input" placeholder="Type a message" disabled
              onkeydown="if(event.key==='Enter')sendClientMessage()">
            <button id="chat-send-btn" class="btn btn-w" onclick="sendClientMessage()" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>
    <!-- """ PAGE: NOTIFICATIONS """ -->
    <div id="page-notifications" class="page">
      <div class="sl">Notifications</div>
      <div class="card fu d1">
          <div class="card-head">
            <div class="card-title">All Notifications</div><button id="mark-all-notifications-btn" class="btn btn-g btn-sm" onclick="markAllNotificationsRead()">Mark All
              Read</button>
          </div>
        <div id="notifications-list">
          <div class="loading-text" style="padding:20px;text-align:center;color:var(--text-5);">No notifications yet.</div>
        </div>
      </div>
    </div>
    <!-- """ PAGE: BILLING """ -->
    <div id="page-billing" class="page">
      <div class="sl">Billing & Payments</div>
      <div class="g2 fu d1">
        <div class="card">
          <div class="card-head">
            <div class="card-title">Current Plan</div>
          </div>
          <div class="plan-card">
            <div class="plan-name">Client  Standard</div>
            <div class="plan-price">KSh 0<span style="font-size:13px;font-weight:400;color:var(--text-5)">one-time onboarding</span>
            </div>
            <div class="plan-sub">2.5% escrow fee per transaction</div>
          </div>
          <div style="font-size:11px;color:var(--text-5);margin-bottom:12px;">Escrow fees are calculated from live invoice activity.</div>
          <button class="btn btn-g" style="width:100%">Upgrade to Pro  1.5% fee</button>
          <button id="topup-wallet-btn" class="btn btn-w" style="width:100%;margin-top:8px;" onclick="toggleTopupForm()">
            Top Up Wallet (Paystack/M-Pesa)
          </button>
          <div id="topup-form" class="action-form hidden">
            <div class="action-grid">
              <div>
                <label class="input-lbl" for="topup-amount-input">Amount (KES)</label>
                <input class="input" id="topup-amount-input" type="number" min="1" step="1" placeholder="1000">
              </div>
              <div>
                <label class="input-lbl" for="topup-provider-input">Provider</label>
                <select class="select" id="topup-provider-input">
                  <option value="mpesa">M-Pesa</option>
                  <option value="paystack">Paystack</option>
                  <option value="bank">Bank</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div style="margin-bottom:10px;">
              <label class="input-lbl" for="topup-phone-input">Phone / Reference</label>
              <input class="input" id="topup-phone-input" type="text" placeholder="07XXXXXXXX or reference">
            </div>
            <div class="action-row">
              <button id="topup-submit-btn" class="btn btn-w" type="button" onclick="topUpWallet()">Submit Top-up</button>
              <button class="btn btn-g" type="button" onclick="toggleTopupForm(false)">Cancel</button>
            </div>
          </div>
          <div id="latest-topup-note" style="font-size:11px;color:var(--text-5);margin-top:10px;display:none;"></div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">Payment Method</div><span class="card-lnk" onclick="togglePaymentMethodForm(true)">Edit -></span>
          </div>
          <div id="payment-method-summary"
            style="background:var(--bg-inset);border:1px solid var(--border-1);border-radius:var(--r12);padding:14px;display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <div style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;color:var(--text-3);">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                <line x1="2" y1="10" x2="22" y2="10"></line>
              </svg>
            </div>
            <div>
              <div id="billing-method-title" style="font-size:13px;font-weight:600;color:var(--text-1)">No payment method added</div>
              <div id="billing-method-sub" style="font-size:11px;color:var(--text-5)">Use Add Payment Method to connect Paystack or M-Pesa</div>
            </div><span id="billing-method-badge" class="badge b-a" style="margin-left:auto">None</span>
          </div>
          <button id="add-payment-method-btn" class="btn btn-g" style="width:100%" onclick="togglePaymentMethodForm()">+Add Payment Method</button>
          <div id="payment-method-form" class="action-form hidden">
            <div class="action-grid">
              <div>
                <label class="input-lbl" for="pm-provider-input">Provider</label>
                <select class="select" id="pm-provider-input">
                  <option value="mpesa">M-Pesa</option>
                  <option value="paystack">Paystack</option>
                  <option value="card">Card</option>
                  <option value="bank">Bank</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="input-lbl" for="pm-label-input">Label</label>
                <input class="input" id="pm-label-input" type="text" placeholder="Safaricom M-Pesa">
              </div>
            </div>
            <div style="margin-bottom:10px;">
              <label class="input-lbl" for="pm-ref-input">Phone / Account Reference</label>
              <input class="input" id="pm-ref-input" type="text" placeholder="07XXXXXXXX / account ref">
            </div>
            <div class="action-row">
              <button id="pm-save-btn" class="btn btn-w" type="button" onclick="addPaymentMethod()">Save Method</button>
              <button class="btn btn-g" type="button" onclick="togglePaymentMethodForm(false)">Cancel</button>
            </div>
          </div>
          <div class="div"></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-size:12px;color:var(--text-2);font-weight:700;letter-spacing:.02em;">Invoice Snapshot</div>
              <button class="btn btn-g btn-sm" onclick="showPage('escrow')">Open Invoices</button>
            </div>
            <div id="billing-invoice-stats" style="font-size:11px;color:var(--text-5);">Loading invoice summary...</div>
            <div id="billing-invoice-list" style="display:flex;flex-direction:column;gap:8px;">
              <div class="loading-text" style="padding:12px;text-align:center;color:var(--text-5);">No invoices yet.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- """ PAGE: PROFILE """ -->
    <div id="page-profile" class="page">
      <div class="sl">Profile Settings</div>
      <div class="g2l fu d1">
        <div class="card">
          <div class="card-head">
            <div class="card-title">Personal Information</div>
          </div>
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
            <div style="position:relative;cursor:pointer;" onclick="document.getElementById('av-upload').click()">
              <div class="av"
                style="width:60px;height:60px;font-size:20px;border-radius:var(--r12);border:1px solid var(--border-2);"
                id="profile-av"><img id="profile-av-img"
                  src="" alt=""
                  style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:var(--r12);"
                  onerror="this.style.display='none'"><span id="profile-initials">U</span></div>
              <div
                style="position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;background:var(--text-1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;">
                <svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="var(--bg-page)" stroke-width="2">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
              </div>
            </div><input type="file" id="av-upload" accept="image/*" style="display:none"
              onchange="handleAvatarUpload(event)">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--text-1)">Profile Photo</div>
              <div style="font-size:11px;color:var(--text-5);margin-top:2px">JPG,
                PNG or GIF  Max 5MB</div><button class="btn btn-g btn-sm" style="margin-top:7px"
                onclick="document.getElementById('av-upload').click()">Upload Photo</button>
            </div>
          </div>
          <div style="margin-bottom:12px;">
            <div style="font-size:11px;color:var(--text-4);margin-bottom:6px;">Or pick a character avatar</div>
            <div class="avatar-presets" id="avatar-preset-grid"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:14px;">
            <div style="flex:1;">
              <label class="input-lbl" for="avatar-url-input">Avatar URL</label>
              <input class="input" id="avatar-url-input" type="url" placeholder="https://...">
            </div>
            <button class="btn btn-g btn-sm" onclick="applyAvatarUrl()">Use URL</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
            <div><label class="input-lbl">First Name</label><input class="input" id="f-fname" value=""></div>
            <div><label class="input-lbl">Last Name</label><input class="input" id="f-lname" value=""></div>
          </div>
          <div style="margin-bottom:10px;"><label class="input-lbl">Email Address</label><input class="input"
              id="f-email" value="" type="email"></div>
          <div style="margin-bottom:10px;"><label class="input-lbl">Phone Number</label><input class="input"
              id="f-phone" value="" type="tel"></div>
          <div style="margin-bottom:18px;"><label class="input-lbl">Company / Business
              Name</label><input class="input" id="f-company" value="" type="text">
          </div><button class="btn btn-w" onclick="saveProfile()" style="width:100%">Save
            Changes</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="card">
            <div class="card-head">
              <div class="card-title">Account Security</div>
            </div>
            <div style="margin-bottom:10px;"><label class="input-lbl">Current Password</label><input class="input"
                id="sec-current-pass" type="password" placeholder=""></div>
            <div style="margin-bottom:10px;"><label class="input-lbl">New Password</label><input class="input"
                id="sec-new-pass" type="password" placeholder="New password"></div>
            <div style="margin-bottom:14px;"><label class="input-lbl">Confirm Password</label><input class="input"
                id="sec-confirm-pass" type="password" placeholder="Confirm new password"></div><button class="btn btn-g"
              style="width:100%" onclick="updateAccountSecurity()">Update Password</button>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Supabase Status</div>
            </div>
            <div id="profile-sb-status" style="font-size:12px;color:var(--text-5)">Checking
              connection</div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <div id="project-modal" class="modal-backdrop" onclick="if(event.target===this) closeClientProjectModal()">
    <div class="modal-card">
      <div class="modal-title">Create New Project</div>
      <div class="modal-sub">Send your project brief to the sales queue for assignment.</div>
      <div class="action-grid">
        <div style="grid-column:1 / -1;">
          <label class="input-lbl" for="new-project-title">Project Title</label>
          <input class="input" id="new-project-title" type="text" placeholder="e.g. Booking Platform">
        </div>
        <div style="grid-column:1 / -1;">
          <label class="input-lbl" for="new-project-description">Description</label>
          <textarea class="input" id="new-project-description" rows="4" placeholder="Describe scope, features, and goals"></textarea>
        </div>
        <div>
          <label class="input-lbl" for="new-project-budget">Budget (KES)</label>
          <input class="input" id="new-project-budget" type="number" min="0" step="1" placeholder="5000">
        </div>
        <div>
          <label class="input-lbl" for="new-project-status">Initial Status</label>
          <select class="select" id="new-project-status">
            <option value="open">Open</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div style="grid-column:1 / -1;">
          <label class="input-lbl" for="new-project-timeline">Timeline (optional)</label>
          <input class="input" id="new-project-timeline" type="text" placeholder="e.g. 6 weeks or 2 months">
        </div>
        <div style="grid-column:1 / -1;">
          <label class="input-lbl" for="new-project-phone">Phone Number</label>
          <input class="input" id="new-project-phone" type="tel" placeholder="e.g. 0793XXXXXX">
        </div>
      </div>
      <div class="action-row" style="justify-content:flex-end;">
        <button class="btn btn-g" type="button" onclick="closeClientProjectModal()">Cancel</button>
        <button id="new-project-submit-btn" class="btn btn-w" type="button" onclick="createProjectFromClient()">Create Project</button>
      </div>
    </div>
  </div>
  <div id="project-detail-modal" class="modal-backdrop" onclick="if(event.target===this) closeClientProjectDetailsModal()">
    <div class="modal-card">
      <div class="modal-title" id="project-detail-title">Project Details</div>
      <div class="modal-sub" id="project-detail-sub">Review status, team assignment, and payment actions.</div>
      <div id="project-detail-status-box" class="project-detail-status">
        <span>Payment status</span>
        <span class="badge b-a" id="project-detail-payment-status">pending</span>
      </div>
      <div id="project-detail-grid" class="detail-list"></div>
      <div id="project-detail-desc" style="margin-top:6px;padding:10px;border:1px solid var(--border-1);border-radius:var(--r10);background:var(--bg-inset);font-size:12px;color:var(--text-3);line-height:1.55;"></div>
      <div class="project-detail-actions">
        <button class="btn btn-w" type="button" onclick="payProjectNow()">Pay Now</button>
        <button class="btn btn-live" type="button" onclick="sendProjectInvoiceEmail()">Send Invoice Email</button>
        <button class="btn btn-g" type="button" onclick="verifyProjectPaymentStatus()">Verify Payment</button>
      </div>
      <div class="action-row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn btn-g" type="button" onclick="closeClientProjectDetailsModal()">Close</button>
      </div>
    </div>
  </div>
  <div id="client-support-modal" class="modal-backdrop" onclick="if(event.target===this) closeClientSupportModal()">
    <div class="modal-card">
      <div class="modal-title">Live Support to Admin</div>
      <div class="modal-sub">Send a direct support request to admin operations.</div>
      <div class="action-grid">
        <div>
          <label class="input-lbl" for="support-project-select">Project (optional)</label>
          <select class="select" id="support-project-select">
            <option value="">General Support</option>
          </select>
        </div>
        <div>
          <label class="input-lbl" for="support-topic">Topic</label>
          <input class="input" id="support-topic" type="text" placeholder="e.g. Payment confirmation">
        </div>
        <div style="grid-column:1 / -1;">
          <label class="input-lbl" for="support-message">Message</label>
          <textarea class="input" id="support-message" rows="4" placeholder="Describe your issue in detail"></textarea>
        </div>
      </div>
      <div class="action-row" style="justify-content:flex-end;">
        <button class="btn btn-g" type="button" onclick="closeClientSupportModal()">Cancel</button>
        <button class="btn btn-live" type="button" onclick="sendClientSupportMessage()">Send to Admin</button>
      </div>
    </div>
  </div>
  <button class="support-fab-client" onclick="openClientSupportOverlay()" aria-label="Live support">
    <svg viewBox="0 0 24 24">
      <path d="M21 15a2 2 0 0 1-2 2H8l-5 5V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </button>
  <div id="client-support-overlay" class="support-overlay" onclick="if(event.target===this) closeClientSupportOverlay()">
    <div class="support-panel">
      <h3>Live Support</h3>
      <p>Reach support directly on WhatsApp or email.</p>
      <div class="support-contact-row">
        <div class="support-contact-main">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M21 11.5a8.38 8.38 0 0 1-1.9 5.4A8.5 8.5 0 1 1 21 11.5z"></path>
            <polyline points="12 7 12 12 15 15"></polyline>
          </svg>
          <div class="support-main-stack">
            <span class="support-main-line">Message us on WhatsApp: 0793832286</span>
            <span class="support-fast-badge">Answers within 1 hour</span>
          </div>
        </div>
        <div class="support-contact-actions">
          <button class="support-wa-btn" onclick="openSupportWhatsApp()" title="Open WhatsApp">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M16.7 13.4c-.3-.2-1.7-.8-1.9-.9-.3-.1-.4-.2-.6.2-.2.3-.7.9-.8 1.1-.2.2-.3.2-.6.1a6.8 6.8 0 0 1-3.4-3c-.2-.3 0-.4.1-.6.1-.1.3-.3.4-.5.1-.2.2-.3.3-.5.1-.2 0-.4 0-.5 0-.1-.6-1.5-.8-2.1-.2-.5-.4-.4-.6-.4h-.5c-.2 0-.5.1-.8.4s-1 1-1 2.4 1 2.8 1.1 3c.1.2 2 3.1 4.8 4.3.7.3 1.2.5 1.6.6.7.2 1.4.2 1.9.1.6-.1 1.7-.7 1.9-1.4.2-.7.2-1.2.2-1.4-.1-.2-.3-.2-.6-.3z"></path>
              <path d="M20 12a8 8 0 0 1-11.8 7L4 20l1.1-4.1A8 8 0 1 1 20 12z"></path>
            </svg>
            <span>WhatsApp</span>
          </button>
        </div>
      </div>
      <div class="support-contact-row">
        <div class="support-contact-main">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <rect x="3" y="5" width="18" height="14" rx="2"></rect>
            <path d="m3 7 9 6 9-6"></path>
          </svg>
          <span id="client-support-email">creative.keagency254@gmail.com</span>
        </div>
        <div class="support-contact-actions">
          <a class="support-icon-btn" href="mailto:creative.keagency254@gmail.com?subject=Client%20Support%20Request&body=Hello%20CODESTUDIO.KENYA%20team%2C%20I%20need%20support%20with..." title="Open email">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M22 2 11 13"></path>
              <path d="M22 2 15 22l-4-9-9-4 20-7z"></path>
            </svg>
          </a>
          <button class="support-icon-btn" onclick="copyClientSupportEmail()" title="Copy email">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <rect x="9" y="9" width="13" height="13" rx="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- """""""""""""""""""""""""""""""""""""""""""""" SUPABASE+APP LOGIC
        """""""""""""""""""""""""""""""""""""""""""""" -->
  <script type="module">
    let CURRENT_USER = null;
    let ACTIVE_CHAT_USER = null;
    let CLIENT_CHAT_CHANNEL = null;
    let CLIENT_MESSAGES_CHANNEL = null;
    let CLIENT_INVOICES_CHANNEL = null;
    let CLIENT_TOPUPS_CHANNEL = null;
    let CLIENT_NOTIFICATIONS_CHANNEL = null;
    let CLIENT_FINANCE_RT_TIMER = null;
    let CLIENT_MESSAGES_RT_TIMER = null;
    let CLIENT_THREAD_CACHE = [];
    let CLIENT_CONTACTS = [];
    let CLIENT_INVOICES_CACHE = [];
    let CLIENT_PROJECTS_CACHE = [];
    let ACTIVE_PROJECT_DETAIL_ID = null;
    const CLIENT_GUIDE_KEY = 'code-studio-client-guide-dismissed';
    const CLIENT_ONBOARD_CTX_KEY = 'code-studio-client-onboard';
    const AVATAR_PRESET_URLS = [
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Amani',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Kendi',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Zuri',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Kito',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Nyota',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Baraka',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Imani',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Jabari',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Tamu',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Khalid',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Zawadi',
      'https://api.dicebear.com/9.x/adventurer/svg?seed=Rafiki',
    ];

    function isUuidLike(value) {
      return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(value || '').trim());
    }

    function getSalesOnboardContext() {
      try {
        const raw = localStorage.getItem(CLIENT_ONBOARD_CTX_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        const salesId = String(parsed.salesId || parsed.sid || '').trim();
        if (!isUuidLike(salesId)) return null;
        return {
          salesId,
          salesName: String(parsed.salesName || parsed.sname || '').trim(),
          salesEmail: String(parsed.salesEmail || parsed.semail || '').trim(),
        };
      } catch (_) {
        return null;
      }
    }

    function renderSalesAssignmentNote() {
      const note = document.getElementById('client-sales-assignment-note');
      if (!note) return;
      const ctx = getSalesOnboardContext();
      if (!ctx) {
        note.style.display = 'none';
        note.textContent = '';
        return;
      }
      const display = ctx.salesName || ctx.salesEmail || 'your sales advisor';
      note.style.display = 'block';
      note.textContent = `Assigned sales advisor: ${display}. New projects you create will be routed to this advisor automatically.`;
    }

    function getLocalPaymentMethod() {
      if (!CURRENT_USER?.id) return null;
      try {
        const raw = localStorage.getItem(`client-payment-method:${CURRENT_USER.id}`);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        return parsed;
      } catch (_) {
        return null;
      }
    }

    function setLocalPaymentMethod(method) {
      if (!CURRENT_USER?.id) return;
      try {
        localStorage.setItem(`client-payment-method:${CURRENT_USER.id}`, JSON.stringify(method || {}));
      } catch (_) {
        // ignore local storage failures
      }
    }

    function getOAuthAvatarUrl(user) {
      return user?.user_metadata?.avatar_url || user?.user_metadata?.picture || '';
    }

    function applyClientAvatar(avatarUrl) {
      if (!avatarUrl) return;
      ['profile-av-img', 'sb-av-img'].forEach(id => {
        const img = document.getElementById(id);
        if (img) {
          img.src = avatarUrl;
          img.style.display = 'block';
        }
      });
      ['profile-initials', 'sb-initials'].forEach(id => {
        const initials = document.getElementById(id);
        if (initials) initials.style.display = 'none';
      });
      const avatarUrlInput = document.getElementById('avatar-url-input');
      if (avatarUrlInput) avatarUrlInput.value = avatarUrl;
    }

    function renderAvatarPresets() {
      const host = document.getElementById('avatar-preset-grid');
      if (!host) return;
      host.innerHTML = AVATAR_PRESET_URLS.map(url => (
        `<button type="button" class="avatar-preset" onclick="selectAvatarPreset('${url}')"><img src="${url}" alt="avatar preset"></button>`
      )).join('');
    }

    async function persistAvatarUrl(avatarUrl) {
      if (!window.sbClient || !CURRENT_USER || !avatarUrl) return false;
      const { error } = await safeProfileUpdate(
        { avatar_url: avatarUrl },
        [{ avatar_url: avatarUrl, phone: null }, { avatar_url: avatarUrl, company: null }]
      );
      if (error) {
        if (isProfilePolicyRecursionError(error)) {
          // Keep UX functional even if the DB policy is temporarily broken.
          try {
            localStorage.setItem(`client-avatar:${CURRENT_USER.id}`, avatarUrl);
          } catch (_) { }
          applyClientAvatar(avatarUrl);
          toast('Avatar applied locally. Profile policy needs backend fix to sync permanently.');
          return true;
        }
        toast(`Unable to save avatar: ${clientErrorMessage(error, 'Profile update failed')}`);
        return false;
      }
      applyClientAvatar(avatarUrl);
      try { localStorage.removeItem(`client-avatar:${CURRENT_USER.id}`); } catch (_) { }
      return true;
    }

    function setDbStatus(state = 'connecting', detail = '') {
      const dot = document.querySelector('#db-status .db-dot');
      const text = document.getElementById('db-status-text');
      const profileStatus = document.getElementById('profile-sb-status');
      const normalized = String(state || '').toLowerCase();
      const isError = normalized === 'error';
      const isConnected = normalized === 'connected';
      if (dot) {
        dot.style.background = isError ? 'var(--red)' : (isConnected ? 'var(--green)' : 'var(--amber)');
        dot.style.boxShadow = isError ? '0 0 0 4px var(--rbg)' : (isConnected ? '0 0 0 4px var(--gbg)' : '0 0 0 4px var(--abg)');
      }
      if (text) {
        text.textContent = isError ? 'Connection issue' : (isConnected ? 'Connected' : 'Connecting');
      }
      if (profileStatus) {
        profileStatus.textContent = detail || (isError ? 'Connection issue detected' : (isConnected ? 'Connected to Supabase' : 'Connecting to Supabase'));
      }
    }

    async function initSupabase() {
      try {
        if (!window.sbClient) {
          console.warn("Supabase client not found. Retrying...");
          setDbStatus('connecting', 'Waiting for Supabase client...');
          setTimeout(initSupabase, 500);
          return;
        }
        setDbStatus('connecting', 'Authenticating session...');
        setClientDashboardLoadingState(true, 'Loading dashboard data... (check your internet)');

        const { data: { user }, error: authErr } = await window.sbClient.auth.getUser();
        if (authErr || !user) {
          if (window._L) _L.warn("No active Supabase session.");
          setDbStatus('error', 'No active session. Please sign in again.');
          return;
        }

        CURRENT_USER = user;
        const oauthAvatarUrl = getOAuthAvatarUrl(user);

      if (typeof window.ensureUserProfile === 'function') {
        try {
          await window.ensureUserProfile({ user });
        } catch (profileSyncErr) {
          if (window._L) _L.warn('ensureUserProfile failed in client init:', profileSyncErr);
        }
      }

        // Load Profile
        const { data: profile, error: profileErr } = await window.sbClient.from('profiles').select('*').eq('id', user.id).maybeSingle();
        if (profileErr && window._L) _L.warn('Profile lookup warning:', profileErr);
        if (profile) {
        const fname = profile.first_name || '';
        const lname = profile.last_name || '';
        const authName = String(user.user_metadata?.full_name || user.user_metadata?.name || '').trim();
        const fullName = `${fname} ${lname}`.trim() || authName || user.email;
        document.getElementById('sb-name').textContent = fullName;

        const titleEl = document.getElementById('topbar-title');
        if (titleEl) {
          titleEl.textContent = `Welcome back, ${fname || 'Client'}`;
        }

        const nameForInitials = `${fname} ${lname}`.trim() || authName;
        if (nameForInitials) {
          const initials = nameForInitials
            .split(/\s+/)
            .filter(Boolean)
            .slice(0, 2)
            .map(part => part[0] || '')
            .join('')
            .toUpperCase();
          document.getElementById('sb-initials').textContent = initials || 'U';
          const profileInitials = document.getElementById('profile-initials');
          if (profileInitials) profileInitials.textContent = initials || 'U';
        }

        const localAvatar = (() => {
          try { return localStorage.getItem(`client-avatar:${user.id}`) || ''; } catch (_) { return ''; }
        })();
        const resolvedAvatarUrl = profile.avatar_url || oauthAvatarUrl || localAvatar;
        if (resolvedAvatarUrl) applyClientAvatar(resolvedAvatarUrl);

        // populate profile form if on that page
        if (document.getElementById('f-fname')) document.getElementById('f-fname').value = fname;
        if (document.getElementById('f-lname')) document.getElementById('f-lname').value = lname;
        if (document.getElementById('f-email')) document.getElementById('f-email').value = profile.email || user.email;
        if (document.getElementById('f-phone')) document.getElementById('f-phone').value = profile.phone || '';
        if (document.getElementById('f-company')) document.getElementById('f-company').value = profile.company || '';

        if (!profile.avatar_url && oauthAvatarUrl) {
          await window.sbClient
            .from('profiles')
            .update({ avatar_url: oauthAvatarUrl, updated_at: new Date().toISOString() })
            .eq('id', user.id);
        }
        } else if (oauthAvatarUrl) {
          applyClientAvatar(oauthAvatarUrl);
        }
        renderSalesAssignmentNote();
        // Drop the full-screen preload as soon as profile/session is ready.
        setClientDashboardLoadingState(false);
        if (window.hideLoader) hideLoader();

        await loadData();
        subscribeClientFinanceRealtime();
        subscribeClientMessagesRealtime();
        setDbStatus('connected', 'Connected to Supabase');
      } catch (dashboardErr) {
        if (window._L) _L.error('Client dashboard bootstrap failed:', dashboardErr);
        setDbStatus('error', 'Some data failed to load. Check migrations and policies.');
        ensureClientDashboardSectionsVisible();
      } finally {
        setClientDashboardLoadingState(false);
        ensureClientDashboardSectionsVisible();
        if (window.hideLoader) hideLoader();
      }
    }

    async function loadData() {
      if (!window.sbClient || !CURRENT_USER) {
        if (window._L) _L.debug("loadData aborted: Supabase client or user missing.");
        return;
      }
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      if (window._L) _L.info("Loading client dashboard data...");

      // 1. Fetch User's Projects (with non-breaking fallbacks for relation/schema drift)
      let projects = [];
      let pErr = null;

      const primaryProjects = await sb.from('projects')
        .select(`*,
          developer:profiles!projects_developer_id_fkey(id, first_name, last_name, email, avatar_url, status, available_for_work),
          commissioner:profiles!projects_commissioner_id_fkey(id, first_name, last_name, email, avatar_url, status, available_for_work),
          milestones(*)`)
        .eq('client_id', CURRENT_USER.id)
        .order('created_at', { ascending: false });

      if (!primaryProjects.error) {
        projects = Array.isArray(primaryProjects.data) ? primaryProjects.data : [];
      } else {
        pErr = primaryProjects.error;
        const fallbackProjects = await sb.from('projects')
          .select('*')
          .eq('client_id', CURRENT_USER.id)
          .order('created_at', { ascending: false });

        if (!fallbackProjects.error) {
          projects = Array.isArray(fallbackProjects.data) ? fallbackProjects.data : [];
        } else {
          pErr = fallbackProjects.error || pErr;
        }
      }

      if (!projects.length && pErr) {
        console.error("Error fetching projects:", pErr);
      }

      if (projects.length && !projects.some(p => Array.isArray(p?.milestones))) {
        const projectIds = projects.map(p => p?.id).filter(Boolean);
        if (projectIds.length) {
          const milestonesResult = await sb
            .from('milestones')
            .select('*')
            .in('project_id', projectIds);
          if (!milestonesResult.error) {
            const map = new Map();
            (milestonesResult.data || []).forEach((m) => {
              const key = m?.project_id;
              if (!key) return;
              if (!map.has(key)) map.set(key, []);
              map.get(key).push(m);
            });
            projects = projects.map((p) => ({ ...p, milestones: map.get(p.id) || [] }));
          }
        }
      }

      if (projects.length && !projects.some(p => p?.developer || p?.commissioner)) {
        const profileIds = new Set();
        projects.forEach((p) => {
          const devId = p?.developer_id || p?.assigned_dev_id;
          const commId = p?.commissioner_id || p?.sales_id;
          if (devId) profileIds.add(devId);
          if (commId) profileIds.add(commId);
        });

        if (profileIds.size) {
          const profileResult = await sb
            .from('profiles')
            .select('id, first_name, last_name, email, avatar_url, status, available_for_work')
            .in('id', Array.from(profileIds));
          if (!profileResult.error) {
            const profileMap = new Map((profileResult.data || []).map((p) => [p.id, p]));
            projects = projects.map((p) => {
              const devId = p?.developer_id || p?.assigned_dev_id;
              const commId = p?.commissioner_id || p?.sales_id;
              return {
                ...p,
                developer: p.developer || (devId ? profileMap.get(devId) || null : null),
                commissioner: p.commissioner || (commId ? profileMap.get(commId) || null : null),
              };
            });
          }
        }
      }

      CLIENT_PROJECTS_CACHE = Array.isArray(projects) ? projects : [];
      syncSupportProjectOptions();

      // 2. Fetch User's Invoices
      let { data: invoices, error: iErr } = await sb.from('invoices')
        .select(`*`)
        .or(`client_id.eq.${CURRENT_USER.id},client_email.eq.${CURRENT_USER.email}`)
        .order('created_at', { ascending: false });

      if (iErr && isMissingColumnError(iErr, 'client_id')) {
        const fallbackInvoices = await sb.from('invoices')
          .select(`*`)
          .eq('client_email', CURRENT_USER.email)
          .order('created_at', { ascending: false });
        invoices = fallbackInvoices.data;
        iErr = fallbackInvoices.error;
      }

      if (iErr) console.error("Error fetching invoices:", iErr);
      CLIENT_INVOICES_CACHE = Array.isArray(invoices) ? invoices : [];

      const contactMap = new Map();
      (projects || []).forEach(p => {
        const remember = (person, roleLabel) => {
          if (!person?.id || person.id === CURRENT_USER.id) return;
          const label = `${person.first_name || ''} ${person.last_name || ''}`.trim() || person.email || 'Team Member';
          if (!contactMap.has(person.id)) {
            contactMap.set(person.id, {
              id: person.id,
              name: label,
              role: String(roleLabel || '').toLowerCase(),
              email: person.email || '',
              avatar_url: person.avatar_url || '',
              status: person.status || 'active',
              available_for_work: person.available_for_work,
              project_title: p.title || '',
              project_id: p.id || null
            });
          }
        };
        remember(p.developer, 'developer');
        remember(p.commissioner, 'commissioner');
      });
      CLIENT_CONTACTS = Array.from(contactMap.values());

      // Render Projects
      let activeCount = 0;
      let projHtml = '';
      if (projects && projects.length > 0) {
        activeCount = projects.filter(p => ['in-progress', 'in_progress', 'active', 'open', 'pending'].includes(String(p.status || '').toLowerCase())).length;
        projHtml = projects.slice(0, 3).map(p => {
          const devName = p.developer ? `${p.developer.first_name || ''} ${p.developer.last_name || ''}`.trim() : 'Unassigned';
          return `
              <div class="proj-row project-row-action" style="padding: 12px; border-bottom: 1px solid var(--border-1);" onclick="openClientProjectDetails('${p.id}')">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px;">
                  <div style="font-weight:600; color:var(--text-1); font-size:13px;">${p.title}</div>
                  <div style="font-family:'DM Mono', monospace; font-size:12px; color:var(--text-2);">${Number(p.total_value ?? p.budget ?? 0).toLocaleString()} KES</div>
                </div>
                <div style="font-size:11px; color:var(--text-4);">
                  Developer: ${devName}  Status: <span style="text-transform:capitalize;">${p.status}</span>
                </div>
              </div>`;
        }).join('');
      } else {
        projHtml = `<div class="loading-text" style="padding:20px; text-align:center; color:var(--text-5);">${pErr ? 'Unable to load projects' : 'No projects yet. New projects will appear here.'}</div>`;
      }

      const milestoneItems = (projects || []).flatMap(p =>
        (p.milestones || []).map(m => ({
          project: p.title || 'Project',
          title: m.title || 'Milestone',
          amount: m.amount || 0,
          status: m.status || 'pending',
          due: m.due_date
        }))
      );
      const paidMilestones = milestoneItems.filter(m => m.status === 'paid' || m.status === 'approved').length;
      const msEl = document.getElementById('dash-milestones');
      if (msEl) {
        if (!milestoneItems.length) {
          msEl.innerHTML = `<div class="loading-text" style="padding:20px; text-align:center; color:var(--text-5);">No milestones yet. Milestone activity will appear here.</div>`;
        } else {
          msEl.innerHTML = milestoneItems.slice(0, 6).map(m => `
            <div class="ms-row">
              <div class="ms-col">
                <div class="ms-dot ${m.status === 'paid' || m.status === 'approved' ? 'done' : (m.status === 'in-progress' || m.status === 'submitted' ? 'cur' : 'locked')}"></div>
                <div class="ms-line"></div>
              </div>
              <div class="ms-body">
                <div class="ms-title ${m.status === 'paid' || m.status === 'approved' ? 'done' : (m.status === 'in-progress' || m.status === 'submitted' ? 'cur' : 'locked')}">${m.title}</div>
                <div class="ms-sub">${m.project}  ${m.due ? new Date(m.due).toLocaleDateString() : 'TBD'}  KSh ${Number(m.amount).toLocaleString()}</div>
              </div>
            </div>`).join('');
        }
      }

      if (document.getElementById('dash-projects')) document.getElementById('dash-projects').innerHTML = projHtml;
      if (document.getElementById('s-proj')) document.getElementById('s-proj').textContent = activeCount;
      if (document.getElementById('nav-proj-count')) document.getElementById('nav-proj-count').textContent = String(activeCount);
      if (document.getElementById('s-ms')) document.getElementById('s-ms').textContent = milestoneItems.length ? `${paidMilestones}/${milestoneItems.length}` : '0/0';
      syncClientGuide((projects || []).length);
      renderEscrowStats(projects || [], milestoneItems, invoices || []);
      renderBillingInvoiceSummary(invoices || []);

      const tbBody = document.getElementById('projects-table-body');
      if (tbBody) {
        if (Array.isArray(projects) && projects.length) {
          tbBody.innerHTML = projects.map(p => {
            const devName = p.developer ? `${p.developer.first_name || ''} ${p.developer.last_name || ''}`.trim() : 'Unassigned';
            const statusClass = (p.status === 'active' || p.status === 'in-progress') ? 'b-g' : (p.status === 'review' ? 'b-b' : 'b-w');
            return `
                <tr class="project-row-action" onclick="openClientProjectDetails('${p.id}')">
                  <td>
                    <div style="font-weight:600; color:var(--text-1);">${p.title}</div>
                    <div style="font-size:10px; color:var(--text-5);">ID: ${String(p.id || '').slice(0, 8)}</div>
                  </td>
                  <td style="font-size:13px;">${devName}</td>
                  <td style="font-family:'DM Mono', monospace; font-size:13px;">${Number(p.total_value ?? p.budget ?? 0).toLocaleString()} KES</td>
                  <td style="font-size:11px; color:var(--text-4);">${p.due_date ? new Date(p.due_date).toLocaleDateString() : 'TBD'}</td>
                  <td>
                    <div class="pbg" style="width:60px;"><div class="pf pf-g" style="width:${p.progress || 0}%"></div></div>
                  </td>
                  <td><span class="badge ${statusClass}">${p.status || 'open'}</span></td>
                </tr>`;
          }).join('');
        } else {
          tbBody.innerHTML = `<tr><td colspan="6" class="loading-text">${pErr ? 'Unable to load projects right now.' : 'No projects yet.'}</td></tr>`;
        }
      }

      // Render Invoices
      const invBody = document.getElementById('invoices-table-body');
      if (invBody) {
        if (!invoices || invoices.length === 0) {
          invBody.innerHTML = `<tr><td colspan="5" class="loading-text">No invoices found.</td></tr>`;
        } else {
          invBody.innerHTML = invoices.map(inv => {
            const invStatus = String(inv.status || 'pending').toLowerCase();
            const statusClass = invStatus === 'paid' ? 'b-g' : (invStatus === 'sent' ? 'b-b' : (invStatus === 'failed' ? 'b-r' : 'b-a'));
            const isPayable = ['sent', 'pending', 'overdue'].includes(invStatus);
            let payBtn = '';
            if (isPayable && inv.paystack_authorization_url) {
              payBtn = `<a href="${inv.paystack_authorization_url}" target="_blank" class="btn btn-w btn-xs">Pay Now</a>`;
            } else if (isPayable && inv.id) {
              payBtn = `<button class="btn btn-g btn-xs" onclick="generateInvoicePaymentLink('${inv.id}')">Generate Link</button>`;
            }
            const invoiceLabel = inv.invoice_number || `#${String(inv.id || '').slice(-6).toUpperCase()}`;
            return `
                <tr>
                  <td>
                    <div style="font-weight:600; color:var(--text-1);">${invoiceLabel}</div>
                    <div style="font-size:10px; color:var(--text-5);">${inv.created_at ? new Date(inv.created_at).toLocaleDateString() : '-'}</div>
                  </td>
                  <td style="font-size:13px;">${inv.description || 'Invoice'}</td>
                  <td style="font-family:'DM Mono', monospace; font-size:13px;">${Number(inv.amount || 0).toLocaleString()} ${String(inv.currency || 'KES').toUpperCase()}</td>
                  <td><span class="badge ${statusClass}">${invStatus}</span></td>
                  <td>${payBtn}</td>
                </tr>`;
          }).join('');
        }
      }

      if (invoices) {
        const totalPaid = invoices.filter(i => i.status === 'paid').reduce((acc, i) => acc + (i.amount || 0), 0);
        const escrowEl = document.getElementById('s-escrow');
        if (escrowEl) escrowEl.textContent = `KSh ${totalPaid.toLocaleString()}`;
      }

      await Promise.allSettled([
        loadClientMessageThreads(),
        loadClientFinance(),
        loadClientNotifications(),
      ]);
      if (ACTIVE_PROJECT_DETAIL_ID) {
        const activeProject = findProjectById(ACTIVE_PROJECT_DETAIL_ID);
        if (activeProject) renderProjectDetailModal(activeProject);
      }
      ensureClientDashboardSectionsVisible();
      setClientDashboardLoadingState(false);
    }

    function setClientDashboardLoadingState(isLoading, message = 'Loading dashboard data... (check your internet)') {
      const prelayout = document.getElementById('dashboard-prelayout');
      if (!prelayout) return;
      prelayout.classList.toggle('active', Boolean(isLoading));
      const text = prelayout.querySelector('.dashboard-prelayout-text');
      if (text && message) text.textContent = String(message);
    }

    function renderEscrowStats(projects, milestoneItems, invoices) {
      const projectList = Array.isArray(projects) ? projects : [];
      const milestoneList = Array.isArray(milestoneItems) ? milestoneItems : [];
      const invoiceList = Array.isArray(invoices) ? invoices : [];

      const released = milestoneList
        .filter(m => m.status === 'paid' || m.status === 'approved')
        .reduce((acc, m) => acc + Number(m.amount || 0), 0);
      const pending = milestoneList
        .filter(m => m.status === 'submitted' || m.status === 'in-progress' || m.status === 'pending' || m.status === 'locked')
        .reduce((acc, m) => acc + Number(m.amount || 0), 0);
      const committed = projectList.reduce((acc, p) => acc + Number(p.total_value ?? p.budget ?? 0), 0);
      const held = Math.max(committed - released, 0);
      const paidInvoices = invoiceList.filter(i => i.status === 'paid').length;

      const heldVal = document.getElementById('escrow-held-val');
      if (heldVal) heldVal.textContent = `KSh ${Math.round(held).toLocaleString()}`;
      const heldSub = document.getElementById('escrow-held-sub');
      if (heldSub) heldSub.textContent = `Across ${projectList.length} project${projectList.length === 1 ? '' : 's'}`;

      const releasedVal = document.getElementById('escrow-released-val');
      if (releasedVal) releasedVal.textContent = `KSh ${Math.round(released).toLocaleString()}`;
      const releasedSub = document.getElementById('escrow-released-sub') || document.querySelector('#page-escrow .g4 .sc:nth-child(2) .sc-d');
      if (releasedSub) releasedSub.textContent = `${paidInvoices} paid invoice${paidInvoices === 1 ? '' : 's'}`;

      const pendingVal = document.getElementById('escrow-pending-val');
      if (pendingVal) pendingVal.textContent = `KSh ${Math.round(pending).toLocaleString()}`;
      const pendingSub = document.getElementById('escrow-pending-sub');
      if (pendingSub) pendingSub.textContent = milestoneList.length ? 'Awaiting approval' : 'No pending milestones';

      const totalVal = document.getElementById('escrow-total-val');
      if (totalVal) totalVal.textContent = `KSh ${Math.round(committed).toLocaleString()}`;
      const totalSub = document.getElementById('escrow-total-sub');
      if (totalSub) totalSub.textContent = `${milestoneList.length} milestone${milestoneList.length === 1 ? '' : 's'} tracked`;

      const ringTotal = document.getElementById('escrow-ring-total');
      if (ringTotal) ringTotal.textContent = `KSh ${Math.round(committed).toLocaleString()}`;
      const legReleased = document.getElementById('escrow-legend-released');
      if (legReleased) legReleased.textContent = `KSh ${Math.round(released).toLocaleString()}`;
      const legHeld = document.getElementById('escrow-legend-held');
      if (legHeld) legHeld.textContent = `KSh ${Math.round(held).toLocaleString()}`;
      const legPending = document.getElementById('escrow-legend-pending');
      if (legPending) legPending.textContent = `KSh ${Math.round(pending).toLocaleString()}`;

      const circumference = 239;
      const totalForRing = Math.max(released + held + pending, 0);
      const releasedLen = totalForRing > 0 ? (released / totalForRing) * circumference : 0;
      const heldLen = totalForRing > 0 ? (held / totalForRing) * circumference : 0;
      const pendingLen = Math.max(circumference - releasedLen - heldLen, 0);
      const ringReleased = document.getElementById('escrow-ring-released');
      const ringHeld = document.getElementById('escrow-ring-held');
      const ringPending = document.getElementById('escrow-ring-pending');
      if (ringReleased) {
        ringReleased.setAttribute('stroke-dasharray', `${releasedLen} ${Math.max(circumference - releasedLen, 0)}`);
        ringReleased.setAttribute('stroke-dashoffset', '0');
      }
      if (ringHeld) {
        ringHeld.setAttribute('stroke-dasharray', `${heldLen} ${Math.max(circumference - heldLen, 0)}`);
        ringHeld.setAttribute('stroke-dashoffset', `${-releasedLen}`);
      }
      if (ringPending) {
        ringPending.setAttribute('stroke-dasharray', `${pendingLen} ${Math.max(circumference - pendingLen, 0)}`);
        ringPending.setAttribute('stroke-dashoffset', `${-(releasedLen + heldLen)}`);
      }

      const activityNote = document.getElementById('escrow-activity-note');
      if (activityNote) {
        activityNote.textContent = invoiceList.length
          ? `${invoiceList.filter(i => String(i.status || '').toLowerCase() === 'paid').length} invoices paid, ${invoiceList.filter(i => String(i.status || '').toLowerCase() !== 'paid').length} pending`
          : 'No escrow activity yet.';
      }
    }

    function renderBillingInvoiceSummary(invoices) {
      const list = Array.isArray(invoices) ? invoices : [];
      const stats = document.getElementById('billing-invoice-stats');
      const rows = document.getElementById('billing-invoice-list');
      if (!stats || !rows) return;

      if (!list.length) {
        stats.textContent = 'No invoices available for this account yet.';
        rows.innerHTML = '<div class="loading-text" style="padding:12px;text-align:center;color:var(--text-5);">No invoices yet.</div>';
        return;
      }

      const paid = list.filter(i => String(i.status || '').toLowerCase() === 'paid');
      const outstanding = list.filter(i => ['pending', 'sent', 'overdue'].includes(String(i.status || '').toLowerCase()));
      const paidTotal = paid.reduce((acc, i) => acc + Number(i.amount || 0), 0);
      const outstandingTotal = outstanding.reduce((acc, i) => acc + Number(i.amount || 0), 0);
      stats.textContent = `Paid: KSh ${Math.round(paidTotal).toLocaleString()}  |  Outstanding: KSh ${Math.round(outstandingTotal).toLocaleString()}`;

      rows.innerHTML = list.slice(0, 4).map(inv => {
        const status = String(inv.status || 'pending').toLowerCase();
        const statusCls = status === 'paid' ? 'b-g' : (status === 'failed' ? 'b-r' : 'b-a');
        const isPayable = ['pending', 'sent', 'overdue'].includes(status);
        const payAction = isPayable
          ? (inv.paystack_authorization_url
            ? `<a href="${inv.paystack_authorization_url}" target="_blank" class="btn btn-w btn-xs">Pay</a>`
            : `<button class="btn btn-g btn-xs" onclick="generateInvoicePaymentLink('${inv.id}')">Generate</button>`)
          : '';
        const invLabel = inv.invoice_number || `#${String(inv.id || '').slice(-6).toUpperCase()}`;
        return `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:9px 10px;border:1px solid var(--border-1);border-radius:var(--r10);background:var(--bg-inset);">
          <div style="min-width:0;">
            <div style="font-size:12px;font-weight:600;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${invLabel}  ${inv.description || 'Invoice'}</div>
            <div style="font-size:10px;color:var(--text-5);margin-top:2px;">${inv.created_at ? new Date(inv.created_at).toLocaleDateString() : ''}</div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <span class="badge ${statusCls}">${status}</span>
            ${payAction}
          </div>
        </div>`;
      }).join('');
    }

    function syncClientGuide(projectCount) {
      const guide = document.getElementById('client-onboard-guide');
      if (!guide) return;
      const dismissed = localStorage.getItem(CLIENT_GUIDE_KEY) === '1';
      const shouldShow = !dismissed && Number(projectCount || 0) === 0;
      guide.style.display = shouldShow ? 'block' : 'none';
      renderSalesAssignmentNote();
    }

    function notificationIcon(type) {
      const normalized = String(type || 'info').toLowerCase();
      if (normalized.includes('invoice')) return '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
      if (normalized.includes('wallet') || normalized.includes('payment')) return '<svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>';
      if (normalized.includes('message')) return '<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>';
      if (normalized.includes('dispute') || normalized.includes('alert')) return '<svg viewBox="0 0 24 24"><path d="M10.3 3.9 1.8 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.9a2 2 0 0 0-3.4 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
      return '<svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>';
    }

    function notificationTime(value) {
      const dt = value ? new Date(value) : null;
      if (!dt || Number.isNaN(dt.getTime())) return 'just now';
      const diffMs = Date.now() - dt.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      const diffHrs = Math.floor(diffMins / 60);
      if (diffHrs < 24) return `${diffHrs}h ago`;
      return dt.toLocaleDateString();
    }

    async function loadClientNotifications() {
      const listEl = document.getElementById('notifications-list');
      const navBadge = document.getElementById('nav-notif-count');
      if (!window.sbClient || !CURRENT_USER) {
        if (listEl) listEl.innerHTML = '<div class="loading-text" style="padding:20px;text-align:center;color:var(--text-5);">Sign in to view notifications.</div>';
        if (navBadge) navBadge.textContent = '0';
        return;
      }

      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      let legacyNotificationsSchema = false;
      let { data: notifications, error } = await sb
        .from('notifications')
        .select('id, type, title, body, payload, read_at, created_at')
        .eq('user_id', CURRENT_USER.id)
        .order('created_at', { ascending: false })
        .limit(80);

      if (error && (isMissingColumnError(error, 'read_at') || isMissingColumnError(error, 'body') || isMissingColumnError(error, 'payload'))) {
        legacyNotificationsSchema = true;
        const fallback = await sb
          .from('notifications')
          .select('id, type, title, content, is_read, created_at')
          .eq('user_id', CURRENT_USER.id)
          .order('created_at', { ascending: false })
          .limit(80);
        notifications = fallback.data;
        error = fallback.error;
      }

      if (error) {
        if (listEl) listEl.innerHTML = `<div class="loading-text" style="padding:20px;text-align:center;color:var(--text-5);">${clientErrorMessage(error, 'Unable to load notifications.')}</div>`;
        if (navBadge) navBadge.textContent = '0';
        return;
      }

      const rows = Array.isArray(notifications) ? notifications : [];
      const unreadCount = rows.filter(n => legacyNotificationsSchema ? !n.is_read : !n.read_at).length;
      if (navBadge) navBadge.textContent = String(unreadCount);

      if (!rows.length) {
        if (listEl) listEl.innerHTML = '<div class="loading-text" style="padding:20px;text-align:center;color:var(--text-5);">No notifications yet.</div>';
        return;
      }

      if (listEl) {
        listEl.innerHTML = rows.map(n => {
          const unread = legacyNotificationsSchema ? !n.is_read : !n.read_at;
          const title = n.title || 'Notification';
          const body = legacyNotificationsSchema ? (n.content || '') : (n.body || n.content || '');
          return `<div class="notif" style="${unread ? 'border-color:var(--border-2);background:var(--bg-inset);' : ''}">
            <div class="notif-ico">${notificationIcon(n.type)}</div>
            <div style="flex:1;min-width:0;">
              <div class="notif-title">${title}</div>
              <div class="notif-sub">${body || 'Update from your workspace'}</div>
              <div class="notif-time">${notificationTime(n.created_at)}</div>
            </div>
            ${unread ? `<button class="btn btn-g btn-xs" onclick="markNotificationRead('${n.id}')">Mark Read</button>` : '<span class="badge b-g">Read</span>'}
          </div>`;
        }).join('');
      }
    }

    function safeRole(role) {
      const val = String(role || '').toLowerCase();
      if (val === 'developer') return 'Developer';
      if (val === 'commissioner') return 'Commissioner';
      if (val === 'client') return 'Client';
      if (val === 'admin') return 'Admin';
      return 'Team';
    }

    function rolePill(role) {
      const val = String(role || '').toLowerCase();
      const palette = val === 'developer'
        ? { bg: 'var(--gbg)', fg: 'var(--green)' }
        : (val === 'commissioner'
          ? { bg: 'var(--abg)', fg: 'var(--amber)' }
          : (val === 'client'
            ? { bg: 'var(--bbg)', fg: 'var(--blue)' }
            : { bg: 'var(--bg-inset)', fg: 'var(--text-5)' }));
      return `<span style="font-size:10px;font-weight:600;padding:2px 7px;border-radius:999px;background:${palette.bg};color:${palette.fg};letter-spacing:.03em;">${safeRole(val)}</span>`;
    }

    function availabilityMeta(meta = {}) {
      const status = String(meta.status || '').toLowerCase();
      if (status === 'inactive' || status === 'suspended' || status === 'offline') {
        return { label: 'Offline', bg: 'var(--rbg)', fg: 'var(--red)' };
      }
      if (meta.available_for_work === false) {
        return { label: 'Busy', bg: 'var(--abg)', fg: 'var(--amber)' };
      }
      return { label: 'Available', bg: 'var(--gbg)', fg: 'var(--green)' };
    }

    function availabilityPill(meta = {}) {
      const av = availabilityMeta(meta);
      return `<span style="font-size:10px;font-weight:600;padding:2px 7px;border-radius:999px;background:${av.bg};color:${av.fg};letter-spacing:.03em;">${av.label}</span>`;
    }

    function avatarNode(name = 'User', avatarUrl = '', size = 30, fontSize = 11) {
      const initials = String(name || 'User').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase() || 'TM';
      const safeUrl = String(avatarUrl || '').trim();
      if (!safeUrl) {
        return `<div class="av" style="width:${size}px;height:${size}px;font-size:${fontSize}px">${initials}</div>`;
      }
      return `<div class="av" style="position:relative;width:${size}px;height:${size}px;font-size:${fontSize}px;overflow:hidden"><img src="${safeUrl}" alt="" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.remove()">${initials}</div>`;
    }

    function getClientMessageFilters() {
      return {
        search: (document.getElementById('msg-search')?.value || '').trim().toLowerCase(),
        filter: (document.getElementById('msg-role-filter')?.value || 'all').toLowerCase()
      };
    }

    function filterClientThreads(rows) {
      const { search, filter } = getClientMessageFilters();
      return rows.filter(row => {
        if (filter === 'unread' && !row.unread) return false;
        if (filter !== 'all' && filter !== 'unread' && String(row.role || '').toLowerCase() !== filter) return false;
        if (!search) return true;
        const hay = `${row.name} ${row.role} ${row.projectTitle} ${row.preview} ${row.email || ''}`.toLowerCase();
        return hay.includes(search);
      });
    }

    function getClientContactMeta(peerId) {
      return (CLIENT_CONTACTS || []).find(c => c.id === peerId) || null;
    }

    window.focusClientMessageComposer = function () {
      showPage('messages');
      const searchInput = document.getElementById('msg-search');
      if (searchInput) searchInput.focus();
    };

    function setClientChatMeta(meta) {
      const el = document.getElementById('chat-header-meta');
      if (!el) return;
      if (!meta) {
        el.textContent = 'Role: - | Project: -';
        return;
      }
      const role = safeRole(meta.role);
      const project = meta.project_title || 'General';
      const availability = availabilityMeta(meta).label;
      el.innerHTML = `Role: <strong>${role}</strong> | Availability: <strong>${availability}</strong> | Project: <strong>${project}</strong>${meta.email ? ` | ${meta.email}` : ''}`;
    }

    async function loadClientMessageThreads() {
      const msgList = document.getElementById('messages-list');
      const dashMsgs = document.getElementById('dash-messages');
      if (!window.sbClient || !CURRENT_USER) {
        const html = '<div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">Sign in to view messages.</div>';
        if (msgList) msgList.innerHTML = html;
        if (dashMsgs) dashMsgs.innerHTML = html;
        if (document.getElementById('s-msg')) document.getElementById('s-msg').textContent = '0';
        if (document.getElementById('nav-msg-count')) document.getElementById('nav-msg-count').textContent = '0';
        setClientChatIdle('Sign in to view messages.');
        return;
      }

      const { data: msgs, error: msgErr } = await window.sbClient
        .from('messages')
        .select(`id, content, created_at, is_read, sender_id, receiver_id,
          sender:profiles!messages_sender_id_fkey(id, first_name, last_name, email, role, avatar_url, status, available_for_work),
          receiver:profiles!messages_receiver_id_fkey(id, first_name, last_name, email, role, avatar_url, status, available_for_work)`)
        .or(`sender_id.eq.${CURRENT_USER.id},receiver_id.eq.${CURRENT_USER.id}`)
        .order('created_at', { ascending: false });

      CLIENT_THREAD_CACHE = Array.isArray(msgs) ? msgs : [];
      if (msgErr || !CLIENT_THREAD_CACHE.length) {
        const starterRows = filterClientThreads((CLIENT_CONTACTS || []).map(c => ({
          id: c.id,
          name: c.name || 'Team Member',
          role: c.role || 'team',
          projectTitle: c.project_title || '',
          email: c.email || '',
          avatar_url: c.avatar_url || '',
          status: c.status || '',
          available_for_work: c.available_for_work,
          preview: c.email || '',
          unread: 0
        })));
        const html = msgErr
          ? '<div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">Unable to load messages right now.</div>'
          : (starterRows.length
            ? starterRows.map(c => {
              const safe = c.name.replace(/'/g, '');
              return `<div class="msg" style="cursor:pointer" onclick="openClientThread('${c.id}','${safe}')">${avatarNode(c.name, c.avatar_url, 30, 11)}<div style="flex:1;min-width:0"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><div class="msg-sender">${c.name}</div>${rolePill(c.role)}</div><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:2px 0 1px;">${availabilityPill(c)}${c.projectTitle ? `<span style="font-size:10px;color:var(--text-5)">Project: ${c.projectTitle}</span>` : ''}</div><div class="msg-prev">${c.email || 'Start a conversation'}</div></div></div>`;
            }).join('')
            : '<div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">No messages yet. Conversations will appear here.</div>');
        if (msgList) msgList.innerHTML = html;
        if (dashMsgs) dashMsgs.innerHTML = html;
        if (document.getElementById('s-msg')) document.getElementById('s-msg').textContent = '0';
        if (document.getElementById('nav-msg-count')) document.getElementById('nav-msg-count').textContent = '0';
        if (!ACTIVE_CHAT_USER?.id) {
          setClientChatIdle(CLIENT_CONTACTS.length ? 'Select a contact to start messaging.' : 'Click a message to open it');
        }
        return;
      }

      const threadMap = {};
      CLIENT_THREAD_CACHE.forEach(m => {
        const sender = m.sender || {};
        const receiver = m.receiver || {};
        const other = sender.id === CURRENT_USER.id ? receiver : sender;
        if (!other?.id) return;
        const meta = getClientContactMeta(other.id);
        if (!threadMap[other.id]) {
          threadMap[other.id] = {
            person: other,
            lastMsg: m,
            unread: 0,
            role: other.role || meta?.role || 'team',
            project_title: meta?.project_title || '',
            email: other.email || meta?.email || '',
            avatar_url: other.avatar_url || meta?.avatar_url || '',
            status: other.status || meta?.status || '',
            available_for_work: typeof other.available_for_work === 'boolean' ? other.available_for_work : meta?.available_for_work
          };
        }
        if (new Date(m.created_at).getTime() > new Date(threadMap[other.id].lastMsg.created_at).getTime()) {
          threadMap[other.id].lastMsg = m;
        }
        if (!m.is_read && sender.id !== CURRENT_USER.id) {
          threadMap[other.id].unread++;
        }
      });

      let threadList = Object.values(threadMap)
        .sort((a, b) => new Date(b.lastMsg.created_at).getTime() - new Date(a.lastMsg.created_at).getTime())
        .map(t => {
          const name = `${t.person.first_name || ''} ${t.person.last_name || ''}`.trim() || 'User';
          const preview = (t.lastMsg.content || '').slice(0, 64);
          return {
            ...t,
            name,
            preview,
            roleLabel: safeRole(t.role)
          };
        });
      threadList = filterClientThreads(threadList.map(t => ({
        id: t.person.id,
        name: t.name,
        role: t.role,
        projectTitle: t.project_title || '',
        email: t.email || '',
        avatar_url: t.avatar_url || '',
        status: t.status || '',
        available_for_work: t.available_for_work,
        preview: t.preview || '',
        unread: t.unread,
        source: t
      }))).map(x => x.source);

      const totalUnread = Object.values(threadMap).reduce((a, t) => a + t.unread, 0);
      if (document.getElementById('s-msg')) document.getElementById('s-msg').textContent = String(totalUnread);
      if (document.getElementById('nav-msg-count')) document.getElementById('nav-msg-count').textContent = String(totalUnread);

      if (msgList) {
        msgList.innerHTML = threadList.map(t => {
          const name = t.name || `${t.person.first_name || ''} ${t.person.last_name || ''}`.trim() || 'User';
          const safeName = name.replace(/'/g, '');
          const preview = t.preview || (t.lastMsg.content || '').slice(0, 64);
          const active = ACTIVE_CHAT_USER?.id === t.person.id ? 'border:1px solid var(--border-2);background:var(--bg-inset);' : '';
          return `<div class="msg" style="cursor:pointer;${active}" onclick="openClientThread('${t.person.id}','${safeName}')">${avatarNode(name, t.avatar_url, 30, 11)}<div style="flex:1;min-width:0"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><div class="msg-sender">${name}</div>${rolePill(t.role)}</div><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:2px 0 1px;">${availabilityPill(t)}${t.project_title ? `<span style="font-size:10px;color:var(--text-5)">Project: ${t.project_title}</span>` : ''}</div><div class="msg-prev">${preview || 'New message'}</div></div>${t.unread ? `<span class="badge b-b">${t.unread}</span>` : ''}</div>`;
        }).join('');
      }

      if (dashMsgs) {
        dashMsgs.innerHTML = threadList.slice(0, 3).map(t => {
          const name = t.name || `${t.person.first_name || ''} ${t.person.last_name || ''}`.trim() || 'User';
          const preview = t.preview || (t.lastMsg.content || '').slice(0, 56);
          return `<div class="msg">${avatarNode(name, t.avatar_url, 28, 10)}<div style="flex:1;min-width:0"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><div class="msg-sender">${name}</div>${rolePill(t.role)}</div><div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:2px 0 1px;">${availabilityPill(t)}</div><div class="msg-prev">${t.project_title ? `Project: ${t.project_title}` : (preview || 'New message')}</div></div></div>`;
        }).join('');
      }

      if (ACTIVE_CHAT_USER?.id && threadList.some(t => t.person.id === ACTIVE_CHAT_USER.id)) {
        renderClientChatMessages(
          CLIENT_THREAD_CACHE
            .filter(m => (m.sender_id === CURRENT_USER.id && m.receiver_id === ACTIVE_CHAT_USER.id) || (m.sender_id === ACTIVE_CHAT_USER.id && m.receiver_id === CURRENT_USER.id))
            .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())
        );
      } else if (ACTIVE_CHAT_USER?.id) {
        setClientChatIdle('Click a message to open it');
      } else {
        setClientChatIdle('Click a message to open it');
      }
    }
    window.loadClientMessageThreads = loadClientMessageThreads;

    function setClientChatIdle(message) {
      const pane = document.getElementById('chat-thread-pane');
      const title = document.getElementById('chat-header-title');
      const input = document.getElementById('chat-input');
      const send = document.getElementById('chat-send-btn');
      ACTIVE_CHAT_USER = null;
      if (CLIENT_CHAT_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_CHAT_CHANNEL);
        CLIENT_CHAT_CHANNEL = null;
      }
      if (pane) {
        pane.style.display = 'flex';
        pane.style.alignItems = 'center';
        pane.style.justifyContent = 'center';
        pane.innerHTML = message || 'Click a message to open it';
      }
      if (title) title.textContent = 'Select a conversation';
      setClientChatMeta(null);
      if (input) {
        input.value = '';
        input.disabled = true;
      }
      if (send) send.disabled = true;
    }

    function buildClientBubble(msg, isMine) {
      const wrap = document.createElement('div');
      wrap.style.cssText = `display:flex;justify-content:${isMine ? 'flex-end' : 'flex-start'};margin-bottom:8px;`;
      const bubble = document.createElement('div');
      bubble.style.cssText = `max-width:75%;padding:9px 12px;border-radius:${isMine ? '14px 14px 4px 14px' : '14px 14px 14px 4px'};font-size:12.5px;line-height:1.42;background:${isMine ? 'var(--text-1)' : 'var(--bg-inset)'};color:${isMine ? 'var(--bg-page)' : 'var(--text-1)'};border:${isMine ? 'none' : '1px solid var(--border-1)'};`;
      const body = document.createElement('div');
      body.textContent = msg.content || '';
      const meta = document.createElement('div');
      meta.style.cssText = `margin-top:5px;font-size:10px;opacity:.8;text-align:${isMine ? 'right' : 'left'};`;
      const stamp = msg.created_at ? new Date(msg.created_at).toLocaleString() : 'now';
      const status = isMine ? (msg.is_read ? 'Seen' : 'Sent') : 'Received';
      meta.textContent = `${stamp} | ${status}`;
      bubble.appendChild(body);
      bubble.appendChild(meta);
      wrap.appendChild(bubble);
      return wrap;
    }

    function renderClientChatMessages(messages) {
      const pane = document.getElementById('chat-thread-pane');
      if (!pane) return;
      pane.style.display = 'block';
      pane.style.height = '260px';
      pane.style.overflowY = 'auto';
      pane.style.padding = '6px 2px';
      if (!messages?.length) {
        pane.innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-5);font-size:13px;">No messages yet. Start the conversation.</div>';
        return;
      }
      pane.innerHTML = '';
      messages.forEach(m => pane.appendChild(buildClientBubble(m, m.sender_id === CURRENT_USER.id)));
      pane.scrollTop = pane.scrollHeight;
    }

    window.openClientThread = async function (peerId, peerName) {
      if (!window.sbClient || !CURRENT_USER || !peerId) return;
      ACTIVE_CHAT_USER = { id: peerId, name: peerName || 'User' };
      const activeMeta = getClientContactMeta(peerId);
      const title = document.getElementById('chat-header-title');
      const input = document.getElementById('chat-input');
      const send = document.getElementById('chat-send-btn');
      const pane = document.getElementById('chat-thread-pane');
      if (title) title.textContent = `Conversation with ${ACTIVE_CHAT_USER.name}`;
      setClientChatMeta(activeMeta);
      if (input) input.disabled = false;
      if (send) send.disabled = false;
      if (pane) pane.innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--text-5);font-size:13px;">Loading conversation...</div>';

      const { data: history } = await window.sbClient
        .from('messages')
        .select('id, content, created_at, sender_id, receiver_id, is_read')
        .or(`and(sender_id.eq.${CURRENT_USER.id},receiver_id.eq.${peerId}),and(sender_id.eq.${peerId},receiver_id.eq.${CURRENT_USER.id})`)
        .order('created_at', { ascending: true });

      renderClientChatMessages(history || []);
      await window.sbClient.from('messages')
        .update({ is_read: true })
        .eq('receiver_id', CURRENT_USER.id)
        .eq('sender_id', peerId)
        .eq('is_read', false);

      if (CLIENT_CHAT_CHANNEL) {
        window.sbClient.removeChannel(CLIENT_CHAT_CHANNEL);
      }
      CLIENT_CHAT_CHANNEL = window.sbClient
        .channel(`client-chat-${CURRENT_USER.id}-${peerId}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${CURRENT_USER.id}` }, payload => {
          if (payload?.new?.sender_id !== ACTIVE_CHAT_USER?.id) return;
          const paneEl = document.getElementById('chat-thread-pane');
          if (!paneEl || paneEl.style.display === 'flex') return;
          paneEl.appendChild(buildClientBubble(payload.new, false));
          paneEl.scrollTop = paneEl.scrollHeight;
          window.sbClient.from('messages').update({ is_read: true }).eq('id', payload.new.id);
          loadClientMessageThreads();
        })
        .subscribe();

      await loadClientMessageThreads();
    }

    window.sendClientMessage = async function () {
      if (!window.sbClient || !CURRENT_USER || !ACTIVE_CHAT_USER?.id) return;
      const input = document.getElementById('chat-input');
      const pane = document.getElementById('chat-thread-pane');
      if (!input || !pane) return;
      const text = (input.value || '').trim();
      if (!text) return;

      input.value = '';
      const optimistic = buildClientBubble({ content: text, sender_id: CURRENT_USER.id, created_at: new Date().toISOString(), is_read: false }, true);
      pane.appendChild(optimistic);
      pane.scrollTop = pane.scrollHeight;

      const activeMeta = getClientContactMeta(ACTIVE_CHAT_USER.id);
      const { error } = await window.sbClient.from('messages').insert({
        sender_id: CURRENT_USER.id,
        receiver_id: ACTIVE_CHAT_USER.id,
        project_id: activeMeta?.project_id || null,
        content: text,
        is_read: false
      });
      if (error) {
        optimistic.remove();
        toast('Failed to send message');
        return;
      }
      await loadClientMessageThreads();
    }

    function clientErrorMessage(error, fallback = 'Request failed') {
      if (!error) return fallback;
      const raw = String(error.message || error.details || error.hint || '').trim();
      if (!raw) return fallback;
      const lower = raw.toLowerCase();
      if (error.code === '42501' || lower.includes('row-level security') || lower.includes('permission denied')) {
        return 'Permission denied by database policy for this action.';
      }
      if (
        error.code === '42P01'
        || lower.includes('does not exist')
        || (lower.includes('could not find the table') && lower.includes('schema cache'))
      ) {
        return 'Database setup is missing required tables. Run latest migrations.';
      }
      if (lower.includes('duplicate key')) {
        return 'This record already exists.';
      }
      return raw.length > 140 ? `${raw.slice(0, 137)}...` : raw;
    }

    function isMissingTableError(error, tableName) {
      if (!error) return false;
      const raw = `${error.code || ''} ${error.message || ''} ${error.details || ''}`.toLowerCase();
      const table = String(tableName || '').toLowerCase();
      return raw.includes('42p01')
        || (raw.includes('does not exist') && raw.includes(table))
        || (raw.includes('could not find the table') && raw.includes(table))
        || (raw.includes('schema cache') && raw.includes(table));
    }

    function isMissingColumnError(error, columnName = '') {
      if (!error) return false;
      const raw = `${error.code || ''} ${error.message || ''} ${error.details || ''}`.toLowerCase();
      const column = String(columnName || '').toLowerCase();
      return raw.includes('42703')
        || (raw.includes('column') && raw.includes('does not exist') && (!column || raw.includes(column)));
    }

    function isProfilePolicyRecursionError(error) {
      if (!error) return false;
      const raw = `${error.code || ''} ${error.message || ''} ${error.details || ''}`.toLowerCase();
      return raw.includes('infinite recursion')
        && raw.includes('policy')
        && raw.includes('profiles');
    }

    async function safeProfileUpdate(payload, variants = []) {
      if (!window.sbClient || !CURRENT_USER) return { data: null, error: { message: 'No session' }, source: 'none' };
      const dbClient = window.getDbClient ? window.getDbClient() : window.sbClient;
      const merged = { ...(payload || {}), updated_at: new Date().toISOString() };
      const attemptPayloads = [merged, ...variants].map(p => ({ ...(p || {}), updated_at: merged.updated_at }));
      let lastError = null;

      for (const p of attemptPayloads) {
        const { data, error } = await dbClient.from('profiles').update(p).eq('id', CURRENT_USER.id).select('*').maybeSingle();
        if (!error) return { data: data || null, error: null, source: 'direct' };
        lastError = error;
        const retryable = isMissingColumnError(error) || isProfilePolicyRecursionError(error);
        if (!retryable) break;
      }

      // Fallback to service-role Edge Function to bypass recursive profile policies.
      const jwt = await getJwt();
      const edge = await callEdgeFunction('profile-write', { patch: merged }, jwt);
      if (!edge?.error && edge?.success) {
        return { data: edge.profile || null, error: null, source: 'edge' };
      }
      return { data: null, error: edge?.error ? { message: String(edge.error) } : lastError, source: 'none' };
    }

    async function tryInsertVariants(table, payloads, selectSingle = false) {
      const dbClient = window.getDbClient ? window.getDbClient() : window.sbClient;
      if (!dbClient) return { data: null, error: { message: 'Supabase client missing' } };
      let lastError = null;
      for (const payload of payloads) {
        let q = dbClient.from(table).insert(payload);
        if (selectSingle) q = q.select().maybeSingle();
        const { data, error } = await q;
        if (!error) return { data, error: null };
        lastError = error;
        const msg = String(error.message || '').toLowerCase();
        const retryable = msg.includes('column') && msg.includes('does not exist');
        if (!retryable) break;
      }
      return { data: null, error: lastError };
    }

    window.togglePaymentMethodForm = function (forceOpen) {
      const form = document.getElementById('payment-method-form');
      if (!form) return;
      const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : form.classList.contains('hidden');
      form.classList.toggle('hidden', !shouldOpen);
    };

    window.toggleTopupForm = function (forceOpen) {
      const form = document.getElementById('topup-form');
      if (!form) return;
      const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : form.classList.contains('hidden');
      form.classList.toggle('hidden', !shouldOpen);
    };

    function openClientProjectModal() {
      const modal = document.getElementById('project-modal');
      if (!modal) return;
      modal.classList.add('open');
      const titleInput = document.getElementById('new-project-title');
      if (titleInput) titleInput.focus();
    }

    window.closeClientProjectModal = function () {
      const modal = document.getElementById('project-modal');
      if (!modal) return;
      modal.classList.remove('open');
    };

    const EDGE_BASE = window.SUPABASE_FUNCTIONS_BASE
      || `${String(window.SUPABASE_URL || 'https://smdbfaomeghoejqqkplv.supabase.co').replace(/\/$/, '')}/functions/v1`;
    const SUPABASE_ANON = String(window.SUPABASE_ANON_KEY || '').trim();

    async function getJwt(forceRefresh = false) {
      if (!window.sbClient) return null;
      let session = null;
      try {
        const { data } = await window.sbClient.auth.getSession();
        session = data?.session || null;
      } catch (_) { }

      if (!session?.access_token && forceRefresh) {
        try {
          const { data } = await window.sbClient.auth.refreshSession();
          session = data?.session || session;
        } catch (_) { }
      }

      return session?.access_token || null;
    }

    async function callEdgeFunction(fn, payload, userToken, retry401 = true) {
      try {
        const bearer = String(userToken || SUPABASE_ANON || '').trim();
        if (!bearer) {
          return { error: 'Missing auth token. Check Supabase config and sign in again.' };
        }
        const res = await fetch(`${EDGE_BASE}/${fn}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            apikey: SUPABASE_ANON || bearer,
            Authorization: `Bearer ${bearer}`
          },
          body: JSON.stringify(payload || {})
        });
        if (res.status === 401 && retry401 && window.sbClient) {
          const refreshed = await getJwt(true);
          if (refreshed && refreshed !== userToken) {
            return callEdgeFunction(fn, payload, refreshed, false);
          }
        }
        const raw = await res.text();
        let body = {};
        if (raw) {
          try { body = JSON.parse(raw); }
          catch { body = { raw }; }
        }
        if (!res.ok) return { ...body, error: body.error || `Edge function ${fn} failed (${res.status})` };
        return body;
      } catch (e) {
        return { error: String(e) };
      }
    }

    function scheduleClientFinanceRefresh() {
      if (CLIENT_FINANCE_RT_TIMER) clearTimeout(CLIENT_FINANCE_RT_TIMER);
      CLIENT_FINANCE_RT_TIMER = setTimeout(() => {
        loadData();
      }, 250);
    }

    function scheduleClientMessagesRefresh() {
      if (CLIENT_MESSAGES_RT_TIMER) clearTimeout(CLIENT_MESSAGES_RT_TIMER);
      CLIENT_MESSAGES_RT_TIMER = setTimeout(() => {
        loadClientMessageThreads();
      }, 220);
    }

    function subscribeClientMessagesRealtime() {
      if (!window.sbClient || !CURRENT_USER) return;
      if (CLIENT_MESSAGES_CHANNEL) window.sbClient.removeChannel(CLIENT_MESSAGES_CHANNEL);
      CLIENT_MESSAGES_CHANNEL = window.sbClient
        .channel(`client-messages-${CURRENT_USER.id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'messages',
          filter: `receiver_id=eq.${CURRENT_USER.id}`
        }, scheduleClientMessagesRefresh)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'messages',
          filter: `sender_id=eq.${CURRENT_USER.id}`
        }, scheduleClientMessagesRefresh)
        .subscribe();
    }

    function subscribeClientFinanceRealtime() {
      if (!window.sbClient || !CURRENT_USER) return;

      if (CLIENT_INVOICES_CHANNEL) window.sbClient.removeChannel(CLIENT_INVOICES_CHANNEL);
      if (CLIENT_TOPUPS_CHANNEL) window.sbClient.removeChannel(CLIENT_TOPUPS_CHANNEL);
      if (CLIENT_NOTIFICATIONS_CHANNEL) window.sbClient.removeChannel(CLIENT_NOTIFICATIONS_CHANNEL);

      CLIENT_INVOICES_CHANNEL = window.sbClient
        .channel(`client-invoices-${CURRENT_USER.id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'invoices',
          filter: `client_id=eq.${CURRENT_USER.id}`
        }, scheduleClientFinanceRefresh)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'invoices',
          filter: `client_email=eq.${CURRENT_USER.email}`
        }, scheduleClientFinanceRefresh)
        .subscribe();

      CLIENT_TOPUPS_CHANNEL = window.sbClient
        .channel(`client-topups-${CURRENT_USER.id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'wallet_topups',
          filter: `user_id=eq.${CURRENT_USER.id}`
        }, scheduleClientFinanceRefresh)
        .subscribe();

      CLIENT_NOTIFICATIONS_CHANNEL = window.sbClient
        .channel(`client-notifications-${CURRENT_USER.id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'notifications',
          filter: `user_id=eq.${CURRENT_USER.id}`
        }, () => {
          loadClientNotifications();
        })
        .subscribe();
    }

    async function loadClientFinance() {
      if (!window.sbClient || !CURRENT_USER) return;
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      try {
        const { data: methods, error: methodsErr } = await sb
          .from('payment_methods')
          .select('*')
          .eq('user_id', CURRENT_USER.id)
          .order('created_at', { ascending: false });

        const { data: walletTopups, error: topupErr } = await sb
          .from('wallet_topups')
          .select('id, amount, status, provider, created_at, paystack_reference, mpesa_reference')
          .eq('user_id', CURRENT_USER.id)
          .order('created_at', { ascending: false })
          .limit(1);

        const { data: txTopups, error: txErr } = await sb
          .from('financial_transactions')
          .select('id, amount, status, created_at, description, metadata, kind, payer_id, payee_id, created_by')
          .eq('kind', 'wallet_topup')
          .or(`payer_id.eq.${CURRENT_USER.id},payee_id.eq.${CURRENT_USER.id},created_by.eq.${CURRENT_USER.id}`)
          .order('created_at', { ascending: false })
          .limit(1);

        const localMethod = getLocalPaymentMethod();
        const activeMethod = (methods || []).find(m => m.is_default) || (methods || [])[0] || localMethod;
        const methodTitle = document.getElementById('billing-method-title');
        const methodSub = document.getElementById('billing-method-sub');
        const methodBadge = document.getElementById('billing-method-badge');
        const addMethodBtn = document.getElementById('add-payment-method-btn');
        const missingMethodsTable = methodsErr && isMissingTableError(methodsErr, 'payment_methods');
        if (methodTitle) {
          methodTitle.textContent = activeMethod ? activeMethod.label : 'No payment method added';
        }
        if (methodSub) {
          if (missingMethodsTable) {
            methodSub.textContent = activeMethod
              ? `Local fallback active - ${String(activeMethod.provider || 'payment').toUpperCase()}`
              : 'Payment method table missing. Saving locally until migrations are applied.';
          } else {
            methodSub.textContent = activeMethod
              ? `${String(activeMethod.provider || '').toUpperCase()} - ${activeMethod.account_ref || 'configured'}`
              : 'Use Add Payment Method to connect Paystack or M-Pesa';
          }
        }
        if (methodBadge) {
          methodBadge.textContent = activeMethod ? 'Active' : 'None';
          methodBadge.className = `badge ${activeMethod ? 'b-g' : 'b-a'}`;
        }
        if (addMethodBtn) {
          addMethodBtn.disabled = false;
          addMethodBtn.textContent = missingMethodsTable ? '+Add Payment Method (Local)' : '+Add Payment Method';
        }

        const latestTopup = txTopups && txTopups[0];
        const note = document.getElementById('latest-topup-note');
        if (note) {
          if (
            (topupErr && isMissingTableError(topupErr, 'wallet_topups'))
            && (txErr && isMissingTableError(txErr, 'financial_transactions'))
          ) {
            note.style.display = 'block';
            note.textContent = 'Top-up tables are missing. Apply the finance migrations.';
          } else if (walletTopups && walletTopups[0]) {
            const t = walletTopups[0];
            note.style.display = 'block';
            note.textContent = `Latest top-up: KSh ${Number(t.amount || 0).toLocaleString()} - ${String(t.status || 'pending')} (${String(t.provider || 'paystack').toUpperCase()})`;
          } else if (latestTopup) {
            note.style.display = 'block';
            note.textContent = `Latest top-up: KSh ${Number(latestTopup.amount || 0).toLocaleString()} - ${latestTopup.status}`;
          } else {
            note.style.display = 'none';
            note.textContent = '';
          }
        }
      } catch (e) {
        if (window._L) _L.warn('Client finance load skipped:', e?.message || e);
      }
    }

    async function addPaymentMethod() {
      if (!window.sbClient || !CURRENT_USER) return;
      const dbClient = window.getDbClient ? window.getDbClient() : window.sbClient;
      const provider = String(document.getElementById('pm-provider-input')?.value || '').toLowerCase().trim();
      const label = String(document.getElementById('pm-label-input')?.value || '').trim();
      const accountRef = String(document.getElementById('pm-ref-input')?.value || '').trim();
      const saveBtn = document.getElementById('pm-save-btn');

      if (!provider || !['paystack', 'mpesa', 'card', 'bank', 'other'].includes(provider)) {
        toast('Select a valid payment provider');
        return;
      }
      if (!label) {
        toast('Payment method label is required');
        return;
      }

      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
      }

      try {
        const { error: clearErr } = await dbClient.from('payment_methods').update({ is_default: false }).eq('user_id', CURRENT_USER.id);
        if (clearErr && isMissingTableError(clearErr, 'payment_methods')) {
          setLocalPaymentMethod({
            provider,
            label,
            account_ref: accountRef || null,
            is_default: true,
            source: 'local_fallback'
          });
          toast('Payment method saved locally. Apply migrations to sync this to database.');
          document.getElementById('pm-label-input').value = '';
          document.getElementById('pm-ref-input').value = '';
          togglePaymentMethodForm(false);
          await loadClientFinance();
          return;
        }
        if (clearErr && window._L) _L.warn('Unable to clear existing default payment methods:', clearErr);

        const variants = [
          {
            user_id: CURRENT_USER.id,
            provider,
            label,
            account_ref: accountRef || null,
            phone: provider === 'mpesa' ? accountRef || null : null,
            is_default: true,
            status: 'active',
            metadata: {}
          },
          {
            user_id: CURRENT_USER.id,
            provider,
            label,
            account_ref: accountRef || null,
            is_default: true
          },
          {
            user_id: CURRENT_USER.id,
            provider,
            label,
            is_default: true
          }
        ];

        const { error } = await tryInsertVariants('payment_methods', variants, false);
        if (error) {
          if (isMissingTableError(error, 'payment_methods')) {
            setLocalPaymentMethod({
              provider,
              label,
              account_ref: accountRef || null,
              is_default: true,
              source: 'local_fallback'
            });
            toast('Payment method saved locally. Run migrations to enable full syncing.');
            document.getElementById('pm-label-input').value = '';
            document.getElementById('pm-ref-input').value = '';
            togglePaymentMethodForm(false);
            await loadClientFinance();
            return;
          }
          toast(`Failed to add payment method: ${clientErrorMessage(error, 'Please verify database setup')}`);
          return;
        }

        setLocalPaymentMethod({
          provider,
          label,
          account_ref: accountRef || null,
          is_default: true,
          source: 'database'
        });
        toast('Payment method added');
        document.getElementById('pm-label-input').value = '';
        document.getElementById('pm-ref-input').value = '';
        togglePaymentMethodForm(false);
        await loadClientFinance();
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Method';
        }
      }
    }

    async function topUpWallet() {
      if (!window.sbClient || !CURRENT_USER) return;
      const amount = Number(document.getElementById('topup-amount-input')?.value || 0);
      const provider = String(document.getElementById('topup-provider-input')?.value || 'mpesa').toLowerCase().trim();
      const phoneOrRef = String(document.getElementById('topup-phone-input')?.value || '').trim();
      const submitBtn = document.getElementById('topup-submit-btn');

      if (!amount || amount <= 0) { toast('Enter a valid top-up amount'); return; }
      if (!['paystack', 'mpesa', 'bank', 'other'].includes(provider)) { toast('Select a supported provider'); return; }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      try {
        const jwt = await getJwt();
        const edgeResult = await callEdgeFunction('initiate-topup', {
          amount,
          provider,
          phone_or_ref: phoneOrRef || null,
          source: 'client_dashboard'
        }, jwt);

        if (!edgeResult.error) {
          if (edgeResult.authorization_url) {
            toast('Redirecting to Paystack checkout...');
            window.location.href = edgeResult.authorization_url;
            return;
          }

          toast(edgeResult.message || 'Top-up request submitted.');
          document.getElementById('topup-amount-input').value = '';
          document.getElementById('topup-phone-input').value = '';
          toggleTopupForm(false);
          await loadClientFinance();
          return;
        }

        if (window._L) _L.warn('initiate-topup edge fallback:', edgeResult.error);

        // Fallback path if edge function is not deployed yet.
        const invoicePayload = {
          project_id: null,
          created_by: CURRENT_USER.id,
          client_email: CURRENT_USER.email,
          client_name: document.getElementById('sb-name')?.textContent || CURRENT_USER.email,
          description: `Wallet Top-up (${String(provider).toUpperCase()})`,
          amount,
          currency: 'KES',
          status: 'pending',
          notes: phoneOrRef ? `Reference: ${phoneOrRef}` : null
        };

        const { data: fallbackInvoice, error: fallbackError } = await (window.getDbClient ? window.getDbClient() : window.sbClient)
          .from('invoices')
          .insert(invoicePayload)
          .select('*')
          .maybeSingle();

        if (fallbackError) {
          toast(`Top-up request failed: ${clientErrorMessage(fallbackError, 'Unable to submit request')}`);
          return;
        }

        toast('Top-up invoice created. Open Billing and generate a payment link.');

        document.getElementById('topup-amount-input').value = '';
        document.getElementById('topup-phone-input').value = '';
        toggleTopupForm(false);
        await loadClientFinance();
        await loadData();
        if (fallbackInvoice?.id) showPage('billing');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Top-up';
        }
      }
    }

    async function createProjectFromClient() {
      if (!window.sbClient || !CURRENT_USER) return;
      const title = String(document.getElementById('new-project-title')?.value || '').trim();
      const description = String(document.getElementById('new-project-description')?.value || '').trim();
      const budget = Number(document.getElementById('new-project-budget')?.value || 0);
      const status = String(document.getElementById('new-project-status')?.value || 'open').toLowerCase();
      const timeline = String(document.getElementById('new-project-timeline')?.value || '').trim();
      const clientPhone = String(document.getElementById('new-project-phone')?.value || '').trim();
      const salesCtx = getSalesOnboardContext();
      const commissionerId = salesCtx?.salesId || null;
      const submitBtn = document.getElementById('new-project-submit-btn');

      if (!title) {
        toast('Project title is required');
        return;
      }
      if (budget < 0) {
        toast('Budget cannot be negative');
        return;
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
      }

      try {
        const projectPayloads = [
          {
            title,
            description,
            total_value: budget,
            client_id: CURRENT_USER.id,
            status,
            commissioner_id: commissionerId,
            timeline: timeline || null,
            client_phone: clientPhone || null
          },
          {
            title,
            description,
            total_value: budget,
            client_id: CURRENT_USER.id,
            status,
            timeline: timeline || null,
            client_phone: clientPhone || null
          },
          {
            title,
            description,
            total_value: budget,
            client_id: CURRENT_USER.id,
            timeline: timeline || null,
            requirements: clientPhone ? { client_phone: clientPhone } : null
          },
          {
            title,
            description,
            client_id: CURRENT_USER.id,
            requirements: clientPhone ? { client_phone: clientPhone } : null
          }
        ];

        const { error } = await tryInsertVariants('projects', projectPayloads, false);
        if (error) {
          toast(`Failed to create project: ${clientErrorMessage(error, 'Please check your permissions and schema')}`);
          return;
        }

        if (commissionerId) {
          const assignedName = salesCtx?.salesName || salesCtx?.salesEmail || 'your advisor';
          toast(`Project created and assigned to ${assignedName}`);
        } else {
          toast('Project created and sent to sales leads');
        }
        document.getElementById('new-project-title').value = '';
        document.getElementById('new-project-description').value = '';
        document.getElementById('new-project-budget').value = '';
        const timelineInput = document.getElementById('new-project-timeline');
        if (timelineInput) timelineInput.value = '';
        const phoneInput = document.getElementById('new-project-phone');
        if (phoneInput) phoneInput.value = '';
        syncClientGuide(1);
        if (typeof window.closeClientProjectModal === 'function') window.closeClientProjectModal();
        await loadData();
        if (typeof window.showPage === 'function') window.showPage('projects');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Project';
        }
      }
    }

    window.markNotificationRead = async function (id) {
      if (!window.sbClient || !CURRENT_USER || !id) return;
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      let { error } = await sb
        .from('notifications')
        .update({ read_at: new Date().toISOString() })
        .eq('id', id)
        .eq('user_id', CURRENT_USER.id);
      if (error && isMissingColumnError(error, 'read_at')) {
        const legacy = await sb
          .from('notifications')
          .update({ is_read: true })
          .eq('id', id)
          .eq('user_id', CURRENT_USER.id);
        error = legacy.error;
      }
      if (error) {
        toast(clientErrorMessage(error, 'Unable to mark notification as read.'));
        return;
      }
      await loadClientNotifications();
    };

    window.markAllNotificationsRead = async function () {
      if (!window.sbClient || !CURRENT_USER) return;
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      const button = document.getElementById('mark-all-notifications-btn');
      if (button) {
        button.disabled = true;
        button.textContent = 'Marking...';
      }
      try {
        let { error } = await sb
          .from('notifications')
          .update({ read_at: new Date().toISOString() })
          .eq('user_id', CURRENT_USER.id)
          .is('read_at', null);
        if (error && isMissingColumnError(error, 'read_at')) {
          const legacy = await sb
            .from('notifications')
            .update({ is_read: true })
            .eq('user_id', CURRENT_USER.id)
            .eq('is_read', false);
          error = legacy.error;
        }
        if (error) {
          toast(clientErrorMessage(error, 'Unable to mark all notifications.'));
          return;
        }
        toast('All notifications marked as read');
        await loadClientNotifications();
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = 'Mark All Read';
        }
      }
    };

    window.generateInvoicePaymentLink = async function (invoiceId, options = {}) {
      if (!invoiceId || !window.sbClient || !CURRENT_USER) return;
      const invoice = (CLIENT_INVOICES_CACHE || []).find(i => i.id === invoiceId) || null;
      const shouldRedirect = options?.redirect !== false;
      const forceNewRequest = options?.forceNewRequest === true;
      const jwt = await getJwt(true);
      if (!jwt) {
        toast('Secure session not found. Using direct invoice fallback...');
      }
      const payload = {
        invoice_id: invoiceId,
        client_email: CURRENT_USER.email || invoice?.client_email || undefined,
        client_name: invoice?.client_name || undefined,
        amount: invoice?.amount || undefined,
        description: invoice?.description || undefined,
        due_date: invoice?.due_date || undefined,
        notes: invoice?.notes || undefined,
        force_new_request: forceNewRequest,
      };
      const result = await callEdgeFunction('send-invoice', payload, jwt || SUPABASE_ANON);
      if (result?.error) {
        toast(`Could not generate payment link: ${result.error}`);
        return result;
      }
      toast(shouldRedirect ? 'Payment link generated and invoice email sent' : 'Invoice email sent to your registered account');
      if (result.authorization_url && shouldRedirect) {
        window.location.href = result.authorization_url;
        return result;
      }
      await loadData();
      if (!options?.stayOnCurrentPage && typeof window.showPage === 'function') window.showPage('billing');
      if (ACTIVE_PROJECT_DETAIL_ID) {
        const current = findProjectById(ACTIVE_PROJECT_DETAIL_ID);
        if (current) renderProjectDetailModal(current);
      }
      return result;
    };

    window.addPaymentMethod = addPaymentMethod;
    window.topUpWallet = topUpWallet;
    window.createProjectFromClient = createProjectFromClient;

    function syncSupportProjectOptions() {
      const select = document.getElementById('support-project-select');
      if (!select) return;
      const current = select.value;
      const options = (CLIENT_PROJECTS_CACHE || [])
        .map(project => `<option value="${project.id}">${project.title || 'Project'}${project.status ? ` (${project.status})` : ''}</option>`)
        .join('');
      select.innerHTML = `<option value="">General Support</option>${options}`;
      if (current && Array.from(select.options).some(opt => opt.value === current)) {
        select.value = current;
      }
    }

    function humanizeStatus(value) {
      const normalized = String(value || '').replace(/_/g, ' ').trim();
      if (!normalized) return 'pending';
      return normalized.charAt(0).toUpperCase() + normalized.slice(1);
    }

    function findProjectById(projectId) {
      return (CLIENT_PROJECTS_CACHE || []).find(project => project.id === projectId) || null;
    }

    function projectInvoices(projectId) {
      return (CLIENT_INVOICES_CACHE || [])
        .filter(inv => inv.project_id === projectId)
        .sort((a, b) => new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime());
    }

    function latestProjectInvoice(projectId) {
      return projectInvoices(projectId)[0] || null;
    }

    function projectPeopleLabel(project) {
      const commissioner = project?.commissioner
        ? `${project.commissioner.first_name || ''} ${project.commissioner.last_name || ''}`.trim() || project.commissioner.email
        : 'Not assigned';
      const developer = project?.developer
        ? `${project.developer.first_name || ''} ${project.developer.last_name || ''}`.trim() || project.developer.email
        : 'Not assigned';
      return { commissioner, developer };
    }

    function renderProjectDetailModal(project) {
      const detailTitle = document.getElementById('project-detail-title');
      const detailSub = document.getElementById('project-detail-sub');
      const detailGrid = document.getElementById('project-detail-grid');
      const detailDesc = document.getElementById('project-detail-desc');
      const paymentStatus = document.getElementById('project-detail-payment-status');
      if (!project || !detailGrid || !detailDesc) return;

      const { commissioner, developer } = projectPeopleLabel(project);
      const totalValue = Number(project.total_value ?? project.budget ?? 0);
      const invoice = latestProjectInvoice(project.id);
      const invStatus = String(invoice?.status || 'pending').toLowerCase();
      const statusClass = invStatus === 'paid' ? 'b-g' : (invStatus === 'failed' ? 'b-r' : 'b-a');
      const timeline = String(project.timeline || project.due_date || '').trim() || 'Not provided';

      if (detailTitle) detailTitle.textContent = project.title || 'Project Details';
      if (detailSub) detailSub.textContent = `Status: ${humanizeStatus(project.status)} | Value: KSh ${Math.round(totalValue).toLocaleString()}`;
      if (paymentStatus) {
        paymentStatus.className = `badge ${statusClass}`;
        paymentStatus.textContent = humanizeStatus(invStatus);
      }

      detailGrid.innerHTML = `
        <div class="detail-item"><div class="detail-k">Project ID</div><div class="detail-v">${String(project.id || '').slice(0, 12)}</div></div>
        <div class="detail-item"><div class="detail-k">Budget</div><div class="detail-v">KSh ${Math.round(totalValue).toLocaleString()}</div></div>
        <div class="detail-item"><div class="detail-k">Timeline</div><div class="detail-v">${timeline}</div></div>
        <div class="detail-item"><div class="detail-k">Current Status</div><div class="detail-v">${humanizeStatus(project.status)}</div></div>
        <div class="detail-item"><div class="detail-k">Commissioner</div><div class="detail-v">${commissioner}</div></div>
        <div class="detail-item"><div class="detail-k">Developer</div><div class="detail-v">${developer}</div></div>
      `;

      detailDesc.innerHTML = `<strong style="display:block;margin-bottom:5px;color:var(--text-2);">Description</strong>${project.description || 'No description provided yet.'}`;
    }

    async function ensureProjectInvoice(project) {
      if (!project?.id) return { invoice: null, error: 'Project not found' };
      const existing = projectInvoices(project.id);
      const unpaid = existing.find(inv => ['pending', 'sent', 'draft', 'overdue'].includes(String(inv.status || '').toLowerCase()));
      if (unpaid) return { invoice: unpaid, error: null };

      const totalValue = Number(project.total_value ?? project.budget ?? 0);
      if (!Number.isFinite(totalValue) || totalValue <= 0) {
        return { invoice: null, error: 'Project budget is required before invoice generation.' };
      }
      const paidAmount = existing
        .filter(inv => String(inv.status || '').toLowerCase() === 'paid')
        .reduce((sum, inv) => sum + Number(inv.amount || 0), 0);
      const isDeposit = paidAmount <= 0;
      const depositAmount = Math.max(1, Math.round(totalValue * 0.45));
      const remainingAmount = Math.max(0, Math.round(totalValue - paidAmount));
      const targetAmount = isDeposit ? depositAmount : (remainingAmount || depositAmount);
      const invoiceType = isDeposit ? 'deposit' : 'balance';
      const description = isDeposit
        ? `Project Deposit (45%) - ${project.title || 'Project'}`
        : `Project Balance - ${project.title || 'Project'}`;
      const dueDate = new Date(Date.now() + 3 * 86400000).toISOString().slice(0, 10);

      const variants = [
        {
          project_id: project.id,
          client_id: CURRENT_USER.id,
          created_by: CURRENT_USER.id,
          client_email: CURRENT_USER.email,
          client_name: document.getElementById('sb-name')?.textContent || CURRENT_USER.email,
          description,
          amount: targetAmount,
          currency: 'KES',
          status: 'pending',
          invoice_type: invoiceType,
          due_date: dueDate,
          notes: isDeposit ? 'Initial deposit required to start project workflow.' : 'Balance payment request.'
        },
        {
          project_id: project.id,
          client_id: CURRENT_USER.id,
          client_email: CURRENT_USER.email,
          client_name: document.getElementById('sb-name')?.textContent || CURRENT_USER.email,
          description,
          amount: targetAmount,
          currency: 'KES',
          status: 'pending',
          type: invoiceType,
          due_date: dueDate
        },
        {
          project_id: project.id,
          client_email: CURRENT_USER.email,
          description,
          amount: targetAmount,
          status: 'pending'
        }
      ];

      const { data, error } = await tryInsertVariants('invoices', variants, true);
      if (error) {
        return { invoice: null, error: clientErrorMessage(error, 'Unable to create project invoice') };
      }

      let resolved = data || null;
      if (!resolved) {
        const { data: fetchInvoice } = await (window.getDbClient ? window.getDbClient() : window.sbClient)
          .from('invoices')
          .select('*')
          .eq('project_id', project.id)
          .order('created_at', { ascending: false })
          .limit(1)
          .maybeSingle();
        resolved = fetchInvoice || null;
      }

      if (resolved) {
        CLIENT_INVOICES_CACHE = [resolved, ...(CLIENT_INVOICES_CACHE || []).filter(inv => inv.id !== resolved.id)];
      }
      return { invoice: resolved, error: null };
    }

    window.openClientProjectDetails = function (projectId) {
      const project = findProjectById(projectId);
      if (!project) {
        toast('Project details are not available yet.');
        return;
      }
      ACTIVE_PROJECT_DETAIL_ID = project.id;
      renderProjectDetailModal(project);
      const modal = document.getElementById('project-detail-modal');
      if (modal) modal.classList.add('open');
    };

    window.closeClientProjectDetailsModal = function () {
      const modal = document.getElementById('project-detail-modal');
      if (modal) modal.classList.remove('open');
      ACTIVE_PROJECT_DETAIL_ID = null;
    };

    window.payProjectNow = async function () {
      if (!ACTIVE_PROJECT_DETAIL_ID) return;
      const project = findProjectById(ACTIVE_PROJECT_DETAIL_ID);
      if (!project) {
        toast('Project was not found. Refreshing...');
        await loadData();
        return;
      }
      const { invoice, error } = await ensureProjectInvoice(project);
      if (error) {
        toast(error);
        return;
      }
      if (!invoice?.id) {
        toast('Invoice could not be prepared for this project.');
        return;
      }
      await window.generateInvoicePaymentLink(invoice.id, { redirect: true, forceNewRequest: true });
    };

    window.sendProjectInvoiceEmail = async function () {
      if (!ACTIVE_PROJECT_DETAIL_ID) return;
      const project = findProjectById(ACTIVE_PROJECT_DETAIL_ID);
      if (!project) {
        toast('Project was not found. Refreshing...');
        await loadData();
        return;
      }
      const { invoice, error } = await ensureProjectInvoice(project);
      if (error) {
        toast(error);
        return;
      }
      if (!invoice?.id) {
        toast('Invoice could not be prepared for this project.');
        return;
      }
      const result = await window.generateInvoicePaymentLink(invoice.id, { redirect: false, forceNewRequest: true, stayOnCurrentPage: true });
      if (!result?.error) {
        toast('Invoice sent to your registered email successfully.');
      }
    };

    window.verifyProjectPaymentStatus = async function () {
      if (!ACTIVE_PROJECT_DETAIL_ID || !window.sbClient) return;
      const invoice = latestProjectInvoice(ACTIVE_PROJECT_DETAIL_ID);
      if (!invoice?.id) {
        toast('No invoice found for this project yet.');
        return;
      }
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      const { data, error } = await sb.from('invoices').select('*').eq('id', invoice.id).maybeSingle();
      if (error || !data) {
        toast(clientErrorMessage(error, 'Unable to verify payment right now.'));
        return;
      }
      CLIENT_INVOICES_CACHE = [data, ...(CLIENT_INVOICES_CACHE || []).filter(inv => inv.id !== data.id)];
      if (String(data.status || '').toLowerCase() === 'paid') {
        toast('Payment confirmed. Project funding is successful and workflow can continue.');
      } else {
        toast(`Current payment status: ${humanizeStatus(data.status || 'pending')}`);
      }
      renderProjectDetailModal(findProjectById(ACTIVE_PROJECT_DETAIL_ID));
      await loadData();
    };

    window.openClientSupportModal = function () {
      syncSupportProjectOptions();
      const modal = document.getElementById('client-support-modal');
      if (modal) modal.classList.add('open');
    };

    window.closeClientSupportModal = function () {
      const modal = document.getElementById('client-support-modal');
      if (modal) modal.classList.remove('open');
    };

    window.sendClientSupportMessage = async function () {
      if (!window.sbClient || !CURRENT_USER) return;
      const sb = window.getDbClient ? window.getDbClient() : window.sbClient;
      const topic = String(document.getElementById('support-topic')?.value || '').trim();
      const message = String(document.getElementById('support-message')?.value || '').trim();
      const projectId = String(document.getElementById('support-project-select')?.value || '').trim() || null;
      if (!message) {
        toast('Please type your support message first.');
        return;
      }

      const { data: admins, error: adminErr } = await sb
        .from('profiles')
        .select('id, first_name, last_name, email')
        .eq('role', 'admin')
        .limit(5);
      if (adminErr || !admins?.length) {
        toast(clientErrorMessage(adminErr, 'No admin support account available.'));
        return;
      }

      const project = projectId ? findProjectById(projectId) : null;
      const contextParts = [];
      if (topic) contextParts.push(`Topic: ${topic}`);
      if (project?.title) contextParts.push(`Project: ${project.title}`);
      const supportBody = `[SUPPORT] ${contextParts.join(' | ') || 'General'}\n${message}`;

      const rows = admins.map(admin => ({
        sender_id: CURRENT_USER.id,
        receiver_id: admin.id,
        project_id: projectId,
        content: supportBody,
        is_read: false
      }));
      const { error } = await sb.from('messages').insert(rows);
      if (error) {
        toast(clientErrorMessage(error, 'Could not send support request.'));
        return;
      }

      const notificationRows = admins.map(admin => ({
        user_id: admin.id,
        type: 'support_message',
        title: 'Client support request',
        content: supportBody.slice(0, 220),
        payload: { from_client_id: CURRENT_USER.id, project_id: projectId, topic: topic || null },
        is_read: false
      }));
      await sb.from('notifications').insert(notificationRows);

      document.getElementById('support-topic').value = '';
      document.getElementById('support-message').value = '';
      if (document.getElementById('support-project-select')) document.getElementById('support-project-select').value = '';
      if (typeof window.closeClientSupportModal === 'function') window.closeClientSupportModal();
      toast('Support request sent to admin.');
      const primaryAdmin = admins[0];
      if (primaryAdmin?.id) {
        const adminName = `${primaryAdmin.first_name || ''} ${primaryAdmin.last_name || ''}`.trim() || primaryAdmin.email || 'Admin';
        if (typeof window.openClientThread === 'function') {
          await window.openClientThread(primaryAdmin.id, adminName);
        }
      }
      await loadClientMessageThreads();
    };

    window.openClientSupportOverlay = function () {
      const overlay = document.getElementById('client-support-overlay');
      if (overlay) overlay.classList.add('open');
    };

    window.closeClientSupportOverlay = function () {
      const overlay = document.getElementById('client-support-overlay');
      if (overlay) overlay.classList.remove('open');
    };

    window.openSupportWhatsApp = function () {
      const msg = encodeURIComponent('Hello CODESTUDIO.KENYA support, I need help with my project.');
      window.open(`https://wa.me/254793832286?text=${msg}`, '_blank', 'noopener');
    };

    window.copyClientSupportEmail = async function () {
      const email = 'creative.keagency254@gmail.com';
      try {
        await navigator.clipboard.writeText(email);
        toast('Support email copied.');
      } catch (_) {
        toast(`Copy failed. Use: ${email}`);
      }
    };

    window.showModal = function (name) {
      if (name === 'new-project') openClientProjectModal();
    }

    window.jumpToEscrowTeam = function () {
      if (typeof window.showPage === 'function') window.showPage('dashboard');
      setTimeout(() => {
        const anchor = document.getElementById('escrow-team-anchor');
        if (anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 80);
    };

    window.skipClientGuide = function () {
      localStorage.setItem(CLIENT_GUIDE_KEY, '1');
      syncClientGuide(1);
    };

    window.openClientGuideProject = function () {
      localStorage.setItem(CLIENT_GUIDE_KEY, '1');
      syncClientGuide(1);
      openClientProjectModal();
    };

    // Page Navigation
    window.showPage = function (page) {
      const titles = {
        dashboard: ['Welcome back', 'Live project summary'],
        projects: ['My Projects', 'Manage your active projects'],
        escrow: ['Escrow Funds', 'Secured project payments'],
        messages: ['Messages', 'Your project communication'],
        notifications: ['Notifications', 'Stay updated on progress'],
        billing: ['Billing & Invoices', 'Pay and manage project funds'],
        profile: ['Profile Settings', 'Update your details'],
      };

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));

      const pg = document.getElementById('page-' + page);
      if (pg) pg.classList.add('active');

      const navEl = document.querySelector(`.ni[data-page="${page}"]`);
      if (navEl) navEl.classList.add('active');

      const t = titles[page] || [page, ''];
      document.getElementById('topbar-title').textContent = t[0];
      document.getElementById('topbar-sub').textContent = t[1];
      if (page === 'messages') {
        loadClientMessageThreads();
      }
      if (page === 'notifications') {
        loadClientNotifications();
      }
      if (page === 'billing') {
        renderBillingInvoiceSummary(CLIENT_INVOICES_CACHE || []);
      }
    }

    // Theme toggle
    function normalizeSurfaceTheme(theme) {
      const raw = String(theme || '').toLowerCase();
      if (raw === 'grid' || raw === 'metal') return 'grid';
      return 'glass';
    }

    function syncSurfaceThemeUI(theme) {
      const normalized = normalizeSurfaceTheme(theme);
      const glassBtn = document.getElementById('surface-opt-glass');
      const metalBtn = document.getElementById('surface-opt-metal');
      if (glassBtn) glassBtn.classList.toggle('active', normalized === 'glass');
      if (metalBtn) metalBtn.classList.toggle('active', normalized === 'grid');
    }

    function normalizeCardFxTheme(theme) {
      const allowed = new Set([
        'gradient-flow',
        'glass-reflection',
        'floating-blobs',
        'particle-network',
        'moving-grid',
        'animated-waves',
        'parallax-layers',
        'glow-pulse',
        'diagonal-sweep',
        'noise-grain'
      ]);
      return allowed.has(theme) ? theme : 'glass-reflection';
    }

    function syncCardFxUI(theme) {
      const select = document.getElementById('cardfx-select');
      if (select) select.value = normalizeCardFxTheme(theme);
    }

    window.setCardFxTheme = function (theme) {
      const normalized = normalizeCardFxTheme(theme);
      document.documentElement.setAttribute('data-cardfx', normalized);
      localStorage.setItem('clientCardFxTheme', normalized);
      syncCardFxUI(normalized);
    };

    window.setSurfaceTheme = function (theme) {
      const normalized = normalizeSurfaceTheme(theme);
      document.documentElement.setAttribute('data-surface', normalized);
      localStorage.setItem('surfaceTheme', normalized);
      syncSurfaceThemeUI(normalized);
    };

    window.toggleTheme = function () {
      const h = document.documentElement;
      const current = h.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      h.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);

      const sw = document.getElementById('theme-sw');
      const lbl = document.getElementById('theme-lbl');
      if (sw) sw.classList.toggle('on', next === 'light');
      if (lbl) lbl.textContent = next === 'dark' ? 'Dark Mode' : 'Light Mode';
    }

    // Profile management
    window.handleAvatarUpload = async function (event) {
      if (!window.sbClient || !CURRENT_USER) return;
      const file = event?.target?.files?.[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) {
        toast('Image is too large. Maximum size is 5MB.');
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = String(reader.result || '');
        ['profile-av-img', 'sb-av-img'].forEach(id => {
          const img = document.getElementById(id);
          if (img) {
            img.src = dataUrl;
            img.style.display = 'block';
          }
        });
        const initialsA = document.getElementById('profile-initials');
        if (initialsA) initialsA.style.display = 'none';
        const initialsB = document.getElementById('sb-initials');
        if (initialsB) initialsB.style.display = 'none';
      };
      reader.readAsDataURL(file);

      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
      const objectPath = `${CURRENT_USER.id}/${Date.now()}_${safeName}`;
      const { error: uploadErr } = await window.sbClient
        .storage
        .from('avatars')
        .upload(objectPath, file, { upsert: true, cacheControl: '3600' });

      if (uploadErr) {
        toast('Avatar preview updated. Storage upload failed.');
        return;
      }

      const { data: pub } = window.sbClient.storage.from('avatars').getPublicUrl(objectPath);
      const avatarUrl = pub?.publicUrl || '';
      if (!avatarUrl) return;

      const ok = await persistAvatarUrl(avatarUrl);
      if (ok) toast('Profile photo updated');
    }

    window.selectAvatarPreset = async function (avatarUrl) {
      if (!avatarUrl) return;
      const ok = await persistAvatarUrl(avatarUrl);
      if (ok) toast('Avatar preset applied');
    };

    window.applyAvatarUrl = async function () {
      const input = document.getElementById('avatar-url-input');
      const value = String(input?.value || '').trim();
      if (!value) {
        toast('Enter an avatar URL first');
        return;
      }
      if (!/^https?:\/\//i.test(value)) {
        toast('Avatar URL must start with http:// or https://');
        return;
      }
      const ok = await persistAvatarUrl(value);
      if (ok) toast('Avatar URL applied');
    };

    window.saveProfile = async function () {
      if (!window.sbClient || !CURRENT_USER) return;
      const base = {
        first_name: String(document.getElementById('f-fname')?.value || '').trim(),
        last_name: String(document.getElementById('f-lname')?.value || '').trim(),
        updated_at: new Date().toISOString()
      };
      const phone = String(document.getElementById('f-phone')?.value || '').trim();
      const company = String(document.getElementById('f-company')?.value || '').trim();

      const { error: saveError } = await safeProfileUpdate(
        { ...base, phone, company },
        [{ ...base, phone }, { ...base, company }, base]
      );
      if (saveError) {
        toast(`Error saving profile: ${clientErrorMessage(saveError, 'Unable to save profile')}`);
        if (window._L) _L.warn('Profile save error:', saveError);
        return;
      }
      const authName = String(CURRENT_USER?.user_metadata?.full_name || CURRENT_USER?.user_metadata?.name || '').trim();
      const fullName = `${base.first_name || ''} ${base.last_name || ''}`.trim() || authName || CURRENT_USER.email;
      const sbName = document.getElementById('sb-name');
      if (sbName) sbName.textContent = fullName;
      const initials = `${(base.first_name || '')[0] || ''}${(base.last_name || '')[0] || ''}`.toUpperCase() || 'U';
      const sbInitials = document.getElementById('sb-initials');
      const profileInitials = document.getElementById('profile-initials');
      if (sbInitials) sbInitials.textContent = initials;
      if (profileInitials) profileInitials.textContent = initials;
      toast('Profile updated');
    }

    window.updateAccountSecurity = async function () {
      if (!window.sbClient || !CURRENT_USER) return;
      const currentPass = String(document.getElementById('sec-current-pass')?.value || '');
      const newPass = String(document.getElementById('sec-new-pass')?.value || '');
      const confirmPass = String(document.getElementById('sec-confirm-pass')?.value || '');

      if (!currentPass || !newPass || !confirmPass) {
        toast('Fill all password fields');
        return;
      }
      if (newPass.length < 8) {
        toast('New password must be at least 8 characters');
        return;
      }
      if (newPass !== confirmPass) {
        toast('New password and confirmation do not match');
        return;
      }

      const { error: verifyError } = await window.sbClient.auth.signInWithPassword({
        email: CURRENT_USER.email,
        password: currentPass
      });
      if (verifyError) {
        toast('Current password is incorrect');
        return;
      }

      const { error: updateErr } = await window.sbClient.auth.updateUser({ password: newPass });
      if (updateErr) {
        toast(`Password update failed: ${clientErrorMessage(updateErr, 'Try signing in again and retry.')}`);
        return;
      }

      document.getElementById('sec-current-pass').value = '';
      document.getElementById('sec-new-pass').value = '';
      document.getElementById('sec-confirm-pass').value = '';
      toast('Password updated successfully');
    };

    window.toast = msg => window.showToast ? window.showToast(msg) : alert(msg);

    function resetClientDashboardPlaceholders() {
      if (document.getElementById('s-escrow')) document.getElementById('s-escrow').textContent = 'KSh 0';
      if (document.getElementById('s-proj')) document.getElementById('s-proj').textContent = '0';
      if (document.getElementById('s-ms')) document.getElementById('s-ms').textContent = '0/0';
      if (document.getElementById('s-msg')) document.getElementById('s-msg').textContent = '0';
      if (document.getElementById('nav-proj-count')) document.getElementById('nav-proj-count').textContent = '0';
      if (document.getElementById('nav-msg-count')) document.getElementById('nav-msg-count').textContent = '0';
      if (document.getElementById('nav-notif-count')) document.getElementById('nav-notif-count').textContent = '0';
      if (document.getElementById('escrow-held-val')) document.getElementById('escrow-held-val').textContent = 'KSh 0';
      if (document.getElementById('escrow-released-val')) document.getElementById('escrow-released-val').textContent = 'KSh 0';
      if (document.getElementById('escrow-pending-val')) document.getElementById('escrow-pending-val').textContent = 'KSh 0';
      if (document.getElementById('escrow-total-val')) document.getElementById('escrow-total-val').textContent = 'KSh 0';
      if (document.getElementById('escrow-ring-total')) document.getElementById('escrow-ring-total').textContent = 'KSh 0';
      if (document.getElementById('escrow-legend-released')) document.getElementById('escrow-legend-released').textContent = 'KSh 0';
      if (document.getElementById('escrow-legend-held')) document.getElementById('escrow-legend-held').textContent = 'KSh 0';
      if (document.getElementById('escrow-legend-pending')) document.getElementById('escrow-legend-pending').textContent = 'KSh 0';
      const billingStats = document.getElementById('billing-invoice-stats');
      if (billingStats) billingStats.textContent = 'No invoices available for this account yet.';
      const billingList = document.getElementById('billing-invoice-list');
      if (billingList) billingList.innerHTML = '<div class="loading-text" style="padding:12px;text-align:center;color:var(--text-5);">No invoices yet.</div>';
      const dp = document.getElementById('dash-projects');
      if (dp) dp.innerHTML = '<div class="loading-text">Loading projects...</div>';
      const ms = document.getElementById('dash-milestones');
      if (ms) ms.innerHTML = '<div class="loading-text" style="padding:20px;text-align:center;color:var(--text-5);">No milestones yet. Milestone activity will appear here.</div>';
      const dm = document.getElementById('dash-messages');
      if (dm) dm.innerHTML = '<div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">No messages yet. Conversations will appear here.</div>';
      const activityNote = document.getElementById('escrow-activity-note');
      if (activityNote) activityNote.textContent = 'Loading escrow activity...';
      setClientChatIdle('Click a message to open it');
      ensureClientDashboardSectionsVisible();
    }

    function ensureClientDashboardSectionsVisible() {
      const dashProjects = document.getElementById('dash-projects');
      if (dashProjects && !dashProjects.textContent.trim()) {
        dashProjects.innerHTML = '<div class="loading-text" style="padding:14px;text-align:center;color:var(--text-5);">No projects yet. New projects will appear here.</div>';
      }

      const dashMilestones = document.getElementById('dash-milestones');
      if (dashMilestones && !dashMilestones.textContent.trim()) {
        dashMilestones.innerHTML = '<div class="loading-text" style="padding:20px; text-align:center; color:var(--text-5);">No milestones yet. Milestone activity will appear here.</div>';
      }

      const dashMessages = document.getElementById('dash-messages');
      if (dashMessages && !dashMessages.textContent.trim()) {
        dashMessages.innerHTML = '<div class="loading-text" style="padding:16px;text-align:center;color:var(--text-5);">No messages yet. Conversations will appear here.</div>';
      }

      const escrowNote = document.getElementById('escrow-activity-note');
      if (escrowNote && !escrowNote.textContent.trim()) {
        escrowNote.textContent = 'No escrow activity yet.';
      }

      const requiredStats = ['s-escrow', 's-proj', 's-ms', 's-msg'];
      requiredStats.forEach((id) => {
        const el = document.getElementById(id);
        if (el && !el.textContent.trim()) {
          el.textContent = id === 's-ms' ? '0/0' : (id === 's-escrow' ? 'KSh 0' : '0');
        }
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      resetClientDashboardPlaceholders();
      renderAvatarPresets();
      setDbStatus('connecting', 'Connecting to Supabase...');
      if (typeof window.showPage === 'function') window.showPage('dashboard');
      initSupabase();
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const savedSurface = normalizeSurfaceTheme(localStorage.getItem('surfaceTheme') || 'glass');
      document.documentElement.setAttribute('data-surface', savedSurface);
      syncSurfaceThemeUI(savedSurface);
      localStorage.removeItem('clientCardFxTheme');
      const sw = document.getElementById('theme-sw');
      const lbl = document.getElementById('theme-lbl');
      if (sw) sw.classList.toggle('on', savedTheme === 'light');
      if (lbl) lbl.textContent = savedTheme === 'dark' ? 'Dark Mode' : 'Light Mode';

      const pmProvider = document.getElementById('pm-provider-input');
      const pmLabel = document.getElementById('pm-label-input');
      if (pmProvider && pmLabel) {
        pmProvider.addEventListener('change', () => {
          if (pmLabel.value.trim()) return;
          const defaults = {
            mpesa: 'Safaricom M-Pesa',
            paystack: 'Paystack',
            card: 'Primary Card',
            bank: 'Primary Bank',
            other: 'Payment Method'
          };
          pmLabel.value = defaults[pmProvider.value] || 'Payment Method';
        });
        pmProvider.dispatchEvent(new Event('change'));
      }

      const topupProvider = document.getElementById('topup-provider-input');
      const topupRef = document.getElementById('topup-phone-input');
      if (topupProvider && topupRef) {
        const syncTopupPlaceholder = () => {
          topupRef.placeholder = topupProvider.value === 'mpesa' ? '07XXXXXXXX' : 'Reference (optional)';
        };
        topupProvider.addEventListener('change', syncTopupPlaceholder);
        syncTopupPlaceholder();
      }
    });

    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return;
      const modal = document.getElementById('project-modal');
      if (modal?.classList.contains('open')) {
        if (typeof window.closeClientProjectModal === 'function') window.closeClientProjectModal();
        return;
      }
      const detailModal = document.getElementById('project-detail-modal');
      if (detailModal?.classList.contains('open')) {
        if (typeof window.closeClientProjectDetailsModal === 'function') window.closeClientProjectDetailsModal();
        return;
      }
      const supportModal = document.getElementById('client-support-modal');
      if (supportModal?.classList.contains('open')) {
        if (typeof window.closeClientSupportModal === 'function') window.closeClientSupportModal();
        return;
      }
      const supportOverlay = document.getElementById('client-support-overlay');
      if (supportOverlay?.classList.contains('open')) {
        if (typeof window.closeClientSupportOverlay === 'function') window.closeClientSupportOverlay();
      }
    });

    window.addEventListener('beforeunload', () => {
      if (CLIENT_CHAT_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_CHAT_CHANNEL);
      }
      if (CLIENT_MESSAGES_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_MESSAGES_CHANNEL);
      }
      if (CLIENT_INVOICES_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_INVOICES_CHANNEL);
      }
      if (CLIENT_TOPUPS_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_TOPUPS_CHANNEL);
      }
      if (CLIENT_NOTIFICATIONS_CHANNEL && window.sbClient) {
        window.sbClient.removeChannel(CLIENT_NOTIFICATIONS_CHANNEL);
      }
      if (CLIENT_FINANCE_RT_TIMER) {
        clearTimeout(CLIENT_FINANCE_RT_TIMER);
      }
      if (CLIENT_MESSAGES_RT_TIMER) {
        clearTimeout(CLIENT_MESSAGES_RT_TIMER);
      }
    });

    // Sidebar Toggle
    (function () {
      function toggleSidebar() {
        if (window.innerWidth <= 900) {
          document.querySelector('.sidebar').classList.toggle('mob-open');
          document.getElementById('sb-backdrop')?.classList.toggle('open');
        } else {
          document.body.classList.toggle('sb-collapsed');
        }
      }
      window.injectToggle = function () {
        const topbar = document.querySelector('.topbar');
        if (!topbar || document.getElementById('sb-toggle-btn')) return;
        const btn = document.createElement('button');
        btn.id = 'sb-toggle-btn'; btn.className = 'sb-toggle';
        btn.innerHTML = '<span class="sb-toggle-bar"></span><span class="sb-toggle-bar"></span><span class="sb-toggle-bar"></span>';
        btn.onclick = toggleSidebar;
        topbar.insertBefore(btn, topbar.firstChild);
      }
      document.addEventListener('DOMContentLoaded', injectToggle);
    })();
  </script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script>
    // Keep dashboard core sections always visible; do not animate/hide with AOS.
  </script>
  <script src="broadcast-banner.js"></script>
</body>

</html>
