<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - CODE STUDIO ke</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script>
    if (window.protectDashboard) protectDashboard();
  </script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --black: #000;
      --b1: #0A0A0A;
      --b2: #111;
      --b3: #1A1A1A;
      --b4: #242424;
      --b5: #2E2E2E;
      --w: #fff;
      --s1: #F8F8F8;
      --s2: #E4E4E4;
      --s3: #C0C0C0;
      --s4: #909090;
      --s5: #606060;
      --s6: #3A3A3A;
      --bd0: rgba(255, 255, 255, 0.04);
      --bd1: rgba(255, 255, 255, 0.08);
      --bd2: rgba(255, 255, 255, 0.14);
      --bd3: rgba(255, 255, 255, 0.24);
      --green: #22C55E;
      --gbg: rgba(34, 197, 94, .09);
      --gbdr: rgba(34, 197, 94, .2);
      --amber: #EAB308;
      --abg: rgba(234, 179, 8, .09);
      --abdr: rgba(234, 179, 8, .2);
      --red: #EF4444;
      --rbg: rgba(239, 68, 68, .09);
      --rbdr: rgba(239, 68, 68, .2);
      --blue: #60A5FA;
      --bbg: rgba(96, 165, 250, .09);
      --bbdr: rgba(96, 165, 250, .2);
      --purple: #A78BFA;
      --pbg: rgba(167, 139, 250, .09);
      --pbdr: rgba(167, 139, 250, .2);
      --r4: 4px;
      --r8: 8px;
      --r12: 12px;
      --r16: 16px;
      --r20: 20px;
      --rpill: 9999px;
    }

    html.light {
      --black: #f0f0f0;
      --b1: #f4f4f4;
      --b2: #ffffff;
      --b3: #ebebeb;
      --b4: #e2e2e2;
      --b5: #d6d6d6;
      --w: #0f0f0f;
      --s1: #111;
      --s2: #222;
      --s3: #444;
      --s4: #666;
      --s5: #999;
      --s6: #bbb;
      --bd0: rgba(0, 0, 0, 0.04);
      --bd1: rgba(0, 0, 0, 0.10);
      --bd2: rgba(0, 0, 0, 0.18);
      --bd3: rgba(0, 0, 0, 0.32);
      --green: #16a34a;
      --gbg: rgba(22, 163, 74, .10);
      --gbdr: rgba(22, 163, 74, .28);
      --amber: #b45309;
      --abg: rgba(180, 83, 9, .10);
      --abdr: rgba(180, 83, 9, .28);
      --red: #dc2626;
      --rbg: rgba(220, 38, 38, .10);
      --rbdr: rgba(220, 38, 38, .28);
      --blue: #1d4ed8;
      --bbg: rgba(29, 78, 216, .10);
      --bbdr: rgba(29, 78, 216, .28);
      --purple: #6d28d9;
      --pbg: rgba(109, 40, 217, .10);
      --pbdr: rgba(109, 40, 217, .28);
    }

    html.light body {
      background: #f4f4f4;
      color: #222;
    }

    html.light .sidebar {
      background: #fff;
      border-right-color: rgba(0, 0, 0, 0.10);
    }

    html.light .logo-name {
      color: #111;
    }

    html.light .logo-name em {
      color: #aaa;
    }

    html.light .sb-user {
      background: #f4f4f4;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .sb-uname {
      color: #111;
    }

    html.light .ni {
      color: #888;
    }

    html.light .ni.on {
      background: #ebebeb;
      border-color: rgba(0, 0, 0, 0.12);
      color: #111;
    }

    html.light .ni:hover {
      background: #ebebeb;
      color: #333;
    }

    html.light .nav-sec {
      color: #bbb;
    }

    html.light .topbar {
      background: #fff;
      border-bottom-color: rgba(0, 0, 0, 0.08);
    }

    html.light .pg-title {
      color: #111;
    }

    html.light .pg-sub {
      color: #888;
    }

    html.light .card {
      background: #fff;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .card:hover {
      border-color: rgba(0, 0, 0, 0.18);
    }

    html.light .sc {
      background: #fff;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .sc:hover {
      background: #f9f9f9;
    }

    html.light .sc-val {
      color: #111;
    }

    html.light .sc-lbl {
      color: #888;
    }

    html.light .sc-icon {
      background: #f0f0f0;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .tbl tr:hover td {
      background: rgba(0, 0, 0, 0.025);
    }

    html.light .tbl th {
      color: #aaa;
      border-bottom-color: rgba(0, 0, 0, 0.08);
    }

    html.light .tbl td {
      color: #333;
      border-bottom-color: rgba(0, 0, 0, 0.04);
    }

    html.light .inp {
      background: #f5f5f5;
      border-color: rgba(0, 0, 0, 0.14);
      color: #111;
    }

    html.light .inp:focus {
      border-color: rgba(0, 0, 0, 0.3);
    }

    html.light .search-inp {
      background: #f5f5f5;
      border-color: rgba(0, 0, 0, 0.14);
      color: #111;
    }

    html.light .search-wrap svg {
      color: #aaa;
    }

    html.light .modal {
      background: #fff;
      border-color: rgba(0, 0, 0, 0.18);
    }

    html.light .modal-title {
      color: #111;
    }

    html.light .modal-close {
      background: #f0f0f0;
      border-color: rgba(0, 0, 0, 0.12);
      color: #666;
    }

    html.light .dp-card {
      background: #f8f8f8;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .dp-card.dp-high {
      background: rgba(220, 38, 38, .07);
    }

    html.light .dp-title {
      color: #111;
    }

    html.light .dp-meta {
      color: #888;
    }

    html.light .resolve-opt {
      border-color: rgba(0, 0, 0, 0.12);
    }

    html.light .resolve-opt:hover {
      background: #f5f5f5;
    }

    html.light .resolve-opt-title {
      color: #111;
    }

    html.light .resolve-opt-sub {
      color: #888;
    }

    html.light .pbg {
      background: #ddd;
    }

    html.light .pf {
      background: #555;
    }

    html.light .so-btn {
      color: #999;
    }

    html.light .so-btn:hover {
      color: var(--red);
      background: var(--rbg);
    }

    html.light .sb-foot {
      border-top-color: rgba(0, 0, 0, 0.08);
    }

    html.light .live-dot {
      background: var(--green);
      box-shadow: 0 0 6px rgba(22, 163, 74, .5);
    }

    html.light .toggle {
      background: #ccc;
      border-color: #bbb;
    }

    html.light .toggle.on {
      background: var(--green);
    }

    html.light .b-w {
      background: #ebebeb;
      color: #444;
      border-color: rgba(0, 0, 0, 0.14);
    }

    html.light .ms-row-sub {
      background: #f0f0f0;
    }

    html.light .audit-row {
      border-color: rgba(0, 0, 0, 0.06);
    }

    html.light .act {
      border-color: rgba(0, 0, 0, 0.06);
    }

    html.light .act-txt {
      color: #666;
    }

    html.light .act-txt strong {
      color: #111;
    }

    html.light .act-time {
      color: #aaa;
    }

    html.light .hlth-lbl {
      color: #666;
    }

    html.light .card-title {
      color: #333;
    }

    html.light .card-link {
      color: #999;
    }

    html.light .card-link:hover {
      color: #333;
    }

    html.light .sl {
      color: #bbb;
    }

    html.light .toast {
      background: #111;
      color: #fff;
    }

    html.light .btn-g {
      background: transparent;
      border-color: rgba(0, 0, 0, 0.16);
      color: #555;
    }

    html.light .btn-g:hover {
      background: #ebebeb;
      color: #111;
      border-color: rgba(0, 0, 0, 0.2);
    }

    html.light .nc {
      background: #e8e8e8;
      color: #888;
      border-color: rgba(0, 0, 0, 0.08);
    }

    html.light select.inp option {
      background: #fff;
      color: #111;
    }

    html.light .setting-lbl {
      color: #222;
    }

    html.light .setting-sub {
      color: #888;
    }

    html.light .setting-row {
      border-bottom-color: rgba(0, 0, 0, 0.06);
    }

    html.light .vault-title {
      color: #111;
    }

    html.light .vault-meta {
      color: #888;
    }

    html.light .vault-row {
      border-bottom-color: rgba(0, 0, 0, 0.06);
    }

    html.light .tab {
      color: #888;
    }

    html.light .tab.on {
      background: #e8e8e8;
      color: #111;
      border-color: rgba(0, 0, 0, 0.12);
    }

    html.light .tab-row {
      background: #f4f4f4;
      border-color: rgba(0, 0, 0, 0.10);
    }

    html.light .audit-time {
      color: #aaa;
    }

    html.light .empty {
      color: #aaa;
    }

    html.light .uname {
      color: #111;
    }

    .theme-pill {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 11px;
      border-radius: var(--rpill);
      border: 1px solid var(--bd1);
      background: var(--b3);
      cursor: pointer;
      transition: all .15s;
      user-select: none;
    }

    .theme-pill:hover {
      border-color: var(--bd2);
    }

    .theme-pill-lbl {
      font-size: 11.5px;
      font-weight: 600;
      color: var(--s4);
    }

    html.light .theme-pill {
      background: #ebebeb;
      border-color: rgba(0, 0, 0, 0.12);
    }

    html.light .theme-pill-lbl {
      color: #666;
    }

    html {
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--b1);
      color: var(--s2);
      display: flex;
      gap: 0;
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--b5);
      border-radius: var(--rpill);
    }

    /*  Sidebar  */
    .sidebar {
      width: 214px;
      min-width: 214px;
      background: var(--black);
      border-right: 1px solid var(--bd1);
      display: flex;
      flex-direction: column;
      padding: 16px 11px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 3px 6px;
      margin-bottom: 20px;
    }

    .logo-mark {
      width: 28px;
      height: 28px;
      background: var(--w);
      border-radius: var(--r8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      color: var(--black);
    }

    .logo-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--w);
    }

    .logo-name em {
      font-style: normal;
      color: var(--s5);
    }

    .sb-user {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 9px;
      border-radius: var(--r8);
      border: 1px solid var(--bd1);
      background: var(--b2);
      margin-bottom: 16px;
      cursor: pointer;
      transition: border-color .15s;
    }

    .sb-user:hover {
      border-color: var(--bd2);
    }

    .av {
      width: 32px;
      height: 32px;
      border-radius: var(--r8);
      flex-shrink: 0;
      overflow: hidden;
      background: var(--b4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--s3);
      border: 1px solid var(--bd1);
      position: relative;
    }

    .av img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .av-lg {
      width: 42px;
      height: 42px;
      border-radius: var(--r12);
      font-size: 16px;
    }

    .sb-uname {
      font-size: 12px;
      font-weight: 600;
      color: var(--s1);
    }

    .sb-urole {
      font-size: 9.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--red);
      margin-top: 1px;
    }

    .nav-sec {
      font-size: 9px;
      font-weight: 800;
      letter-spacing: .13em;
      text-transform: uppercase;
      color: var(--s6);
      padding: 0 7px;
      margin: 12px 0 4px;
    }

    .ni {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6.5px 8px;
      border-radius: var(--r8);
      color: var(--s5);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      border: 1px solid transparent;
      margin-bottom: 1px;
      user-select: none;
    }

    .ni:hover {
      color: var(--s2);
      background: var(--b3);
    }

    .ni.on {
      color: var(--w);
      background: var(--b3);
      border-color: var(--bd1);
    }

    .ni svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
    }

    .nc {
      margin-left: auto;
      font-size: 9px;
      font-weight: 800;
      color: var(--s5);
      background: var(--b4);
      padding: 1px 6px;
      border-radius: var(--rpill);
      border: 1px solid var(--bd0);
    }

    .nc-r {
      color: var(--w);
      background: var(--red);
      border-color: var(--red);
    }

    .nc-a {
      color: var(--amber);
      background: var(--abg);
      border-color: var(--abdr);
    }

    .sb-foot {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid var(--bd0);
    }

    .so-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6.5px 8px;
      border-radius: var(--r8);
      color: var(--s6);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all .15s;
      background: none;
      border: none;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
    }

    .so-btn:hover {
      color: var(--red);
      background: var(--rbg);
    }

    /*  Main  */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 10px;
      border-bottom: 1px solid var(--bd0);
      background: var(--b1);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .pg-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--w);
    }

    .pg-sub {
      font-size: 11px;
      color: var(--s5);
      margin-top: 1px;
    }

    .tb-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .content {
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }

    /*  Buttons  */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: 'DM Sans', sans-serif;
      font-size: 12.5px;
      font-weight: 600;
      padding: 7px 13px;
      border-radius: var(--r8);
      cursor: pointer;
      transition: all .15s;
      border: none;
      white-space: nowrap;
    }

    .btn svg {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    .btn-w {
      background: var(--w);
      color: var(--black);
    }

    .btn-w:hover {
      background: var(--s2);
    }

    .btn-g {
      background: transparent;
      border: 1px solid var(--bd1);
      color: var(--s3);
    }

    .btn-g:hover {
      border-color: var(--bd2);
      color: var(--w);
      background: var(--b3);
    }

    .btn-r {
      background: var(--rbg);
      border: 1px solid var(--rbdr);
      color: var(--red);
    }

    .btn-r:hover {
      background: rgba(239, 68, 68, .18);
    }

    .btn-gr {
      background: var(--gbg);
      border: 1px solid var(--gbdr);
      color: var(--green);
    }

    .btn-gr:hover {
      background: rgba(34, 197, 94, .16);
    }

    .btn-a {
      background: var(--abg);
      border: 1px solid var(--abdr);
      color: var(--amber);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11.5px;
    }

    .btn-xs {
      padding: 2px 8px;
      font-size: 11px;
    }

    /*  Cards & Layout  */
    .card {
      background: var(--b2);
      border: 1px solid var(--bd1);
      border-radius: var(--r16);
      padding: 18px;
      transition: border-color .2s;
    }

    .card:hover {
      border-color: var(--bd2);
    }

    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 12.5px;
      font-weight: 700;
      color: var(--s2);
      letter-spacing: -.01em;
    }

    .card-link {
      font-size: 11.5px;
      color: var(--s5);
      cursor: pointer;
      transition: color .15s;
    }

    .card-link:hover {
      color: var(--s2);
    }

    .sc {
      background: var(--b2);
      border: 1px solid var(--bd1);
      border-radius: var(--r16);
      padding: 16px 18px;
      transition: all .2s;
    }

    .sc:hover {
      border-color: var(--bd2);
      background: var(--b3);
    }

    .sc-icon {
      width: 28px;
      height: 28px;
      border-radius: var(--r8);
      background: var(--b4);
      border: 1px solid var(--bd1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 11px;
      color: var(--s4);
    }

    .sc-icon svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      stroke: currentColor;
      fill: none;
      stroke-width: 1.8;
    }

    .sc-val {
      font-family: 'DM Mono', monospace;
      font-size: 20px;
      font-weight: 500;
      color: var(--w);
      letter-spacing: -.03em;
      margin-bottom: 2px;
    }

    .sc-lbl {
      font-size: 11px;
      color: var(--s5);
      font-weight: 500;
    }

    .sc-d {
      font-size: 11px;
      margin-top: 5px;
    }

    .up {
      color: var(--green);
    }

    .dn {
      color: var(--red);
    }

    .neu {
      color: var(--s5);
    }

    /*  Grid layouts  */
    .g5 {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 18px;
    }

    .g3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 13px;
      margin-bottom: 18px;
    }

    .g2l {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 13px;
      margin-bottom: 18px;
    }

    .g2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 13px;
      margin-bottom: 18px;
    }

    /*  Badges  */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--rpill);
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    .b-g {
      background: var(--gbg);
      color: var(--green);
      border: 1px solid var(--gbdr);
    }

    .b-a {
      background: var(--abg);
      color: var(--amber);
      border: 1px solid var(--abdr);
    }

    .b-r {
      background: var(--rbg);
      color: var(--red);
      border: 1px solid var(--rbdr);
    }

    .b-b {
      background: var(--bbg);
      color: var(--blue);
      border: 1px solid var(--bbdr);
    }

    .b-w {
      background: var(--b4);
      color: var(--s2);
      border: 1px solid var(--bd1);
    }

    .b-p {
      background: var(--pbg);
      color: var(--purple);
      border: 1px solid var(--pbdr);
    }

    /*  Table  */
    .tbl {
      width: 100%;
      border-collapse: collapse;
    }

    .tbl th {
      text-align: left;
      padding: 0 10px 9px;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--s6);
      border-bottom: 1px solid var(--bd1);
    }

    .tbl td {
      padding: 9px 10px;
      font-size: 12.5px;
      border-bottom: 1px solid var(--bd0);
      vertical-align: middle;
      color: var(--s2);
    }

    .tbl tr:last-child td {
      border-bottom: none;
    }

    .tbl tbody tr:hover td {
      background: rgba(255, 255, 255, .018);
      cursor: pointer;
    }

    .uc {
      display: flex;
      align-items: center;
      gap: 7px;
    }

    .uav {
      width: 24px;
      height: 24px;
      border-radius: var(--r4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }

    .uav img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .pbg {
      background: var(--b4);
      border-radius: var(--rpill);
      height: 3px;
      overflow: hidden;
    }

    .pf {
      height: 100%;
      border-radius: var(--rpill);
      background: var(--w);
    }

    .pf-g {
      background: var(--green);
    }

    .pf-a {
      background: var(--amber);
    }

    .pf-r {
      background: var(--red);
    }

    /*  Section label  */
    .sl {
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--s6);
      margin-bottom: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sl::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--bd0);
    }

    /*  Live Activity  */
    .act {
      display: flex;
      align-items: flex-start;
      gap: 9px;
      padding: 8px 0;
      border-bottom: 1px solid var(--bd0);
    }

    .act:last-child {
      border-bottom: none;
    }

    .act-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }

    .ad-w {
      background: var(--w);
    }

    .ad-g {
      background: var(--green);
    }

    .ad-a {
      background: var(--amber);
    }

    .ad-r {
      background: var(--red);
    }

    .act-txt {
      font-size: 12px;
      color: var(--s4);
      line-height: 1.5;
    }

    .act-txt strong {
      color: var(--s1);
      font-weight: 600;
    }

    .act-time {
      font-size: 10px;
      color: var(--s6);
      margin-top: 1px;
    }

    /*  Health  */
    .hlth {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .hlth-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .h-ok {
      background: var(--green);
    }

    .h-warn {
      background: var(--amber);
    }

    .h-err {
      background: var(--red);
    }

    .hlth-lbl {
      font-size: 12px;
      color: var(--s4);
      width: 110px;
      flex-shrink: 0;
    }

    .hlth-val {
      font-family: 'DM Mono', monospace;
      font-size: 11.5px;
      margin-left: auto;
      flex-shrink: 0;
    }

    /*  Dispute cards  */
    .dp-card {
      background: var(--b3);
      border: 1px solid var(--bd1);
      border-radius: var(--r12);
      padding: 12px 13px;
      margin-bottom: 8px;
      transition: all .15s;
    }

    .dp-card:hover {
      border-color: var(--bd2);
    }

    .dp-card.dp-high {
      background: var(--rbg);
      border-color: var(--rbdr);
    }

    .dp-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .dp-title {
      font-size: 12.5px;
      font-weight: 700;
      color: var(--s1);
    }

    .dp-meta {
      font-size: 11px;
      color: var(--s5);
    }

    .dp-acts {
      display: flex;
      gap: 5px;
      margin-top: 9px;
    }

    /*  Inputs  */
    .inp {
      background: var(--b3);
      border: 1px solid var(--bd1);
      color: var(--s1);
      border-radius: var(--r8);
      padding: 8px 11px;
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
      outline: none;
      transition: border-color .15s;
    }

    .inp:focus {
      border-color: var(--bd3);
    }

    .inp-lbl {
      display: block;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--s5);
      margin-bottom: 4px;
    }

    select.inp {
      cursor: pointer;
    }

    /*  Search bar  */
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      align-items: center;
    }

    .search-wrap {
      position: relative;
      flex: 1;
    }

    .search-wrap svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 13px;
      height: 13px;
      color: var(--s5);
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }

    .search-inp {
      background: var(--b3);
      border: 1px solid var(--bd1);
      color: var(--s1);
      border-radius: var(--r8);
      padding: 7px 11px 7px 32px;
      font-size: 12.5px;
      font-family: 'DM Sans', sans-serif;
      width: 100%;
      outline: none;
      transition: border-color .15s;
    }

    .search-inp:focus {
      border-color: var(--bd2);
    }

    /*  Modal overlay  */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, .82);
      backdrop-filter: blur(8px);
      align-items: center;
      justify-content: center;
    }

    .overlay.show {
      display: flex;
    }

    .modal {
      background: var(--b2);
      border: 1px solid var(--bd2);
      border-radius: var(--r20);
      padding: 26px;
      width: 480px;
      max-width: 92vw;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-lg {
      width: 640px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--w);
      margin-bottom: 18px;
    }

    .modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      background: var(--b4);
      border: 1px solid var(--bd1);
      color: var(--s4);
      border-radius: var(--r8);
      width: 28px;
      height: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .15s;
    }

    .modal-close:hover {
      color: var(--w);
      border-color: var(--bd2);
    }

    .modal-close svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2.5;
    }

    .modal-foot {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 18px;
    }

    /*  Live dot  */
    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 6px rgba(34, 197, 94, .7);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    /*  Animations  */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .fu {
      animation: fadeUp .28s ease forwards;
    }

    .d1 {
      animation-delay: .04s;
      opacity: 0
    }

    .d2 {
      animation-delay: .08s;
      opacity: 0
    }

    .d3 {
      animation-delay: .12s;
      opacity: 0
    }

    .d4 {
      animation-delay: .16s;
      opacity: 0
    }

    .d5 {
      animation-delay: .20s;
      opacity: 0
    }

    /*  Tab row  */
    .tab-row {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: var(--b2);
      border: 1px solid var(--bd1);
      border-radius: var(--r12);
      padding: 4px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 6px 10px;
      border-radius: var(--r8);
      font-size: 12px;
      font-weight: 600;
      color: var(--s5);
      cursor: pointer;
      transition: all .15s;
    }

    .tab.on {
      background: var(--b4);
      color: var(--w);
      border: 1px solid var(--bd1);
    }

    /*  Resolve modal choice  */
    .resolve-opt {
      border: 1px solid var(--bd1);
      border-radius: var(--r12);
      padding: 14px;
      cursor: pointer;
      transition: all .15s;
      margin-bottom: 8px;
    }

    .resolve-opt:hover {
      border-color: var(--bd2);
      background: var(--b3);
    }

    .resolve-opt.sel-g {
      border-color: var(--gbdr);
      background: var(--gbg);
    }

    .resolve-opt.sel-r {
      border-color: var(--rbdr);
      background: var(--rbg);
    }

    .resolve-opt-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--w);
      margin-bottom: 3px;
    }

    .resolve-opt-sub {
      font-size: 11.5px;
      color: var(--s5);
    }

    /*  Settings  */
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--bd0);
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-lbl {
      font-size: 13px;
      font-weight: 600;
      color: var(--s2);
    }

    .setting-sub {
      font-size: 11px;
      color: var(--s5);
      margin-top: 2px;
    }

    .toggle {
      width: 38px;
      height: 22px;
      border-radius: var(--rpill);
      background: var(--b5);
      border: 1px solid var(--bd2);
      position: relative;
      cursor: pointer;
      transition: background .2s;
      flex-shrink: 0;
    }

    .toggle.on {
      background: var(--green);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--w);
      transition: left .2s;
    }

    .toggle.on::after {
      left: 18px;
    }

    /*  Audit log  */
    .audit-row {
      display: flex;
      gap: 10px;
      padding: 9px 0;
      border-bottom: 1px solid var(--bd0);
      font-size: 12px;
    }

    .audit-row:last-child {
      border-bottom: none;
    }

    .audit-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }

    .audit-time {
      color: var(--s5);
      font-size: 10.5px;
      font-family: 'DM Mono', monospace;
      flex-shrink: 0;
      width: 130px;
    }

    /*  Toast  */
    .toast {
      position: fixed;
      bottom: 22px;
      right: 22px;
      background: var(--w);
      color: var(--black);
      padding: 9px 16px;
      border-radius: var(--r8);
      font-size: 12.5px;
      font-weight: 700;
      z-index: 9999;
      animation: fadeUp .25s ease;
    }

    /*  Drill-down  */
    .ms-row-sub {
      background: var(--b3);
      border-radius: var(--r8);
      padding: 8px 12px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .ms-row-sub:last-child {
      margin-bottom: 0;
    }

    /*  Empty state  */
    .empty {
      text-align: center;
      padding: 32px;
      color: var(--s5);
      font-size: 13px;
    }

    /*  Section pages  */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /*  User row action buttons   */
    .ua-btn {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: var(--rpill);
      border: none;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all .15s;
    }

    .mono {
      font-family: 'DM Mono', monospace;
    }

    /*  Vault card  */
    .vault-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 0;
      border-bottom: 1px solid var(--bd0);
    }

    .vault-row:last-child {
      border-bottom: none;
    }

    .vault-title {
      font-size: 12.5px;
      font-weight: 600;
      color: var(--s1);
    }

    .vault-meta {
      font-size: 11px;
      color: var(--s5);
      margin-top: 1px;
    }

    /*  Enhanced profile avatar  */
    .av {
      position: relative;
      border-radius: var(--r8);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 11px;
      color: var(--text-1);
      background: var(--bg-inset);
      flex-shrink: 0;
      border: 2px solid var(--border-1);
      transition: border-color .2s, box-shadow .2s;
    }

    .av img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    .sb-user {
      border-radius: var(--r12);
      transition: background .15s, border-color .15s;
    }

    .sb-user:hover .av {
      border-color: var(--border-2);
      box-shadow: 0 0 0 3px var(--gbg, rgba(34, 197, 94, .08));
    }

    /* Status dot on avatar */
    .av-wrap {
      position: relative;
      display: inline-flex;
      flex-shrink: 0;
    }

    .av-online {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--green);
      border: 2px solid var(--bg-sidebar, var(--bg-page));
      z-index: 2;
    }

    /* """""""""""""""""""""""""""""""""""""""""""""""""""
   UNIVERSAL SIDEBAR  retractable on ALL screen sizes
""""""""""""""""""""""""""""""""""""""""""""""""""" */

    /* Backdrop for mobile/tablet overlay */
    .sb-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 199;
      opacity: 0;
      transition: opacity .3s ease;
      pointer-events: none;
    }

    .sb-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    /*  Sidebar base  */
    .sidebar {
      transition: width .3s cubic-bezier(.25, .46, .45, .94),
        transform .3s cubic-bezier(.25, .46, .45, .94),
        padding .3s ease,
        background .2s, border-color .2s;
      will-change: transform;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 100;
    }

    /*  Sidebar COLLAPSED on desktop  */
    body.sb-collapsed .sidebar {
      width: 58px !important;
      min-width: 58px !important;
      overflow: hidden;
    }

    body.sb-collapsed .sidebar .sb-uname,
    body.sb-collapsed .sidebar .sb-urole,
    body.sb-collapsed .sidebar .nav-sec,
    body.sb-collapsed .sidebar .logo-name {
      opacity: 0;
      width: 0;
      overflow: hidden;
      white-space: nowrap;
      transition: opacity .2s, width .2s;
    }

    body.sb-collapsed .sidebar .logo-name {
      display: none;
    }

    body.sb-collapsed .sidebar .ni span,
    body.sb-collapsed .sidebar .ni em {
      opacity: 0;
      width: 0;
      overflow: hidden;
      white-space: nowrap;
    }

    body.sb-collapsed .sidebar .ni {
      justify-content: center;
      padding: 10px 0;
    }

    body.sb-collapsed .sidebar .ni svg {
      margin: 0;
    }

    body.sb-collapsed .sidebar .avail-label,
    body.sb-collapsed .sidebar .avail-toggle-label {
      display: none;
    }

    body.sb-collapsed .sidebar .sb-user {
      justify-content: center;
      padding: 8px 0;
    }

    body.sb-collapsed .sidebar .sb-user .av-wrap,
    body.sb-collapsed .sidebar .sb-user>div:last-child {
      /* hide text column, keep avatar */
    }

    body.sb-collapsed .sidebar .sb-user>div:last-child {
      display: none;
    }

    body.sb-collapsed .sidebar .logo {
      justify-content: center;
      padding: 3px 0;
    }

    /*  Toggle button (always visible in topbar)  */
    .sb-toggle {
      width: 34px;
      height: 34px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-1, var(--bd1));
      border-radius: 8px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background .15s, border-color .15s;
      padding: 0;
    }

    .sb-toggle:hover {
      background: var(--bg-inset, var(--b3));
      border-color: var(--border-2, var(--bd2));
    }

    .sb-toggle-bar {
      width: 14px;
      height: 1.5px;
      background: var(--text-2, var(--s2));
      border-radius: 2px;
      transition: transform .25s, opacity .25s, width .25s;
      flex-shrink: 0;
    }

    /* Animate to X when open on mobile */
    .sb-toggle.is-open .sb-toggle-bar:nth-child(1) {
      transform: translateY(5.5px) rotate(45deg);
    }

    .sb-toggle.is-open .sb-toggle-bar:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }

    .sb-toggle.is-open .sb-toggle-bar:nth-child(3) {
      transform: translateY(-5.5px) rotate(-45deg);
    }

    /*  MOBILE (0900px)  full overlay slide-in  */
    @media(max-width:900px) {
      .sidebar {
        position: fixed !important;
        left: 0;
        top: 0;
        height: 100vh !important;
        width: 230px !important;
        min-width: 230px !important;
        transform: translateX(-100%);
        z-index: 200;
        box-shadow: 6px 0 40px rgba(0, 0, 0, .25);
      }

      .sidebar.mob-open {
        transform: translateX(0) !important;
      }

      .sb-backdrop {
        display: block;
      }

      .main {
        width: 100% !important;
      }

      .page,
      .content {
        padding: 14px 14px !important;
      }

      .topbar {
        padding: 11px 16px !important;
      }

      /* Collapse classes don't apply on mobile */
      body.sb-collapsed .sidebar {
        width: 230px !important;
        min-width: 230px !important;
      }

      body.sb-collapsed .sidebar .sb-uname,
      body.sb-collapsed .sidebar .sb-urole,
      body.sb-collapsed .sidebar .nav-sec,
      body.sb-collapsed .sidebar .logo-name,
      body.sb-collapsed .sidebar .ni span,
      body.sb-collapsed .sidebar .ni em {
        opacity: 1;
        width: auto;
      }

      body.sb-collapsed .sidebar .logo-name {
        display: block;
      }

      body.sb-collapsed .sidebar .ni {
        justify-content: flex-start;
        padding: 10px 9px;
      }

      body.sb-collapsed .sidebar .ni svg {
        margin: 0;
      }

      body.sb-collapsed .sidebar .sb-user {
        justify-content: flex-start;
        padding: 8px 9px;
      }

      body.sb-collapsed .sidebar .sb-user>div:last-child {
        display: block;
      }

      body.sb-collapsed .sidebar .logo {
        justify-content: flex-start;
        padding: 3px 6px;
      }

      /* Stat grids */
      .stats-row,
      .sc-row,
      .sc-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }

      .cards-grid,
      .feat-grid,
      .dp-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }

      .tbl-wrap,
      .table-wrap {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tbl,
      .data-table {
        min-width: 580px;
      }
    }

    /*  Small phone 0500px  */
    @media(max-width:500px) {

      .stats-row,
      .sc-row,
      .sc-grid {
        grid-template-columns: 1fr !important;
      }

      .cards-grid,
      .feat-grid,
      .dp-grid {
        grid-template-columns: 1fr !important;
      }

      .page,
      .content {
        padding: 10px 10px !important;
      }
    }
  </style>
</head>

<body>

  <!-- """"""""""""""""""" SIDEBAR """"""""""""""""""" -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
        </svg>
      </div>
      <div class="logo-name">CODE <em>STUDIO ke</em></div>
    </div>

    <div class="sb-user" onclick="openAdminProfileModal()">
      <div class="av-wrap">
        <div class="av av-lg">
          <img id="sb-av-img" src=""
            onerror="this.style.display='none'">
          <span id="sb-initials">U</span>
        </div>
        <div class="av-online"></div>
      </div>
      <div>
        <div class="sb-uname" id="sb-name">Administrator</div>
        <div class="sb-urole">Administrator</div>
      </div>
    </div>

    <div class="nav-sec">Platform</div>
    <div class="ni on" onclick="nav('dashboard')">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="3" width="7" height="7" rx="1" />
        <rect x="14" y="3" width="7" height="7" rx="1" />
        <rect x="3" y="14" width="7" height="7" rx="1" />
        <rect x="14" y="14" width="7" height="7" rx="1" />
      </svg>
      Dashboard
    </div>
    <div class="ni" onclick="nav('users')">
      <svg viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
      </svg>
      All Users <span class="nc" id="nav-users-count">0</span>
    </div>
    <div class="ni" onclick="nav('projects')">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
      </svg>
      All Projects <span class="nc" id="nav-proj-count">0</span>
    </div>
    <div class="ni" onclick="nav('vault')">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="11" width="18" height="11" rx="2" />
        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
      </svg>
      Escrow Vault
    </div>

    <div class="nav-sec">Moderation</div>
    <div class="ni" onclick="nav('disputes')">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
      </svg>
      Disputes <span class="nc nc-r" id="nav-disputes-count">0</span>
    </div>
    <div class="ni" onclick="nav('invoices')">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
        <line x1="16" y1="13" x2="8" y2="13" />
        <line x1="16" y1="17" x2="8" y2="17" />
      </svg>
      Invoices <span class="nc" id="nav-invoices-count"></span>
    </div>
    <div class="ni" onclick="nav('ledger')">
      <svg viewBox="0 0 24 24">
        <rect x="2" y="5" width="20" height="14" rx="2" />
        <line x1="2" y1="10" x2="22" y2="10" />
      </svg>
      Ledger
    </div>
    <div class="ni" onclick="nav('analytics')">
      <svg viewBox="0 0 24 24">
        <line x1="18" y1="20" x2="18" y2="10" />
        <line x1="12" y1="20" x2="12" y2="4" />
        <line x1="6" y1="20" x2="6" y2="14" />
      </svg>
      Analytics
    </div>

    <div class="nav-sec">System</div>
    <div class="ni" onclick="nav('settings')">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="3" />
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14" />
      </svg>
      Settings
    </div>
    <div class="ni" onclick="nav('audit')">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16" />
        <path d="M18 22H8a2 2 0 0 1-2-2V6h12v14a2 2 0 0 1-2 2z" />
      </svg>
      Audit Logs
    </div>

    <div class="sb-foot">
      <button class="so-btn" onclick="signOut()">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
          <polyline points="16 17 21 12 16 7" />
          <line x1="21" y1="12" x2="9" y2="12" />
        </svg>
        Sign Out
      </button>
    </div>
  </aside>

  <!-- """"""""""""""""""" MAIN """"""""""""""""""""""" -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="pg-title" id="page-title">Admin Control Panel</div>
        <div class="pg-sub" id="page-sub">Full platform access</div>
      </div>
      <div class="tb-right" style="gap:8px;">
        <div class="theme-pill" onclick="toggleTheme()" id="theme-pill" title="Toggle light/dark mode">
          <svg id="theme-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="1.8">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
          </svg>
          <span class="theme-pill-lbl" id="theme-lbl">Dark</span>
        </div>
        <div id="topbar-actions" style="display:flex;gap:8px;align-items:center;">
          <button class="btn btn-g" onclick="exportCSV()">
            <svg viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Export CSV
          </button>
          <button class="btn btn-w" onclick="showModal('addUser')">
            <svg viewBox="0 0 24 24">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Add User
          </button>
        </div>
      </div>
    </div><!-- /topbar -->

    <div class="content">

        <!--  DASHBOARD  -->
        <div class="section active" id="sec-dashboard">
          <div class="sl fu d1">Platform Overview</div>
          <div class="g5 fu d2">
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <rect x="2" y="7" width="20" height="14" rx="2" />
                  <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2" />
                </svg></div>
              <div class="sc-val" id="stat-escrow">KSh 0</div>
              <div class="sc-lbl">Total Escrow Value</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <polyline points="20 6 9 17 4 12" />
                </svg></div>
              <div class="sc-val" id="stat-projects">0</div>
              <div class="sc-lbl">Active Projects</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg></div>
              <div class="sc-val" id="stat-users">0</div>
              <div class="sc-lbl">Total Users</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg></div>
              <div class="sc-val" id="stat-pending">0</div>
              <div class="sc-lbl">Pending Reviews</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg></div>
              <div class="sc-val" id="stat-disputes">0</div>
              <div class="sc-lbl">Open Disputes</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
          </div>

          <div class="sl fu d3">Users & Activity</div>
          <div class="g3 fu d3">
            <div class="card">
              <div class="card-head">
                <div class="card-title">Recent Users</div>
                <span class="card-link" onclick="nav('users')">Manage All  </span>
              </div>
              <table class="tbl" id="dash-users-tbl">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Projects</th>
                    <th>Joined</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="dash-users-body"></tbody>
              </table>
            </div>

            <div class="card">
              <div class="card-head">
                <div class="card-title">Live Activity</div>
                <div class="live-dot"></div>
              </div>
              <div id="live-feed"></div>
            </div>

            <div class="card">
              <div class="card-head">
                <div class="card-title">Platform Health</div><span class="badge b-a">Live</span>
              </div>
              <div class="hlth">
                <div class="hlth-dot h-ok"></div>
                <div class="hlth-lbl">Supabase DB</div>
                <div class="pbg" style="flex:1">
                  <div class="pf pf-g" style="width:0%"></div>
                </div>
                <div class="hlth-val" style="color:var(--s5)">-</div>
              </div>
              <div class="hlth">
                <div class="hlth-dot h-ok"></div>
                <div class="hlth-lbl">Auth Service</div>
                <div class="pbg" style="flex:1">
                  <div class="pf pf-g" style="width:0%"></div>
                </div>
                <div class="hlth-val" style="color:var(--s5)">-</div>
              </div>
              <div class="hlth">
                <div class="hlth-dot h-ok"></div>
                <div class="hlth-lbl">Paystack</div>
                <div class="pbg" style="flex:1">
                  <div class="pf" style="width:0%"></div>
                </div>
                <div class="hlth-val" style="color:var(--s5)">-</div>
              </div>
              <div class="hlth">
                <div class="hlth-dot h-warn"></div>
                <div class="hlth-lbl">Resend Email</div>
                <div class="pbg" style="flex:1">
                  <div class="pf pf-a" style="width:0%"></div>
                </div>
                <div class="hlth-val" style="color:var(--s5)">-</div>
              </div>
              <div class="hlth">
                <div class="hlth-dot h-ok"></div>
                <div class="hlth-lbl">Vercel CDN</div>
                <div class="pbg" style="flex:1">
                  <div class="pf pf-g" style="width:0%"></div>
                </div>
                <div class="hlth-val" style="color:var(--s5)">-</div>
              </div>
              <div style="height:1px;background:var(--bd0);margin:12px 0;"></div>
              <div
                style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--s6);margin-bottom:9px;">
                Monthly Goals</div>
              <div style="margin-bottom:8px;">
                <div
                  style="display:flex;justify-content:space-between;font-size:11px;color:var(--s5);margin-bottom:4px;">
                  <span>Escrow Volume</span><span class="mono">0%</span>
                </div>
                <div class="pbg">
                  <div class="pf" style="width:0%"></div>
                </div>
              </div>
              <div style="margin-bottom:8px;">
                <div
                  style="display:flex;justify-content:space-between;font-size:11px;color:var(--s5);margin-bottom:4px;">
                  <span>New Projects</span><span class="mono">0%</span>
                </div>
                <div class="pbg">
                  <div class="pf pf-g" style="width:0%"></div>
                </div>
              </div>
              <div>
                <div
                  style="display:flex;justify-content:space-between;font-size:11px;color:var(--s5);margin-bottom:4px;">
                  <span>User Growth</span><span class="mono">0%</span>
                </div>
                <div class="pbg">
                  <div class="pf pf-a" style="width:0%"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="sl fu d4">Projects & Disputes</div>
          <div class="g2l fu d4">
            <div class="card">
              <div class="card-head">
                <div class="card-title">All Active Projects</div><span class="card-link" onclick="nav('projects')">View
                  All  </span>
              </div>
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Project</th>
                    <th>Client</th>
                    <th>Developer</th>
                    <th>Value</th>
                    <th>Progress</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="dash-projects-body"></tbody>
              </table>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">Open Disputes</div><span class="badge b-r" id="disputes-badge">0 Active</span>
              </div>
              <div id="dash-disputes-list"></div>
            </div>
          </div>

          <div class="sl fu d5">Recent Transactions</div>
          <div class="card fu d5">
            <div class="card-head">
              <div class="card-title">Platform Ledger</div><span class="card-link" onclick="nav('ledger')">Full Ledger
                 </span>
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th>Txn ID</th>
                  <th>Type</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="dash-ledger-body"></tbody>
            </table>
          </div>
        </div>

        <!--  ALL USERS  -->
        <div class="section" id="sec-users">
          <div class="search-row">
            <div class="search-wrap">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input class="search-inp" id="users-search" placeholder="Search by name, email or role&"
                oninput="renderUsers()">
            </div>
            <select class="inp" id="users-role-filter" onchange="renderUsers()"
              style="width:auto;padding:7px 11px;font-size:12.5px;">
              <option value="">All roles</option>
              <option value="client">Client</option>
              <option value="developer">Developer</option>
              <option value="commissioner">Commissioner</option>
              <option value="admin">Admin</option>
            </select>
            <select class="inp" id="users-status-filter" onchange="renderUsers()"
              style="width:auto;padding:7px 11px;font-size:12.5px;">
              <option value="">All statuses</option>
              <option value="active">Active</option>
              <option value="pending">Pending</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">All Users <span class="mono" style="color:var(--s5);font-size:11px;"
                  id="users-count-lbl"></span></div>
              <button class="btn btn-w btn-sm" onclick="showModal('addUser')">+ Add User</button>
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Role</th>
                  <th>Projects</th>
                  <th>Joined</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-tbody"></tbody>
            </table>
          </div>
        </div>

        <!--  ALL PROJECTS  -->
        <div class="section" id="sec-projects">
          <div class="search-row">
            <div class="search-wrap">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input class="search-inp" id="projects-search" placeholder="Search projects&" oninput="renderProjects()">
            </div>
            <select class="inp" id="projects-status-filter" onchange="renderProjects()"
              style="width:auto;padding:7px 11px;font-size:12.5px;">
              <option value="">All statuses</option>
              <option value="active">Active</option>
              <option value="review">In Review</option>
              <option value="dispute">Dispute</option>
              <option value="completed">Completed</option>
            </select>
            <button class="btn btn-g btn-sm" onclick="exportCSV('projects')">
              <svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export
            </button>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">All Projects <span class="mono" style="color:var(--s5);font-size:11px;"
                  id="proj-count-lbl"></span></div>
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Client</th>
                  <th>Developer</th>
                  <th>Sales</th>
                  <th>Value</th>
                  <th>Progress</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="projects-tbody"></tbody>
            </table>
          </div>
        </div>

        <!--  ESCROW VAULT  -->
        <div class="section" id="sec-vault">
          <div class="g5" style="margin-bottom:18px;">
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <rect x="3" y="11" width="18" height="11" rx="2" />
                  <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg></div>
              <div class="sc-val">KSh 0</div>
              <div class="sc-lbl">Total in Vault</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <polyline points="17 1 21 5 17 9" />
                  <path d="M3 11V9a4 4 0 0 1 4-4h14" />
                  <polyline points="7 23 3 19 7 15" />
                  <path d="M21 13v2a4 4 0 0 1-4 4H3" />
                </svg></div>
              <div class="sc-val">KSh 0</div>
              <div class="sc-lbl">Released This Month</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg></div>
              <div class="sc-val">KSh 0</div>
              <div class="sc-lbl">Frozen / Disputed</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <line x1="12" y1="1" x2="12" y2="23" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg></div>
              <div class="sc-val">KSh 0</div>
              <div class="sc-lbl">Platform Fees Collected</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <rect x="2" y="5" width="20" height="14" rx="2" />
                  <line x1="2" y1="10" x2="22" y2="10" />
                </svg></div>
              <div class="sc-val">0</div>
              <div class="sc-lbl">Active Escrow Accounts</div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Per-Project Escrow</div><span style="font-size:11px;color:var(--s5)">Admin can
                freeze or force-release any project</span>
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Client</th>
                  <th>Total Value</th>
                  <th>Held</th>
                  <th>Released</th>
                  <th>Status</th>
                  <th>Controls</th>
                </tr>
              </thead>
              <tbody id="vault-tbody"></tbody>
            </table>
          </div>
        </div>

        <!--  DISPUTES  -->
        <div class="section" id="sec-disputes">
          <div class="g2" style="margin-bottom:16px;">
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg></div>
              <div class="sc-val" id="dispute-open-cnt">0</div>
              <div class="sc-lbl">Open Disputes</div>
              <div class="sc-d dn"> Needs review</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <polyline points="20 6 9 17 4 12" />
                </svg></div>
              <div class="sc-val">KSh 0</div>
              <div class="sc-lbl">Total Value Frozen</div>
              <div class="sc-d neu">Across 0 disputes</div>
            </div>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">All Disputes</div>
            </div>
            <div id="disputes-full-list"></div>
          </div>
        </div>

        <!--  INVOICES  -->
        <div class="section" id="sec-invoices">
          <div class="cards-grid">
            <!-- Send Invoice Form -->
            <div class="card">
              <div class="card-head">
                <div class="card-title">Send Invoice</div>
                <div style="font-size:11px;color:var(--text-5)">Client receives Paystack link by email</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:10px">
                <div><label class="input-lbl">Client Email *</label><input class="inp" id="inv-email" type="email"
                    placeholder="client@example.com"></div>
                <div><label class="input-lbl">Client Name</label><input class="inp" id="inv-name"
                    placeholder="Full name"></div>
                <div><label class="input-lbl">Description / Service *</label><input class="inp" id="inv-desc"
                    placeholder="e.g. Website design  Phase 1"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <div><label class="input-lbl">Amount (KES) *</label><input class="inp" id="inv-amount" type="number"
                      min="1" placeholder="5000"></div>
                  <div><label class="input-lbl">Due Date</label><input class="inp" id="inv-due" type="date"></div>
                </div>
                <div>
                  <label class="input-lbl">Link to Project</label>
                  <select class="inp" id="inv-project" style="cursor:pointer">
                    <option value=""> No project </option>
                  </select>
                </div>
                <div><label class="input-lbl">Notes (optional)</label><textarea class="inp" id="inv-notes" rows="2"
                    placeholder="Any extra info for the client&" style="resize:vertical"></textarea></div>
                <button class="btn btn-b" id="inv-send-btn" onclick="sendInvoice()" style="margin-top:6px;gap:8px">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                  </svg>
                  Send Invoice by Email
                </button>
              </div>
            </div>

            <!-- Invoice History -->
            <div class="card" style="overflow:hidden">
              <div class="card-head">
                <div class="card-title">Invoice History</div>
                <button class="btn btn-w btn-xs" onclick="loadInvoices()">  Refresh</button>
              </div>
              <div id="inv-list" style="max-height:480px;overflow-y:auto">
                <div style="padding:20px;text-align:center;color:var(--text-5);font-size:13px">Loading invoices&</div>
              </div>
            </div>
          </div>
        </div>

        <!--  LEDGER  -->
        <div class="section" id="sec-ledger">
          <div class="search-row">
            <div class="search-wrap">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input class="search-inp" id="ledger-search" placeholder="Search transactions&" oninput="renderLedger()">
            </div>
            <select class="inp" id="ledger-type-filter" onchange="renderLedger()"
              style="width:auto;padding:7px 11px;font-size:12.5px;">
              <option value="">All types</option>
              <option value="escrow">Escrow</option>
              <option value="release">Release</option>
              <option value="refund">Refund</option>
              <option value="fee">Fee</option>
              <option value="commission">Commission</option>
            </select>
            <input class="inp" type="date" id="ledger-date-from" onchange="renderLedger()"
              style="width:auto;padding:7px 11px;font-size:12.5px;" title="From date">
            <input class="inp" type="date" id="ledger-date-to" onchange="renderLedger()"
              style="width:auto;padding:7px 11px;font-size:12.5px;" title="To date">
            <button class="btn btn-g btn-sm" onclick="exportCSV('ledger')">
              <svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Export
            </button>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Platform Ledger <span class="mono" style="color:var(--s5);font-size:11px;"
                  id="ledger-count-lbl"></span></div>
            </div>
            <table class="tbl">
              <thead>
                <tr>
                  <th>Txn ID</th>
                  <th>Type</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Project</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="ledger-tbody"></tbody>
            </table>
          </div>
        </div>

        <!--  ANALYTICS  -->
        <div class="section" id="sec-analytics">
          <div class="g5" style="margin-bottom:18px;">
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                </svg></div>
              <div class="sc-val" id="analytics-success-rate">0%</div>
              <div class="sc-lbl">Success Rate</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg></div>
              <div class="sc-val" id="analytics-avg-duration">0d</div>
              <div class="sc-lbl">Avg Project Length</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <line x1="12" y1="1" x2="12" y2="23" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg></div>
              <div class="sc-val" id="analytics-avg-value">KSh 0</div>
              <div class="sc-lbl">Avg Project Value</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                  <circle cx="9" cy="7" r="4" />
                </svg></div>
              <div class="sc-val" id="analytics-active-devs">0</div>
              <div class="sc-lbl">Active Developers</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
            <div class="sc">
              <div class="sc-icon"><svg viewBox="0 0 24 24">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg></div>
              <div class="sc-val" id="analytics-avg-rating">-</div>
              <div class="sc-lbl">Avg Dev Rating</div>
              <div class="sc-d neu">Awaiting live data</div>
            </div>
          </div>
          <div class="g2">
            <div class="card">
              <div class="card-head">
                <div class="card-title">Monthly Escrow Volume</div>
              </div>
              <canvas id="chart-volume" height="180"></canvas>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">User Growth</div>
              </div>
              <canvas id="chart-users" height="180"></canvas>
            </div>
          </div>
          <div class="g2">
            <div class="card">
              <div class="card-head">
                <div class="card-title">Revenue Breakdown</div>
              </div>
              <div id="revenue-breakdown"></div>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">Top Developers by Earnings</div>
              </div>
              <table class="tbl">
                <thead>
                  <tr>
                    <th>Developer</th>
                    <th>Projects</th>
                    <th>Earned</th>
                    <th>Rating</th>
                  </tr>
                </thead>
                <tbody id="top-developers-body">
                  <tr>
                    <td colspan="4" style="text-align:center;color:var(--s5);padding:18px;font-size:12px;">No developer earnings data yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!--  SETTINGS  -->
        <div class="section" id="sec-settings">
          <div class="g2">
            <div class="card">
              <div class="card-head">
                <div class="card-title">Platform Fees</div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Standard Platform Fee</div>
                  <div class="setting-sub">Applied to all client transactions</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input class="inp" id="s-fee-standard" value="2.5" type="number" step="0.1" min="0" max="10"
                    style="width:80px;text-align:right;"> <span style="color:var(--s4);font-size:13px;">%</span>
                </div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Pro Plan Fee</div>
                  <div class="setting-sub">Reduced rate for Pro subscribers</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input class="inp" id="s-fee-pro" value="1.5" type="number" step="0.1" min="0" max="10"
                    style="width:80px;text-align:right;"> <span style="color:var(--s4);font-size:13px;">%</span>
                </div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Default Commission Rate</div>
                  <div class="setting-sub">Paid to sales commissioners</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input class="inp" id="s-commission" value="10" type="number" step="0.5" min="0" max="25"
                    style="width:80px;text-align:right;"> <span style="color:var(--s4);font-size:13px;">%</span>
                </div>
              </div>
              <div style="margin-top:14px;display:flex;justify-content:flex-end;gap:8px;">
                <button class="btn btn-g btn-sm" onclick="resetFees()">Reset</button>
                <button class="btn btn-w btn-sm" onclick="saveFees()">Save Fees</button>
              </div>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">Platform Moderation System</div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Require Developer Approval</div>
                  <div class="setting-sub">New devs need admin sign-off before taking projects</div>
                </div>
                <div class="toggle on" id="toggle-dev-approval" onclick="toggleSetting(this)"></div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Allow Client Disputes</div>
                  <div class="setting-sub">Clients can raise disputes on milestones</div>
                </div>
                <div class="toggle on" id="toggle-disputes" onclick="toggleSetting(this)"></div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Auto-Approve Milestones</div>
                  <div class="setting-sub">Auto-release after 7 days if no client action</div>
                </div>
                <div class="toggle" id="toggle-auto-approve" onclick="toggleSetting(this)"></div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Maintenance Mode</div>
                  <div class="setting-sub">Disables new transactions platform-wide</div>
                </div>
                <div class="toggle" id="toggle-maintenance"
                  onclick="toggleSetting(this,'Maintenance mode ACTIVE  no new transactions allowed')"></div>
              </div>
              <div style="margin-top:14px;display:flex;justify-content:flex-end;">
                <button class="btn btn-w btn-sm" onclick="saveSettings()">Save Settings</button>
              </div>
            </div>
          </div>
          <div class="g2">
            <div class="card">
              <div class="card-head">
                <div class="card-title">Escrow Goals</div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Monthly Escrow Volume Target</div>
                  <div class="setting-sub">Used for dashboard progress tracking</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="color:var(--s4);font-size:13px;">$</span><input class="inp" id="s-escrow-goal"
                    value="180000" type="number" style="width:120px;text-align:right;">
                </div>
              </div>
              <div class="setting-row">
                <div>
                  <div class="setting-lbl">Max Projects Per Developer</div>
                  <div class="setting-sub">Concurrency limit per active developer</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input class="inp" id="s-max-projects" value="5" type="number" min="1" max="20"
                    style="width:80px;text-align:right;">
                </div>
              </div>
              <div style="margin-top:14px;display:flex;justify-content:flex-end;">
                <button class="btn btn-w btn-sm" onclick="saveGoals()">Save Goals</button>
              </div>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">Danger Zone</div><span class="badge b-r">Irreversible</span>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px;">
                <button class="btn btn-r"
                  onclick="confirmDanger('Purge archived platform data? This cannot be undone.','purgeArchive')">Purge Archived
                  Data</button>
                <button class="btn btn-r"
                  onclick="confirmDanger('Force-sync all escrow balances from Paystack?','syncEscrow')">Force Sync
                  Escrow</button>
                <button class="btn btn-a"
                  onclick="confirmBroadcastEmail()">Broadcast
                  Email</button>
              </div>
            </div>
            <div class="card">
              <div class="card-head">
                <div class="card-title">Platform Broadcast</div><span class="badge b-b">Admin</span>
              </div>
              <div style="font-size:11px;color:var(--s5);margin-bottom:10px;">Broadcast notices appear at the top of selected dashboards.</div>
              <div style="margin-bottom:8px;">
                <label class="inp-lbl">Title</label>
                <input class="inp" id="broadcast-title" maxlength="120" placeholder="Platform update">
              </div>
              <div style="margin-bottom:8px;">
                <label class="inp-lbl">Message</label>
                <textarea class="inp" id="broadcast-body" rows="3" maxlength="600" style="resize:none;" placeholder="State the update clearly and professionally."></textarea>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <div>
                  <label class="inp-lbl">Priority</label>
                  <select class="inp" id="broadcast-priority">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                    <option value="low">Low</option>
                  </select>
                </div>
                <div>
                  <label class="inp-lbl">Expires (hours)</label>
                  <input class="inp" id="broadcast-expiry-hours" type="number" min="1" max="336" value="48">
                </div>
              </div>
              <div style="font-size:11px;color:var(--s5);margin-bottom:6px;">Target Roles</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--s3);"><input type="checkbox" id="broadcast-role-client" checked>Client</label>
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--s3);"><input type="checkbox" id="broadcast-role-commissioner" checked>Commissioner</label>
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--s3);"><input type="checkbox" id="broadcast-role-developer" checked>Developer</label>
                <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--s3);"><input type="checkbox" id="broadcast-role-admin">Admin</label>
              </div>
              <button class="btn btn-w" onclick="sendPlatformBroadcast()" style="width:100%">Send Broadcast</button>
            </div>
          </div>
        </div>

        <!--  AUDIT LOGS  -->
        <div class="section" id="sec-audit">
          <div class="search-row">
            <div class="search-wrap">
              <svg viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input class="search-inp" id="audit-search" placeholder="Search audit logs" oninput="renderAudit()">
            </div>
            <select class="inp" id="audit-type-filter" onchange="renderAudit()"
              style="width:auto;padding:7px 11px;font-size:12.5px;">
              <option value="">All actions</option>
              <option value="role_change">Role Change</option>
              <option value="dispute_resolve">Dispute Resolve</option>
              <option value="escrow_freeze">Escrow Freeze</option>
              <option value="user_suspend">User Suspend</option>
              <option value="settings_change">Settings Change</option>
              <option value="user_delete">User Delete</option>
            </select>
            <button class="btn btn-g btn-sm" onclick="exportCSV('audit')">Export</button>
          </div>
          <div class="card">
            <div class="card-head">
              <div class="card-title">Audit Logs - Immutable</div>
              <span style="font-size:11px;color:var(--s5);">INSERT only - never edited - signed by admin</span>
            </div>
            <div id="audit-list"></div>
          </div>
        </div>

      </div><!-- /content -->
  </main>

  <!-- """"""""""""""""""" MODALS """""""""""""""""""" -->

  <!-- Add User Modal -->
  <div class="overlay" id="modal-addUser">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('addUser')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title">Add New User</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div><label class="inp-lbl">First Name</label><input class="inp" id="au-fname" placeholder="First name"></div>
        <div><label class="inp-lbl">Last Name</label><input class="inp" id="au-lname" placeholder="Last name"></div>
      </div>
      <div style="margin-bottom:10px;"><label class="inp-lbl">Email</label><input class="inp" id="au-email" type="email"
          placeholder="user@example.com"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div>
          <label class="inp-lbl">Role</label>
          <select class="inp" id="au-role">
            <option value="client">Client</option>
            <option value="developer">Developer</option>
            <option value="commissioner">Commissioner</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div>
          <label class="inp-lbl">Status</label>
          <select class="inp" id="au-status">
            <option value="active">Active</option>
            <option value="pending">Pending Approval</option>
          </select>
        </div>
      </div>
      <div style="margin-bottom:4px;"><label class="inp-lbl">Send Invite Email</label>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
          <div class="toggle on" id="au-send-invite" onclick="this.classList.toggle('on')"></div>
          <span style="font-size:12px;color:var(--s4);">Send onboarding email via Resend</span>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn btn-g" onclick="closeModal('addUser')">Cancel</button>
        <button class="btn btn-w" onclick="addUser()">Create User</button>
      </div>
    </div>
  </div>

  <!-- Resolve Dispute Modal -->
  <div class="overlay" id="modal-resolveDispute">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('resolveDispute')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title">Resolve Dispute</div>
      <div
        style="background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r12);padding:12px;margin-bottom:16px;"
        id="resolve-dispute-info"></div>
      <div
        style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--s5);margin-bottom:10px;">
        Admin Decision</div>
      <div class="resolve-opt" id="ro-release" onclick="selectResolution('release')">
        <div class="resolve-opt-title">Release to Developer</div>
        <div class="resolve-opt-sub">Payment sent to developer. Work is accepted. Client funded in good faith.</div>
      </div>
      <div class="resolve-opt" id="ro-refund" onclick="selectResolution('refund')">
        <div class="resolve-opt-title">Refund to Client</div>
        <div class="resolve-opt-sub">Payment returned to client. Work not accepted or not delivered.</div>
      </div>
      <div style="margin-top:12px;">
        <label class="inp-lbl">Admin Resolution Note</label>
        <textarea class="inp" id="resolve-note" rows="3" placeholder="Explain the decision (stored in audit log)&"
          style="resize:none;"></textarea>
      </div>
      <div class="modal-foot">
        <button class="btn btn-g" onclick="closeModal('resolveDispute')">Cancel</button>
        <button class="btn btn-w" id="resolve-confirm-btn" onclick="confirmResolve()" disabled>Confirm
          Resolution</button>
      </div>
    </div>
  </div>

  <!-- User Actions Modal -->
  <div class="overlay" id="modal-userAction">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('userAction')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title" id="ua-modal-title">Manage User</div>
      <div
        style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--b3);border-radius:var(--r12);border:1px solid var(--bd1);"
        id="ua-user-info"></div>
      <div
        style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--s5);margin-bottom:10px;">
        Change Role</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px;" id="ua-role-grid"></div>
      <div
        style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--s5);margin-bottom:10px;">
        Actions</div>
      <div style="display:flex;flex-direction:column;gap:6px;" id="ua-action-btns"></div>
      <div class="modal-foot">
        <button class="btn btn-g" onclick="closeModal('userAction')">Close</button>
      </div>
    </div>
  </div>

  <!-- Project Drill-Down Modal -->
  <div class="overlay" id="modal-projectDrill">
    <div class="modal modal-lg">
      <button class="modal-close" onclick="closeModal('projectDrill')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title" id="pd-title">Project Details</div>
      <div id="pd-content"></div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="overlay" id="modal-profile">
    <div class="modal">
      <button class="modal-close" onclick="closeModal('profile')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title">Profile Settings</div>
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
        <div style="position:relative;">
          <div class="av" style="width:54px;height:54px;font-size:18px;border-radius:var(--r12);">
            <img id="admin-profile-avatar" src="" onerror="this.style.display='none'">U
          </div>
        </div>
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--s1);" id="admin-profile-role-label">Administrator</div>
          <div style="font-size:11px;color:var(--s5);margin-top:2px;" id="admin-profile-meta">admin@platform  Administrator</div>
          <div style="margin-top:6px;"><span class="badge b-a">Active Session</span></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div><label class="inp-lbl">First Name</label><input class="inp" id="admin-profile-first-name" value=""></div>
        <div><label class="inp-lbl">Last Name</label><input class="inp" id="admin-profile-last-name" value=""></div>
      </div>
      <div style="margin-bottom:10px;"><label class="inp-lbl">Email</label><input class="inp" id="admin-profile-email" value=""
          type="email"></div>
      <div style="margin-bottom:14px;"><label class="inp-lbl">Phone</label><input class="inp" id="admin-profile-phone" value=""
          type="tel"></div>
      <div class="modal-foot">
        <button class="btn btn-g" onclick="closeModal('profile')">Cancel</button>
        <button class="btn btn-w" onclick="saveAdminProfile()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Danger Confirm Modal -->
  <div class="overlay" id="modal-danger">
    <div class="modal">
      <div class="modal-title" style="color:var(--red)">Confirm Action</div>
      <div id="danger-msg" style="color:var(--s3);font-size:13px;margin-bottom:20px;line-height:1.6;"></div>
      <div class="modal-foot">
        <button class="btn btn-g" onclick="closeModal('danger')">Cancel</button>
        <button class="btn btn-r" id="danger-confirm-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- View Chat Modal -->
  <div class="overlay" id="modal-viewChat">
    <div class="modal modal-lg">
      <button class="modal-close" onclick="closeModal('viewChat')"><svg viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg></button>
      <div class="modal-title" id="chat-modal-title">Project Chat</div>
      <div id="chat-modal-content" style="max-height:400px;overflow-y:auto;"></div>
      <div
        style="margin-top:12px;padding:10px 12px;background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r8);font-size:11.5px;color:var(--amber);">
        Admin read-only view - all messages are logged in audit trail
      </div>
    </div>
  </div>

  <!-- """"""""""""""""""" SCRIPT """""""""""""""""""" -->
  <script>
    //  Runtime state
    let USERS = [];
    let PROJECTS = [];
    let TRANSACTIONS = [];
    let DISPUTES = [];
    let AUDIT_LOGS = [];
    let LIVE_FEED = [];
    let currentAdminName = 'Administrator';
    let currentAdminUserId = null;
    let currentAdminProfile = null;
    const PLATFORM_SETTINGS_DEFAULTS = {
      fee_standard_pct: 2.5,
      fee_pro_pct: 1.5,
      commission_default_pct: 10,
      require_developer_approval: true,
      allow_client_disputes: true,
      auto_approve_milestones: false,
      maintenance_mode: false,
      escrow_goal_ksh: 180000,
      max_projects_per_developer: 5
    };
    const PLATFORM_SETTINGS = { ...PLATFORM_SETTINGS_DEFAULTS };

    // -- Active dispute selection --
    let activeDispute = null;
    let resolveChoice = null;

    //  Navigation 
    const sections = { dashboard: 'Admin Dashboard', users: 'All Users', projects: 'All Projects', vault: 'Escrow Vault', invoices: 'Invoices & Payments', disputes: 'Open Disputes', ledger: 'Platform Ledger', analytics: 'Analytics', settings: 'Platform Settings', audit: 'Audit Logs' };
    const sublines = { dashboard: 'Full platform access', users: 'Manage roles, status and permissions', projects: 'Every project on the platform', vault: 'Escrow balances per project', invoices: 'Send payment links via email to any client', disputes: 'Resolve client vs developer disputes', ledger: 'Every transaction ever made', analytics: 'Platform performance metrics', settings: 'Global configuration controls', audit: 'Immutable admin action history' };
    const topbarActions = {
      dashboard: `<button class="btn btn-g" onclick="exportCSV()"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button><button class="btn btn-w" onclick="showModal('addUser')"><svg viewBox="0 0 24 24" style="width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add User</button>`,
      users: `<button class="btn btn-g btn-sm" onclick="exportCSV('users')">Export CSV</button><button class="btn btn-w" onclick="showModal('addUser')">+ Add User</button>`,
      projects: `<button class="btn btn-g btn-sm" onclick="exportCSV('projects')">Export CSV</button>`,
      invoices: `<button class="btn btn-g btn-sm" onclick="loadInvoices()">Refresh</button>`,
      disputes: `<button class="btn btn-g btn-sm" onclick="nav('ledger')">View Ledger</button>`,
      ledger: `<button class="btn btn-g btn-sm" onclick="exportCSV('ledger')">Export CSV</button>`,
      analytics: `<button class="btn btn-g btn-sm" onclick="exportCSV('analytics')">Export Report</button>`,
      settings: `<button class="btn btn-r btn-sm" onclick="confirmDanger('Reset ALL settings to factory defaults?','resetAll')">Factory Reset</button><button class="btn btn-w btn-sm" onclick="saveAllSettings()">Save All</button>`,
      audit: `<button class="btn btn-g btn-sm" onclick="exportCSV('audit')">Export Logs</button>`,
      vault: `<button class="btn btn-g btn-sm" onclick="exportCSV('vault')">Export Vault</button>`,
    };

    function nav(sec) {
      if (window._L) _L.info(`Navigating to section: ${sec}`);
      document.querySelectorAll('.ni').forEach(n => n.classList.remove('on'));
      document.querySelectorAll('.ni').forEach(n => { if (n.textContent.trim().toLowerCase().includes(sec.replace('-', ' ').split(' ')[0])) n.classList.add('on'); });
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const secEl = document.getElementById('sec-' + sec);
      if (secEl) secEl.classList.add('active');
      document.getElementById('page-title').textContent = sections[sec] || 'Admin';
      document.getElementById('page-sub').textContent = sublines[sec] || '';
      document.getElementById('topbar-actions').innerHTML = topbarActions[sec] || '';
      if (sec === 'analytics') setTimeout(drawCharts, 50);
      if (sec === 'invoices') loadInvoices();
    }

    //  Edge Function Helpers 
    const EDGE_BASE = window.SUPABASE_FUNCTIONS_BASE
      || `${String(window.SUPABASE_URL || 'https://smdbfaomeghoejqqkplv.supabase.co').replace(/\/$/, '')}/functions/v1`;
    const SUPABASE_ANON = window.SUPABASE_ANON_KEY
      || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtZGJmYW9tZWdob2VqcXFrcGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTY4MDEsImV4cCI6MjA4NzE3MjgwMX0.HuQdEt6Knr7_MgYt2B_QiUbls2hy8SMPZlSxe5KPTqU';

    async function callEdgeFunction(fn, payload, userToken) {
      try {
        const res = await fetch(`${EDGE_BASE}/${fn}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${userToken || SUPABASE_ANON}` },
          body: JSON.stringify(payload),
        });
        const raw = await res.text();
        let body = {};
        if (raw) {
          try { body = JSON.parse(raw); }
          catch { body = { raw }; }
        }
        if (!res.ok) {
          return { ...body, error: body.error || `Edge function ${fn} failed (${res.status})` };
        }
        return body;
      } catch (e) {
        console.warn(`Edge function ${fn} failed:`, e);
        return { error: String(e) };
      }
    }

    async function getJwt() {
      const sb = window.sbClient;
      if (!sb) return SUPABASE_ANON;
      const { data: { session } } = await sb.auth.getSession();
      return session?.access_token || SUPABASE_ANON;
    }

    function getSelectedBroadcastRoles() {
      const pairs = [
        ['broadcast-role-client', 'client'],
        ['broadcast-role-commissioner', 'commissioner'],
        ['broadcast-role-developer', 'developer'],
        ['broadcast-role-admin', 'admin']
      ];
      return pairs.filter(([id]) => document.getElementById(id)?.checked).map(([, role]) => role);
    }

    function hydrateAdminProfileModal() {
      const p = currentAdminProfile || {};
      const first = String(p.first_name || '').trim();
      const last = String(p.last_name || '').trim();
      const email = String(p.email || '').trim();
      const fullName = `${first} ${last}`.trim() || email || currentAdminName;
      const role = String(p.role || 'admin').trim();
      const firstEl = document.getElementById('admin-profile-first-name');
      const lastEl = document.getElementById('admin-profile-last-name');
      const emailEl = document.getElementById('admin-profile-email');
      const phoneEl = document.getElementById('admin-profile-phone');
      const roleLabel = document.getElementById('admin-profile-role-label');
      const metaLabel = document.getElementById('admin-profile-meta');
      const avatarEl = document.getElementById('admin-profile-avatar');
      if (firstEl) firstEl.value = first;
      if (lastEl) lastEl.value = last;
      if (emailEl) emailEl.value = email;
      if (phoneEl) phoneEl.value = String(p.phone || '').trim();
      if (roleLabel) roleLabel.textContent = role ? `${role[0].toUpperCase()}${role.slice(1)}` : 'Administrator';
      if (metaLabel) metaLabel.textContent = `${email || 'admin@platform'}  ${fullName}`;
      if (avatarEl) {
        const avatar = String(p.avatar_url || '').trim();
        if (avatar) {
          avatarEl.src = avatar;
          avatarEl.style.display = 'block';
        } else {
          avatarEl.removeAttribute('src');
          avatarEl.style.display = 'none';
        }
      }
    }

    window.openAdminProfileModal = function () {
      hydrateAdminProfileModal();
      showModal('profile');
    };

    window.saveAdminProfile = async function () {
      const sb = window.sbClient;
      if (!sb || !currentAdminUserId) {
        toast('Unable to save profile right now.');
        return;
      }
      const first_name = String(document.getElementById('admin-profile-first-name')?.value || '').trim();
      const last_name = String(document.getElementById('admin-profile-last-name')?.value || '').trim();
      const email = String(document.getElementById('admin-profile-email')?.value || '').trim();
      const phone = String(document.getElementById('admin-profile-phone')?.value || '').trim();
      if (!email) {
        toast('Email is required.');
        return;
      }
      const patch = { first_name, last_name, email, phone, updated_at: new Date().toISOString() };
      const { error } = await sb.from('profiles').update(patch).eq('id', currentAdminUserId);
      if (error) {
        toast(`Profile update failed: ${error.message || error}`);
        return;
      }
      currentAdminProfile = { ...(currentAdminProfile || {}), ...patch };
      currentAdminName = `${first_name} ${last_name}`.trim() || email || 'Administrator';
      const sbName = document.getElementById('sb-name');
      if (sbName) sbName.textContent = currentAdminName;
      closeModal('profile');
      toast('Admin profile saved');
    };

    window.sendPlatformBroadcast = async function () {
      const sb = window.sbClient;
      if (!sb) {
        toast('Supabase connection unavailable.');
        return;
      }
      const title = String(document.getElementById('broadcast-title')?.value || '').trim();
      const body = String(document.getElementById('broadcast-body')?.value || '').trim();
      const priority = String(document.getElementById('broadcast-priority')?.value || 'normal').trim().toLowerCase();
      const expiresHours = Math.max(1, Number(document.getElementById('broadcast-expiry-hours')?.value || 48));
      const targetRoles = getSelectedBroadcastRoles();
      if (!title || !body) {
        toast('Broadcast title and message are required.');
        return;
      }
      if (!targetRoles.length) {
        toast('Select at least one target role.');
        return;
      }
      const expiresAt = new Date(Date.now() + expiresHours * 60 * 60 * 1000).toISOString();
      const { data: authData } = await sb.auth.getUser();
      const senderId = authData?.user?.id || null;
      const { data: recipients, error: recErr } = await sb
        .from('profiles')
        .select('id')
        .in('role', targetRoles);
      if (recErr) {
        toast(`Could not load recipients: ${recErr.message || recErr}`);
        return;
      }
      const recipientIds = (recipients || []).map(r => r.id).filter(Boolean);
      if (!recipientIds.length) {
        toast('No recipients found for selected roles.');
        return;
      }
      const payload = {
        from: 'admin',
        sender_id: senderId,
        target_roles: targetRoles,
        priority,
        expires_at: expiresAt
      };
      const richRows = recipientIds.map(user_id => ({
        user_id,
        type: 'admin_broadcast',
        title,
        body,
        payload,
        channel: 'broadcast',
        priority,
        expires_at: expiresAt
      }));
      let sendErr = null;
      {
        const { error } = await sb.from('notifications').insert(richRows);
        sendErr = error || null;
      }
      if (sendErr) {
        const fallbackRows = recipientIds.map(user_id => ({
          user_id,
          type: 'admin_broadcast',
          title,
          body,
          payload
        }));
        const { error: fallbackErr } = await sb.from('notifications').insert(fallbackRows);
        if (fallbackErr) {
          toast(`Broadcast failed: ${fallbackErr.message || fallbackErr}`);
          return;
        }
      }
      await sb.from('admin_broadcasts').insert({
        created_by: senderId,
        title,
        body,
        target_roles: targetRoles,
        priority,
        expires_at: expiresAt
      });
      document.getElementById('broadcast-title').value = '';
      document.getElementById('broadcast-body').value = '';
      toast(`Broadcast sent to ${recipientIds.length} users.`);
    };

    function parseSettingNumber(value, fallback) {
      const n = Number(value);
      return Number.isFinite(n) ? n : fallback;
    }

    function collectSettingsFromUi() {
      return {
        fee_standard_pct: parseSettingNumber(document.getElementById('s-fee-standard')?.value, PLATFORM_SETTINGS_DEFAULTS.fee_standard_pct),
        fee_pro_pct: parseSettingNumber(document.getElementById('s-fee-pro')?.value, PLATFORM_SETTINGS_DEFAULTS.fee_pro_pct),
        commission_default_pct: parseSettingNumber(document.getElementById('s-commission')?.value, PLATFORM_SETTINGS_DEFAULTS.commission_default_pct),
        require_developer_approval: document.getElementById('toggle-dev-approval')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.require_developer_approval,
        allow_client_disputes: document.getElementById('toggle-disputes')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.allow_client_disputes,
        auto_approve_milestones: document.getElementById('toggle-auto-approve')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.auto_approve_milestones,
        maintenance_mode: document.getElementById('toggle-maintenance')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.maintenance_mode,
        escrow_goal_ksh: parseSettingNumber(document.getElementById('s-escrow-goal')?.value, PLATFORM_SETTINGS_DEFAULTS.escrow_goal_ksh),
        max_projects_per_developer: parseSettingNumber(document.getElementById('s-max-projects')?.value, PLATFORM_SETTINGS_DEFAULTS.max_projects_per_developer)
      };
    }

    function applySettingsToUi() {
      const mapNumber = [
        ['s-fee-standard', PLATFORM_SETTINGS.fee_standard_pct],
        ['s-fee-pro', PLATFORM_SETTINGS.fee_pro_pct],
        ['s-commission', PLATFORM_SETTINGS.commission_default_pct],
        ['s-escrow-goal', PLATFORM_SETTINGS.escrow_goal_ksh],
        ['s-max-projects', PLATFORM_SETTINGS.max_projects_per_developer]
      ];
      mapNumber.forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = String(value);
      });

      const mapToggle = [
        ['toggle-dev-approval', PLATFORM_SETTINGS.require_developer_approval],
        ['toggle-disputes', PLATFORM_SETTINGS.allow_client_disputes],
        ['toggle-auto-approve', PLATFORM_SETTINGS.auto_approve_milestones],
        ['toggle-maintenance', PLATFORM_SETTINGS.maintenance_mode]
      ];
      mapToggle.forEach(([id, enabled]) => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('on', !!enabled);
      });
    }

    async function loadPlatformSettings(sb) {
      if (!sb) return;
      const { data, error } = await sb
        .from('platform_settings')
        .select('key, value');
      if (error) {
        if (window._L) _L.warn('Platform settings table not available:', error.message || error);
        try {
          const raw = localStorage.getItem('sc-admin-settings-fallback');
          if (raw) {
            const parsed = JSON.parse(raw);
            Object.assign(PLATFORM_SETTINGS, parsed || {});
          }
        } catch (_) {
          // ignore local fallback parse issues
        }
        applySettingsToUi();
        return;
      }
      if (Array.isArray(data)) {
        data.forEach(row => {
          const key = String(row.key || '');
          if (!(key in PLATFORM_SETTINGS)) return;
          let value = row.value;
          if (value && typeof value === 'object' && 'value' in value) value = value.value;
          PLATFORM_SETTINGS[key] = value;
        });
      }
      applySettingsToUi();
    }

    async function persistPlatformSettings(patch, auditLabel = 'settings_change') {
      const sb = window.sbClient;
      if (!sb) {
        Object.assign(PLATFORM_SETTINGS, patch || {});
        applySettingsToUi();
        return { ok: false, error: 'Supabase client unavailable' };
      }

      const { data: { user } } = await sb.auth.getUser();
      const rows = Object.entries(patch || {}).map(([key, value]) => ({
        key,
        value,
        updated_at: new Date().toISOString(),
        updated_by: user?.id || null
      }));
      if (!rows.length) return { ok: true };

      const { error } = await sb
        .from('platform_settings')
        .upsert(rows, { onConflict: 'key' });

      if (error) {
        if (window._L) _L.warn('Failed to persist platform settings:', error.message || error);
        Object.assign(PLATFORM_SETTINGS, patch || {});
        try {
          localStorage.setItem('sc-admin-settings-fallback', JSON.stringify(PLATFORM_SETTINGS));
        } catch (_) {
          // ignore storage write issues
        }
        applySettingsToUi();
        return { ok: false, error: error.message || String(error) };
      }

      Object.assign(PLATFORM_SETTINGS, patch);
      try {
        localStorage.setItem('sc-admin-settings-fallback', JSON.stringify(PLATFORM_SETTINGS));
      } catch (_) {
        // ignore storage write issues
      }
      applySettingsToUi();
      AUDIT_LOGS.unshift({
        time: now(),
        admin: currentAdminName,
        action: auditLabel,
        detail: `Updated platform settings (${Object.keys(patch).join(', ')})`,
        type: 'info'
      });
      return { ok: true };
    }

    //  Invoices 
    let ADMIN_PROJECTS = [];

    async function sendInvoice() {
      const email = document.getElementById('inv-email')?.value.trim();
      const name = document.getElementById('inv-name')?.value.trim() || 'Valued Client';
      const desc = document.getElementById('inv-desc')?.value.trim();
      const amount = parseFloat(document.getElementById('inv-amount')?.value || 0);
      const due = document.getElementById('inv-due')?.value;
      const notes = document.getElementById('inv-notes')?.value.trim();
      const projId = document.getElementById('inv-project')?.value;

      if (!email || !desc || !amount || amount <= 0) { toast('Please fill in email, description, and amount'); return; }

      const btn = document.getElementById('inv-send-btn');
      btn.disabled = true;
      btn.textContent = 'Sending&';

      try {
        const sb = window.sbClient;
        const jwt = await getJwt();
        const { data: { user } } = await sb.auth.getUser();

        const { data: inv, error: invErr } = await sb.from('invoices').insert({
          project_id: projId || null,
          created_by: user?.id,
          client_email: email,
          client_name: name,
          description: desc,
          amount,
          due_date: due || null,
          notes: notes || null,
          status: 'pending',
        }).select().single();

        if (invErr) { toast('Failed to create invoice record'); btn.disabled = false; return; }

        await sb.from('financial_transactions').insert({
          kind: 'invoice',
          status: 'pending',
          amount,
          currency: 'KES',
          invoice_id: inv.id,
          project_id: projId || null,
          created_by: user?.id,
          description: `Invoice sent to ${email}`,
          transaction_ref: `INV-${String(inv.id).slice(0, 8)}`
        });

        const result = await callEdgeFunction('send-invoice', {
          invoice_id: inv.id, project_id: projId || null,
          client_email: email, client_name: name, description: desc, amount, currency: 'KES',
          due_date: due || null, notes: notes || null,
          sender_name: 'CODE STUDIO ke Admin', created_by: user?.id,
        }, jwt);

        if (result.error && !result.authorization_url) toast('Warning: ' + result.error);
        else {
          toast(`Invoice sent to ${email}.`);
          ['inv-email', 'inv-name', 'inv-desc', 'inv-amount', 'inv-due', 'inv-notes'].forEach(id => {
            const el = document.getElementById(id); if (el) el.value = '';
          });
          loadInvoices();
        }
      } catch (e) { toast('Error: ' + String(e)); }
      finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Invoice by Email';
      }
    }
    async function loadInvoices() {
      const el = document.getElementById('inv-list');
      if (!el || !window.sbClient) return;
      el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--s5);font-size:13px">Loading...</div>';

      const sb = window.sbClient;
      const { data: payoutReqs, error: payoutErr } = await sb
        .from('payout_requests')
        .select('id, amount, status, notes, created_at, approved_at, paid_at, requester:profiles!payout_requests_requester_id_fkey(first_name,last_name,email)')
        .order('created_at', { ascending: false })
        .limit(20);
      const { data: invs, error } = await sb
        .from('invoices')
        .select('*, project:projects(title), creator:profiles!invoices_created_by_fkey(first_name, last_name, email)')
        .order('created_at', { ascending: false });

      if (error && payoutErr) {
        el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--s5);font-size:13px">Unable to load invoices and payouts</div>';
        return;
      }

      const statusColor = {
        pending: 'var(--amber)',
        sent: 'var(--blue)',
        processing: 'var(--blue)',
        overdue: 'var(--amber)',
        paid: 'var(--green)',
        success: 'var(--green)',
        failed: 'var(--red)',
        abandoned: 'var(--red)',
        refunded: 'var(--red)',
        cancelled: 'var(--s5)'
      };
      const statusBg = {
        pending: 'var(--abg)',
        sent: 'var(--bbg)',
        processing: 'var(--bbg)',
        overdue: 'var(--abg)',
        paid: 'var(--gbg)',
        success: 'var(--gbg)',
        failed: 'var(--rbg)',
        abandoned: 'var(--rbg)',
        refunded: 'var(--rbg)',
        cancelled: 'var(--b3)'
      };

      const invoiceHtml = (Array.isArray(invs) && invs.length) ? invs.map(inv => {
        const amt = new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' }).format(inv.amount);
        const normalizedStatus = normalizeInvoiceStatus(inv.status);
        const sc = statusColor[normalizedStatus] || 'var(--s5)';
        const sbg = statusBg[normalizedStatus] || 'transparent';
        const creatorName = inv.creator ? `${inv.creator.first_name || ''} ${inv.creator.last_name || ''}`.trim() || inv.creator.email : 'Unknown';
        const createdAtMs = inv.created_at ? new Date(inv.created_at).getTime() : 0;
        const canRegenerate = ['pending', 'sent', 'processing', 'overdue'].includes(normalizedStatus)
          && createdAtMs > 0
          && ((Date.now() - createdAtMs) >= 12 * 60 * 60 * 1000);

        return `<div style="padding:12px 16px;border-bottom:1px solid var(--bd0);display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:13px;font-weight:600;color:var(--s1)">${inv.description}</div>
              <div style="font-size:11px;color:var(--s4);margin-top:2px">To: ${inv.client_email} | By: ${creatorName}</div>
              ${inv.project ? `<div style="font-size:11px;color:var(--s5)">Project: ${inv.project.title}</div>` : ''}
            </div>
            <div style="text-align:right">
              <div style="font-size:15px;font-weight:700;color:var(--s1)">${amt}</div>
              <span style="font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;background:${sbg};color:${sc};text-transform:uppercase;letter-spacing:.5px">${normalizedStatus}</span>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${inv.paystack_authorization_url && normalizedStatus !== 'paid' ? `<a href="${inv.paystack_authorization_url}" target="_blank" class="btn btn-w btn-xs">View Link</a><button class="btn btn-g btn-xs" onclick="copyExternalLink('${encodeURIComponent(inv.paystack_authorization_url)}')">Copy Link</button>` : ''}
            ${normalizedStatus !== 'paid' ? `<button class="btn btn-w btn-xs" onclick="resendInvoice('${inv.id}')">Resend</button>` : ''}
            ${canRegenerate ? `<button class="btn btn-a btn-xs" onclick="regenerateInvoiceLink('${inv.id}')">Regenerate Link (12h+)</button>` : ''}
            ${normalizedStatus === 'paid' ? `<span style="font-size:11px;color:var(--green)">Paid ${inv.paid_at ? new Date(inv.paid_at).toLocaleDateString() : ''}</span>` : ''}
          </div>
        </div>`;
      }).join('') : '<div style="padding:18px 14px;text-align:center;color:var(--s5);font-size:13px">No invoices found</div>';

      const payoutHtml = Array.isArray(payoutReqs) && payoutReqs.length
        ? `<div style="border-bottom:1px solid var(--bd1);padding:10px 14px;font-size:11px;color:var(--s4);text-transform:uppercase;letter-spacing:.07em;">Sales Payout Requests</div>` +
        payoutReqs.map(r => {
          const name = r.requester ? `${r.requester.first_name || ''} ${r.requester.last_name || ''}`.trim() || r.requester.email : 'Sales user';
          const badge = r.status === 'approved' || r.status === 'paid' ? 'b-g' : (r.status === 'rejected' ? 'b-r' : 'b-a');
          const canApprove = r.status === 'pending';
          const canMarkPaid = r.status === 'approved';
          const canReject = r.status === 'pending' || r.status === 'approved';
          const dateLabel = r.status === 'paid'
            ? (r.paid_at ? new Date(r.paid_at).toLocaleDateString() : '-')
            : (r.approved_at ? new Date(r.approved_at).toLocaleDateString() : (r.created_at ? new Date(r.created_at).toLocaleDateString() : '-'));

          return `<div style="padding:10px 14px;border-bottom:1px solid var(--bd0);display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <div style="font-size:12.5px;color:var(--w);font-weight:600">${name}</div>
              <div style="font-size:11px;color:var(--s5)">Payout request " ${r.created_at ? new Date(r.created_at).toLocaleDateString() : '-'}</div>
              ${r.notes ? `<div style="font-size:11px;color:var(--s5);margin-top:2px">Note: ${r.notes}</div>` : ''}
            </div>
            <div style="text-align:right">
              <div class="mono" style="font-size:13px;color:var(--w)">KSh ${Number(r.amount || 0).toLocaleString()}</div>
              <div style="margin-top:2px"><span class="badge ${badge}">${r.status}</span></div>
              <div style="font-size:10px;color:var(--s6);margin-top:2px">${dateLabel}</div>
              <div style="display:flex;gap:4px;justify-content:flex-end;flex-wrap:wrap;margin-top:6px">
                ${canApprove ? `<button class="btn btn-gr btn-xs" onclick="approvePayout('${r.id}')">Approve</button>` : ''}
                ${canMarkPaid ? `<button class="btn btn-g btn-xs" onclick="markPayoutPaid('${r.id}')">Mark Paid</button>` : ''}
                ${canReject ? `<button class="btn btn-r btn-xs" onclick="rejectPayout('${r.id}')">Reject</button>` : ''}
              </div>
            </div>
          </div>`;
        }).join('') +
        `<div style="border-bottom:1px solid var(--bd1);padding:10px 14px;font-size:11px;color:var(--s4);text-transform:uppercase;letter-spacing:.07em;">Invoices</div>`
        : '';

      el.innerHTML = payoutHtml + invoiceHtml;

      const sel = document.getElementById('inv-project');
      if (sel) {
        if (!ADMIN_PROJECTS.length && PROJECTS) ADMIN_PROJECTS = PROJECTS;
        const opts = ADMIN_PROJECTS.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
        sel.innerHTML = '<option value="">- No project -</option>' + opts;
      }

      const count = document.getElementById('nav-invoices-count');
      if (count) {
        const pendingPayouts = Array.isArray(payoutReqs) ? payoutReqs.filter(r => r.status === 'pending' || r.status === 'approved').length : 0;
        const pendingInvoices = Array.isArray(invs)
          ? invs.filter(i => ['pending', 'sent', 'processing', 'overdue'].includes(normalizeInvoiceStatus(i.status))).length
          : 0;
        count.textContent = String(pendingPayouts + pendingInvoices);
      }
    }

    async function updatePayoutRequestStatus(payoutId, nextStatus, note = null) {
      const sb = window.sbClient;
      if (!sb || !payoutId) return;
      const nowIso = new Date().toISOString();
      const { data: { user } } = await sb.auth.getUser();
      const patch = { status: nextStatus };

      if (nextStatus === 'approved') {
        patch.approved_by = user?.id || null;
        patch.approved_at = nowIso;
      } else if (nextStatus === 'rejected') {
        patch.approved_by = user?.id || null;
        patch.approved_at = nowIso;
        patch.notes = note || 'Rejected by admin';
      } else if (nextStatus === 'paid') {
        patch.approved_by = user?.id || null;
        patch.approved_at = nowIso;
        patch.paid_at = nowIso;
      }

      const { error } = await sb.from('payout_requests').update(patch).eq('id', payoutId);
      if (error) {
        toast('Failed to update payout request');
        return;
      }

      const txStatus = nextStatus === 'approved' ? 'held' : (nextStatus === 'rejected' ? 'failed' : 'paid');
      const txDescription = nextStatus === 'approved'
        ? 'Commission payout approved and queued'
        : (nextStatus === 'rejected' ? `Commission payout rejected${note ? ': ' + note : ''}` : 'Commission payout completed');
      await sb
        .from('financial_transactions')
        .update({ status: txStatus, description: txDescription })
        .eq('payout_request_id', payoutId)
        .eq('kind', 'commission_payout');

      AUDIT_LOGS.unshift({
        time: now(),
        admin: currentAdminName,
        action: 'settings_change',
        detail: `Payout request ${payoutId.slice(0, 8)} set to ${nextStatus}`,
        type: nextStatus === 'rejected' ? 'warn' : 'info'
      });

      await loadAdminData();
      await loadInvoices();
      toast(`Payout request ${nextStatus}`);
    }

    window.approvePayout = async (payoutId) => {
      await updatePayoutRequestStatus(payoutId, 'approved');
    };

    window.rejectPayout = async (payoutId) => {
      const reason = prompt('Reason for rejection:', 'Rejected by admin');
      if (reason === null) return;
      await updatePayoutRequestStatus(payoutId, 'rejected', reason || 'Rejected by admin');
    };

    window.markPayoutPaid = async (payoutId) => {
      await updatePayoutRequestStatus(payoutId, 'paid');
    };

    window.resendInvoice = async (invoiceId) => {
      const sb = window.sbClient;
      if (!sb) return;
      const { data: inv } = await sb.from('invoices').select('*').eq('id', invoiceId).single();
      if (!inv) { toast('Invoice not found'); return; }
      toast('Resending invoice&');
      const jwt = await getJwt();
      const result = await callEdgeFunction('send-invoice', {
        invoice_id: inv.id, client_email: inv.client_email, client_name: inv.client_name,
        description: inv.description, amount: inv.amount, currency: inv.currency || 'KES',
        due_date: inv.due_date, notes: inv.notes,
      }, jwt);
      if (result.error && !result.authorization_url) toast('Warning: ' + result.error);
      else { toast(`Resent to ${inv.client_email}.`); loadInvoices(); }
    };

    window.regenerateInvoiceLink = async (invoiceId) => {
      const sb = window.sbClient;
      if (!sb) return;
      const { data: inv } = await sb.from('invoices').select('*').eq('id', invoiceId).single();
      if (!inv) { toast('Invoice not found'); return; }
      toast('Regenerating payment link...');
      const jwt = await getJwt();
      const result = await callEdgeFunction('send-invoice', {
        invoice_id: inv.id,
        client_email: inv.client_email,
        client_name: inv.client_name,
        description: inv.description,
        amount: inv.amount,
        currency: inv.currency || 'KES',
        due_date: inv.due_date,
        notes: inv.notes,
        force_new_request: true
      }, jwt);
      if (result.error && !result.authorization_url) {
        toast(`Regeneration failed: ${result.error}`);
        return;
      }
      if (result.authorization_url) {
        try { await navigator.clipboard.writeText(result.authorization_url); } catch (_) { }
      }
      toast('New payment link generated.');
      loadInvoices();
    };

    window.copyExternalLink = async function (encodedLink) {
      const link = decodeURIComponent(String(encodedLink || ''));
      if (!link) {
        toast('No link to copy.');
        return;
      }
      try {
        await navigator.clipboard.writeText(link);
        toast('Link copied.');
      } catch (_) {
        toast('Copy failed. Please copy manually.');
      }
    };

    function normalizeInvoiceStatus(value) {
      const s = String(value || '').trim().toLowerCase();
      if (['success', 'complete', 'completed'].includes(s)) return 'paid';
      if (['failed', 'failure', 'abandoned'].includes(s)) return 'failed';
      if (['in_progress', 'queued'].includes(s)) return 'processing';
      return s || 'pending';
    }

    //  Helpers 
    function roleBadge(r) {
      const m = { client: 'b-b', developer: 'b-g', commissioner: 'b-a', admin: 'b-r' };
      return `<span class="badge ${m[r] || 'b-w'}">${r}</span>`;
    }
    function statusBadge(s) {
      const m = { active: 'b-g', pending: 'b-a', suspended: 'b-r', done: 'b-g', held: 'b-w', disputed: 'b-r' };
      return `<span class="badge ${m[s] || 'b-w'}">${s}</span>`;
    }
    function projBadge(s) {
      const m = { active: 'b-g', review: 'b-b', dispute: 'b-r', completed: 'b-w', locked: 'b-w' };
      const l = { active: 'Active', review: 'In Review', dispute: 'Dispute', completed: 'Done', locked: 'Locked' };
      return `<span class="badge ${m[s] || 'b-w'}">${l[s] || s}</span>`;
    }
    function msBadge(s) {
      const m = { paid: 'b-g', submitted: 'b-b', in_progress: 'b-a', locked: 'b-w' };
      const l = { paid: 'Paid', submitted: 'Submitted', in_progress: 'In Progress', locked: 'Locked' };
      return `<span class="badge ${m[s] || 'b-w'}">${l[s] || s}</span>`;
    }
    function userAv(u, size = 24) {
      return `<div class="uav" style="background:#1A1A1A;width:${size}px;height:${size}px;"><img src="https://api.dicebear.com/8.x/thumbs/svg?seed=${u.seed}&backgroundColor=1A1A1A" onerror="this.style.display='none'">${u.initials}</div>`;
    }
    function fmt(n) { return 'KSh ' + Number(n).toLocaleString(); }

    //  Render Dashboard 
    function renderDashboard() {
      // Recent users
      const tbody = document.getElementById('dash-users-body');
      tbody.innerHTML = USERS.length ? USERS.slice(0, 5).map(u => `
    <tr onclick="openUserAction('${u.id}')">
      <td><div class="uc">${userAv(u)} <div><div style="font-weight:600;color:var(--w)">${u.name}</div><div style="font-size:10px;color:var(--s5)">${u.email}</div></div></div></td>
      <td>${roleBadge(u.role)}</td>
      <td class="mono">${u.projects}</td>
      <td style="font-size:11px;color:var(--s5)">${u.joined.split(',')[0]}</td>
      <td>${statusBadge(u.status)}</td>
    </tr>`).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--s5);padding:16px;">No users yet.</td></tr>';

      // Live feed
      document.getElementById('live-feed').innerHTML = LIVE_FEED.length
        ? LIVE_FEED.map(f => `<div class="act"><div class="act-dot ${f.dot}"></div><div><div class="act-txt">${f.text}</div><div class="act-time">${f.time}</div></div></div>`).join('')
        : '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">No recent platform activity.</div>';

      // Dashboard projects (top 4)
      document.getElementById('dash-projects-body').innerHTML = PROJECTS.length ? PROJECTS.slice(0, 4).map(p => `
    <tr onclick="openProjectDrill('${p.id}')">
      <td><div style="font-weight:600;color:var(--w)">${p.title}</div><div style="font-size:10px;color:var(--s5)">${p.type}</div></td>
      <td><div class="uc"><div class="uav" style="background:#1A1A1A">${p.clientId ? USERS.find(u => u.id === p.clientId)?.initials : '?'}</div>${p.client}</div></td>
      <td><div class="uc"><div class="uav" style="background:#1A1A1A">${p.devId ? USERS.find(u => u.id === p.devId)?.initials : '?'}</div>${p.dev}</div></td>
      <td class="mono">${fmt(p.value)}</td>
      <td><div style="display:flex;align-items:center;gap:5px"><div class="pbg" style="flex:1"><div class="pf pf-g" style="width:${p.progress}%"></div></div><span style="font-size:10px;color:var(--s5)" class="mono">${p.progress}%</span></div></td>
      <td>${projBadge(p.status)}</td>
    </tr>`).join('') : '<tr><td colspan="6" style="text-align:center;color:var(--s5);padding:16px;">No projects yet.</td></tr>';

      // Dashboard disputes
      renderDisputeCards('dash-disputes-list', 3);

      // Dashboard ledger (top 5)
      document.getElementById('dash-ledger-body').innerHTML = TRANSACTIONS.length
        ? TRANSACTIONS.slice(0, 5).map(t => ledgerRow(t)).join('')
        : '<tr><td colspan="7" style="text-align:center;color:var(--s5);padding:16px;">No transactions yet.</td></tr>';
    }

    //  Render All Users 
    function renderUsers() {
      const q = document.getElementById('users-search').value.toLowerCase();
      const rf = document.getElementById('users-role-filter').value;
      const sf = document.getElementById('users-status-filter').value;
      let filtered = USERS.filter(u =>
        (!q || u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q) || u.role.includes(q)) &&
        (!rf || u.role === rf) &&
        (!sf || u.status === sf)
      );
      document.getElementById('users-count-lbl').textContent = `(${filtered.length} of ${USERS.length})`;
      document.getElementById('users-tbody').innerHTML = filtered.length ? filtered.map(u => `
    <tr>
      <td><div class="uc">${userAv(u, 26)}<div><div style="font-weight:600;color:var(--w)">${u.name}</div><div style="font-size:10px;color:var(--s5)">${u.email}</div></div></div></td>
      <td>${roleBadge(u.role)}</td>
      <td class="mono">${u.projects}</td>
      <td style="font-size:11px;color:var(--s5)">${u.joined}</td>
      <td>${statusBadge(u.status)}</td>
      <td>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button class="btn btn-g btn-xs" onclick="openUserAction('${u.id}')">Manage</button>
          ${u.status !== 'suspended' ? `<button class="btn btn-a btn-xs" onclick="suspendUser('${u.id}')">Suspend</button>` : `<button class="btn btn-gr btn-xs" onclick="unsuspendUser('${u.id}')">Restore</button>`}
          <button class="btn btn-r btn-xs" onclick="deleteUser('${u.id}')">Delete</button>
        </div>
      </td>
    </tr>`).join('') : '<tr><td colspan="6" style="text-align:center;color:var(--s5);padding:16px;">No users match this filter.</td></tr>';
    }

    //  Render All Projects 
    function renderProjects() {
      const q = document.getElementById('projects-search').value.toLowerCase();
      const sf = document.getElementById('projects-status-filter').value;
      let filtered = PROJECTS.filter(p =>
        (!q || p.title.toLowerCase().includes(q) || p.client.toLowerCase().includes(q) || p.dev.toLowerCase().includes(q)) &&
        (!sf || p.status === sf)
      );
      document.getElementById('proj-count-lbl').textContent = `(${filtered.length} of ${PROJECTS.length})`;
      document.getElementById('projects-tbody').innerHTML = filtered.length ? filtered.map(p => `
    <tr onclick="openProjectDrill('${p.id}')">
      <td><div style="font-weight:600;color:var(--w)">${p.title}</div><div style="font-size:10px;color:var(--s5)">${p.type}</div></td>
      <td><div class="uc"><div class="uav" style="background:#1A1A1A">${USERS.find(u => u.id === p.clientId)?.initials || '?'}</div>${p.client}</div></td>
      <td><div class="uc"><div class="uav" style="background:#1A1A1A">${USERS.find(u => u.id === p.devId)?.initials || '?'}</div>${p.dev}</div></td>
      <td style="font-size:11px;color:var(--s5)">${p.sales}</td>
      <td class="mono">${fmt(p.value)}</td>
      <td><div style="display:flex;align-items:center;gap:5px"><div class="pbg" style="flex:1"><div class="pf pf-g" style="width:${p.progress}%"></div></div><span style="font-size:10px;color:var(--s5)" class="mono">${p.progress}%</span></div></td>
      <td>${projBadge(p.status)}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:4px;">
          <button class="btn btn-g btn-xs" onclick="openProjectDrill('${p.id}')">View</button>
          ${p.status === 'dispute' ? `<button class="btn btn-r btn-xs" onclick="openResolve('${p.id}')">Resolve</button>` : ''}
        </div>
      </td>
    </tr>`).join('') : '<tr><td colspan="8" style="text-align:center;color:var(--s5);padding:16px;">No projects match this filter.</td></tr>';
    }

    //  Render Vault 
    function renderVault() {
      const frozen = new Set(['p3', 'p5']);
      document.getElementById('vault-tbody').innerHTML = PROJECTS.length ? PROJECTS.map(p => {
        const paid = p.milestones.filter(m => m.status === 'paid').reduce((a, m) => a + m.amount, 0);
        const held = p.value - paid;
        const isFrozen = frozen.has(p.id);
        return `
      <tr>
        <td><div style="font-weight:600;color:var(--w)">${p.title}</div><div style="font-size:10px;color:var(--s5)">${p.type}</div></td>
        <td style="font-size:12px">${p.client}</td>
        <td class="mono">${fmt(p.value)}</td>
        <td class="mono" style="color:var(--amber)">${fmt(held)}</td>
        <td class="mono" style="color:var(--green)">${fmt(paid)}</td>
        <td>${isFrozen ? '<span class="badge b-r">Frozen</span>' : projBadge(p.status)}</td>
        <td>
          <div style="display:flex;gap:4px;">
            ${isFrozen ?
            `<button class="btn btn-gr btn-xs" onclick="unfreeze('${p.id}')">Unfreeze</button>` :
            `<button class="btn btn-a btn-xs" onclick="freezeVault('${p.id}')">Freeze</button>`
          }
            <button class="btn btn-r btn-xs" onclick="forceRelease('${p.id}')">Force Release</button>
          </div>
        </td>
      </tr>`;
      }).join('') : '<tr><td colspan="7" style="text-align:center;color:var(--s5);padding:16px;">No escrow records yet.</td></tr>';
    }

    //  Render Disputes 
    function renderDisputeCards(containerId, limit = 99) {
      const container = document.getElementById(containerId);
      const open = DISPUTES.filter(d => d.status === 'open').slice(0, limit);
      if (!open.length) { container.innerHTML = '<div class="empty">No open disputes</div>'; return; }
      container.innerHTML = open.map(d => `
    <div class="dp-card ${d.priority === 'high' ? 'dp-high' : ''}">
      <div class="dp-top">
        <div class="dp-title">${d.project}</div>
        <span class="badge ${d.priority === 'high' ? 'b-r' : d.priority === 'medium' ? 'b-a' : 'b-w'}">${d.priority}</span>
      </div>
      <div class="dp-meta">${d.client} vs ${d.dev}  ${fmt(d.amount)} held</div>
      <div class="dp-meta" style="margin-top:3px">${d.reason}</div>
      <div class="dp-meta" style="margin-top:2px;color:var(--s6)">Raised ${d.raised}</div>
      <div style="display:flex;gap:5px;margin-top:9px;">
        <button class="btn btn-gr btn-sm" onclick="openResolveById('${d.id}')">Resolve Dispute</button>
        <button class="btn btn-g btn-sm" onclick="viewChat('${d.id}')">View Chat</button>
        ${d.projId ? `<button class="btn btn-g btn-sm" onclick="openProjectDrill('${d.projId}')">View Project</button>` : ''}
      </div>
    </div>`).join('');
    }

    //  Render Ledger 
    function renderLedger() {
      const q = document.getElementById('ledger-search').value.toLowerCase();
      const tf = document.getElementById('ledger-type-filter').value;
      const df = document.getElementById('ledger-date-from').value;
      const dt = document.getElementById('ledger-date-to').value;
      let filtered = TRANSACTIONS.filter(t =>
        (!q || t.id.toLowerCase().includes(q) || t.from.toLowerCase().includes(q) || t.to.toLowerCase().includes(q) || t.project.toLowerCase().includes(q)) &&
        (!tf || t.type === tf) &&
        (!df || t.date >= df) &&
        (!dt || t.date <= dt)
      );
      document.getElementById('ledger-count-lbl').textContent = `(${filtered.length} transactions)`;
      document.getElementById('ledger-tbody').innerHTML = filtered.length
        ? filtered.map(t => ledgerRow(t, true)).join('')
        : '<tr><td colspan="8" style="text-align:center;color:var(--s5);padding:16px;">No transactions match this filter.</td></tr>';
    }

    function ledgerRow(t, showProject = false) {
      const colors = { release: 'var(--green)', escrow: 'var(--s3)', refund: 'var(--red)', fee: 'var(--amber)', commission: 'var(--blue)' };
      const amtPrefix = { release: '+', escrow: '', refund: '-', fee: '', commission: '+' };
      return `
    <tr>
      <td class="mono" style="color:var(--s5);font-size:11px">#${t.id}</td>
      <td style="font-size:12px;color:var(--s3);text-transform:capitalize">${t.type}</td>
      <td style="font-size:12px">${t.from}</td>
      <td style="font-size:12px">${t.to}</td>
      ${showProject ? `<td style="font-size:11px;color:var(--s5)">${t.project}</td>` : ''}
      <td class="mono" style="color:${colors[t.type] || 'var(--s2)'}">${amtPrefix[t.type] || ''}${fmt(t.amount)}</td>
      <td style="font-size:11px;color:var(--s5)">${t.date}</td>
      <td>${statusBadge(t.status)}</td>
    </tr>`;
    }

    //  Render Audit 
    function renderAudit() {
      const q = document.getElementById('audit-search').value.toLowerCase();
      const tf = document.getElementById('audit-type-filter').value;
      let filtered = AUDIT_LOGS.filter(a =>
        (!q || a.detail.toLowerCase().includes(q) || a.action.includes(q)) &&
        (!tf || a.action === tf)
      );
      const dotColor = { info: 'ad-w', warn: 'ad-a', danger: 'ad-r' };
      document.getElementById('audit-list').innerHTML = filtered.length ? filtered.map(a => `
    <div class="audit-row">
      <div class="audit-dot ${dotColor[a.type] || 'ad-w'}"></div>
      <div class="audit-time">${a.time}</div>
      <div style="flex:1">
        <div style="font-size:12px;color:var(--s2)">${a.detail}</div>
        <div style="font-size:10.5px;color:var(--s5);margin-top:1px">${a.action.replace(/_/g, ' ')}  by ${a.admin}</div>
      </div>
    </div>`).join('') : '<div class="empty">No audit logs match your filter</div>';
    }

    function updateAnalyticsSummary() {
      const activeProjects = PROJECTS.filter(p => p.status === 'active' || p.status === 'in-progress').length;
      const completedProjects = PROJECTS.filter(p => p.status === 'completed' || p.status === 'done').length;
      const successRate = PROJECTS.length ? Math.round((completedProjects / PROJECTS.length) * 100) : 0;
      const avgValue = PROJECTS.length
        ? Math.round(PROJECTS.reduce((acc, p) => acc + Number(p.value || 0), 0) / PROJECTS.length)
        : 0;
      const activeDevs = new Set(PROJECTS.filter(p => p.devId).map(p => p.devId)).size;
      const avgDuration = 0;

      const rateEl = document.getElementById('analytics-success-rate');
      if (rateEl) rateEl.textContent = `${successRate}%`;
      const durEl = document.getElementById('analytics-avg-duration');
      if (durEl) durEl.textContent = `${avgDuration}d`;
      const valueEl = document.getElementById('analytics-avg-value');
      if (valueEl) valueEl.textContent = `KSh ${avgValue.toLocaleString()}`;
      const devsEl = document.getElementById('analytics-active-devs');
      if (devsEl) devsEl.textContent = String(activeDevs);
      const ratingEl = document.getElementById('analytics-avg-rating');
      if (ratingEl) ratingEl.textContent = '-';
    }

    function renderTopDevelopers() {
      const tbody = document.getElementById('top-developers-body');
      if (!tbody) return;
      const totals = new Map();
      TRANSACTIONS.forEach(t => {
        if (t.status !== 'paid') return;
        const match = USERS.find(u => u.name === t.to && u.role === 'developer');
        if (!match) return;
        totals.set(match.id, (totals.get(match.id) || 0) + Number(t.amount || 0));
      });
      const top = Array.from(totals.entries())
        .map(([id, earned]) => ({ user: USERS.find(u => u.id === id), earned }))
        .filter(x => x.user)
        .sort((a, b) => b.earned - a.earned)
        .slice(0, 8);

      if (!top.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--s5);padding:18px;font-size:12px;">No developer earnings data yet.</td></tr>';
        return;
      }

      tbody.innerHTML = top.map(item => `<tr>
        <td><div class="uc">${userAv(item.user)} ${item.user.name}</div></td>
        <td class="mono">${item.user.projects || 0}</td>
        <td class="mono" style="color:var(--green)">KSh ${Math.round(item.earned).toLocaleString()}</td>
        <td class="mono">-</td>
      </tr>`).join('');
    }

    //  User Actions 
    function openUserAction(uid) {
      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      document.getElementById('ua-modal-title').textContent = `Manage: ${u.name}`;
      document.getElementById('ua-user-info').innerHTML = `
    ${userAv(u, 36)}
    <div>
      <div style="font-size:13px;font-weight:600;color:var(--w)">${u.name}</div>
      <div style="font-size:11px;color:var(--s5)">${u.email}</div>
      <div style="margin-top:4px">${roleBadge(u.role)} ${statusBadge(u.status)}</div>
    </div>`;
      const roles = ['client', 'developer', 'commissioner', 'admin'];
      document.getElementById('ua-role-grid').innerHTML = roles.map(r =>
        `<button class="btn btn-sm ${r === u.role ? 'btn-w' : 'btn-g'}" onclick="changeRole('${uid}','${r}')" id="rb-${r}">${r}</button>`
      ).join('');
      document.getElementById('ua-action-btns').innerHTML = `
    <button class="btn btn-g" onclick="impersonate('${uid}')">
      <svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      Impersonate User
    </button>
    ${u.status !== 'suspended' ?
          `<button class="btn btn-a" onclick="suspendUser('${uid}');closeModal('userAction')">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
        Suspend Account
      </button>`:
          `<button class="btn btn-gr" onclick="unsuspendUser('${uid}');closeModal('userAction')">Restore Account</button>`
        }
    <button class="btn btn-r" onclick="deleteUser('${uid}');closeModal('userAction')">
      <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
      Delete User Permanently
    </button>`;
      showModal('userAction');
    }

    async function changeRole(uid, role) {
      const sb = window.sbClient;
      if (sb) {
        const { error } = await sb.from('profiles').update({ role: role }).eq('id', uid);
        if (error) { toast('Error updating role'); return; }
      }

      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      const old = u.role;
      u.role = role;
      document.querySelectorAll('[id^="rb-"]').forEach(b => b.classList.remove('btn-w'));
      document.querySelectorAll('[id^="rb-"]').forEach(b => b.classList.add('btn-g'));
      document.getElementById('rb-' + role)?.classList.replace('btn-g', 'btn-w');
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'role_change', detail: `Changed ${u.name} from ${old}   ${role}`, type: 'info' });
      toast(`${u.name}   ${role}`);
      renderUsers();
    }

    async function suspendUser(uid) {
      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      u.status = 'suspended';
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'user_suspend', detail: `Suspended ${u.name} (${u.email})`, type: 'danger' });
      renderUsers();
      toast(`${u.name} suspended`);
    }

    async function unsuspendUser(uid) {
      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      u.status = 'active';
      renderUsers();
      toast(`${u.name} restored`);
    }

    function deleteUser(uid) {
      const u = USERS.find(x => x.id === uid);
      if (!u) return;
      confirmDanger(`Permanently delete ${u.name}? This cannot be undone.`, async () => {
        const i = USERS.findIndex(x => x.id === uid);
        AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'user_delete', detail: `Deleted user ${u.name} (${u.email})`, type: 'danger' });
        USERS.splice(i, 1);
        renderUsers();
        toast(`${u.name} deleted`);
      });
    }

    function impersonate(uid) {
      const u = USERS.find(x => x.id === uid);
      toast(`Impersonating ${u?.name}  would redirect to their dashboard`);
      closeModal('userAction');
    }

    //  Add User 
    function addUser() {
      const fname = document.getElementById('au-fname').value.trim();
      const lname = document.getElementById('au-lname').value.trim();
      const email = document.getElementById('au-email').value.trim();
      const role = document.getElementById('au-role').value;
      const status = document.getElementById('au-status').value;
      if (!fname || !email) { toast('Name and email required'); return; }
      const newUser = {
        id: 'u' + Date.now(), name: `${fname} ${lname}`.trim(), email, role,
        projects: 0, joined: 'Feb 21, 2026', status,
        seed: fname + lname, initials: (fname[0] + (lname ? lname[0] : '')).toUpperCase()
      };
      USERS.unshift(newUser);
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'role_change', detail: `Created new ${role} account: ${newUser.name} (${email})`, type: 'info' });
      document.getElementById('nav-users-count').textContent = USERS.length;
      renderUsers();
      closeModal('addUser');
      toast(`${newUser.name} created`);
      document.getElementById('au-fname').value = '';
      document.getElementById('au-lname').value = '';
      document.getElementById('au-email').value = '';
    }

    //  Project Drill-Down 
    function openProjectDrill(pid) {
      const p = PROJECTS.find(x => x.id === pid);
      if (!p) return;
      document.getElementById('pd-title').textContent = p.title;
      const paid = p.milestones.filter(m => m.status === 'paid').reduce((a, m) => a + m.amount, 0);
      document.getElementById('pd-content').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;">
      <div style="background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r12);padding:12px;">
        <div style="font-size:10px;color:var(--s5);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">Value</div>
        <div class="mono" style="font-size:16px;color:var(--w)">${fmt(p.value)}</div>
      </div>
      <div style="background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r12);padding:12px;">
        <div style="font-size:10px;color:var(--s5);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">Released</div>
        <div class="mono" style="font-size:16px;color:var(--green)">${fmt(paid)}</div>
      </div>
      <div style="background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r12);padding:12px;">
        <div style="font-size:10px;color:var(--s5);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">Progress</div>
        <div class="mono" style="font-size:16px;color:var(--w)">${p.progress}%</div>
      </div>
      <div style="background:var(--b3);border:1px solid var(--bd1);border-radius:var(--r12);padding:12px;">
        <div style="font-size:10px;color:var(--s5);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px">Status</div>
        <div style="margin-top:4px">${projBadge(p.status)}</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;font-size:12.5px;">
      <div><span style="color:var(--s5)">Client: </span><span style="color:var(--w);font-weight:600">${p.client}</span></div>
      <div><span style="color:var(--s5)">Developer: </span><span style="color:var(--w);font-weight:600">${p.dev}</span></div>
      <div><span style="color:var(--s5)">Sales: </span><span style="color:var(--w);font-weight:600">${p.sales}</span></div>
    </div>
    <div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--s6);margin-bottom:9px">Milestones</div>
    ${p.milestones.map((m, i) => `
      <div class="ms-row-sub">
        <div style="display:flex;align-items:center;gap:9px">
          <div style="font-size:10px;color:var(--s5);font-family:'DM Mono',monospace;width:20px">${i + 1}</div>
          <div>
            <div style="font-size:12.5px;font-weight:600;color:var(--w)">${m.name}</div>
            <div style="font-size:10.5px;color:var(--s5)">${m.date}  ${fmt(m.amount)}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          ${msBadge(m.status)}
          ${m.status === 'submitted' ? `<button class="btn btn-gr btn-xs" onclick="adminApproveMs('${pid}',${i})">Approve</button>` : ''}
          ${m.status !== 'paid' && m.status !== 'locked' ? `<button class="btn btn-r btn-xs" onclick="adminFreezeMs('${pid}',${i})">Freeze</button>` : ''}
        </div>
      </div>`).join('')}
    <div style="display:flex;gap:6px;margin-top:14px;">
      <button class="btn btn-g btn-sm" onclick="viewChat('${pid}')">View Full Chat</button>
      ${p.status === 'dispute' ? `<button class="btn btn-r btn-sm" onclick="closeModal('projectDrill');openResolveById(DISPUTES.find(d=>d.projId==='${pid}')?.id)">Resolve Dispute</button>` : ''}
    </div>`;
      showModal('projectDrill');
    }

    async function adminApproveMs(pid, idx) {
      const p = PROJECTS.find(x => x.id === pid);
      if (!p || !p.milestones?.[idx]) return;
      const ms = p.milestones[idx];
      const sb = window.sbClient;

      if (sb && ms.id) {
        const { data: { user } } = await sb.auth.getUser();
        const { error: msErr } = await sb
          .from('milestones')
          .update({ status: 'paid' })
          .eq('id', ms.id);
        if (msErr) {
          toast('Failed to approve milestone');
          return;
        }

        await sb.from('financial_transactions').insert({
          kind: 'milestone_release',
          status: 'paid',
          amount: Number(ms.amount || 0),
          project_id: pid,
          payer_id: p.clientId || null,
          payee_id: p.devId || null,
          created_by: user?.id || null,
          description: `Milestone approved: ${ms.name || 'Milestone'}`,
          transaction_ref: `MS-${String(ms.id).slice(0, 8)}-${Date.now()}`
        });
      }

      p.milestones[idx].status = 'paid';
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'settings_change', detail: `Admin approved milestone ${idx + 1} on ${p.title}`, type: 'info' });
      await loadAdminData();
      openProjectDrill(pid);
      toast(`Milestone approved & released`);
    }

    async function adminFreezeMs(pid, idx) {
      const p = PROJECTS.find(x => x.id === pid);
      if (!p || !p.milestones?.[idx]) return;
      const ms = p.milestones[idx];
      const sb = window.sbClient;

      if (sb && ms.id) {
        const { error: msErr } = await sb
          .from('milestones')
          .update({ status: 'locked' })
          .eq('id', ms.id);
        if (msErr) {
          toast('Failed to freeze milestone');
          return;
        }
      }

      p.milestones[idx].status = 'locked';
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'escrow_freeze', detail: `Froze milestone ${idx + 1} on ${p.title}`, type: 'warn' });
      await loadAdminData();
      openProjectDrill(pid);
      toast(`Milestone frozen`);
    }

    //  Dispute Resolution 
    function openResolveById(did) {
      if (!did) return;
      const d = DISPUTES.find(x => x.id === did);
      if (d) openResolve(d.projId, did);
    }

    function openResolve(projId, disputeId) {
      let d = DISPUTES.find(x => x.id === disputeId) || DISPUTES.find(x => x.projId === projId);
      if (!d) return;
      activeDispute = d;
      resolveChoice = null;
      document.getElementById('ro-release').className = 'resolve-opt';
      document.getElementById('ro-refund').className = 'resolve-opt';
      document.getElementById('resolve-confirm-btn').disabled = true;
      document.getElementById('resolve-note').value = '';
      document.getElementById('resolve-dispute-info').innerHTML = `
    <div style="font-size:13px;font-weight:700;color:var(--w);margin-bottom:6px">${d.project}</div>
    <div style="font-size:12px;color:var(--s4)"><strong style="color:var(--s2)">${d.client}</strong> vs <strong style="color:var(--s2)">${d.dev}</strong></div>
    <div style="font-size:12px;color:var(--s4);margin-top:4px">${fmt(d.amount)} held  ${d.reason}</div>`;
      showModal('resolveDispute');
    }

    function selectResolution(choice) {
      resolveChoice = choice;
      document.getElementById('ro-release').className = `resolve-opt${choice === 'release' ? ' sel-g' : ''}`;
      document.getElementById('ro-refund').className = `resolve-opt${choice === 'refund' ? ' sel-r' : ''}`;
      document.getElementById('resolve-confirm-btn').disabled = false;
    }

    async function confirmResolve() {
      if (!resolveChoice || !activeDispute) return;
      const note = document.getElementById('resolve-note').value.trim() || `Admin resolved: ${resolveChoice}`;
      const d = activeDispute;
      const project = PROJECTS.find(p => p.id === d.projId);
      const action = resolveChoice === 'release' ? `Released ${fmt(d.amount)} to ${d.dev}` : `Refunded ${fmt(d.amount)} to ${d.client}`;

      const sb = window.sbClient;
      if (sb && d.id) {
        const resolvedAt = new Date().toISOString();
        const disputePayloads = [
          { status: 'resolved', resolution: note, resolved_at: resolvedAt, updated_at: resolvedAt },
          { status: 'resolved', resolution: note, updated_at: resolvedAt },
          { status: 'resolved', resolution: note },
          { status: 'resolved' }
        ];
        let disputeError = null;
        for (const payload of disputePayloads) {
          const { error } = await sb.from('disputes').update(payload).eq('id', d.id);
          if (!error) {
            disputeError = null;
            break;
          }
          disputeError = error;
          const msg = String(error.message || '').toLowerCase();
          const retryable = msg.includes('column') && msg.includes('does not exist');
          if (!retryable) break;
        }
        if (disputeError) {
          toast(`Failed to resolve dispute in database: ${disputeError.message || disputeError}`);
          return;
        }

        const { data: { user } } = await sb.auth.getUser();
        const txKind = resolveChoice === 'release' ? 'milestone_release' : 'refund';
        const txPayloads = [
          {
            transaction_ref: `DSP-${String(d.id).slice(0, 8)}-${Date.now()}`,
            kind: txKind,
            status: 'paid',
            amount: Number(d.amount || project?.value || 0),
            project_id: d.projId || null,
            payer_id: resolveChoice === 'release' ? (project?.clientId || null) : null,
            payee_id: resolveChoice === 'release' ? (project?.devId || null) : (project?.clientId || null),
            created_by: user?.id || null,
            description: `Dispute resolved by admin: ${resolveChoice}`,
            metadata: { dispute_id: d.id, note }
          },
          {
            kind: txKind,
            status: 'paid',
            amount: Number(d.amount || project?.value || 0),
            project_id: d.projId || null,
            description: `Dispute resolved by admin: ${resolveChoice}`,
            metadata: { dispute_id: d.id, note }
          }
        ];
        for (const payload of txPayloads) {
          const { error } = await sb.from('financial_transactions').insert(payload);
          if (!error) break;
          if (isMissingTable(error, 'financial_transactions')) {
            await sb.from('escrow_transactions').insert({
              type: txKind,
              status: 'paid',
              amount: Number(d.amount || project?.value || 0),
              project_id: d.projId || null,
              invoice_id: null,
              metadata: { dispute_id: d.id, note, outcome: resolveChoice }
            });
            break;
          }
          const msg = String(error.message || '').toLowerCase();
          const retryable = msg.includes('column') && msg.includes('does not exist');
          if (!retryable) {
            if (window._L) _L.warn('Dispute settlement ledger insert failed:', error);
            break;
          }
        }

        const notifyBody = resolveChoice === 'release'
          ? 'A dispute was resolved and escrow has been released to the developer.'
          : 'A dispute was resolved and a refund has been approved to your account.';
        if (project?.clientId) {
          await insertNotificationCompat(sb, {
            user_id: project.clientId,
            type: 'dispute_resolved',
            title: 'Dispute resolved',
            body: notifyBody,
            payload: { dispute_id: d.id, project_id: d.projId, outcome: resolveChoice }
          });
        }
        if (project?.devId) {
          await insertNotificationCompat(sb, {
            user_id: project.devId,
            type: 'dispute_resolved',
            title: 'Dispute resolved',
            body: resolveChoice === 'release'
              ? 'The dispute was resolved and payment was released.'
              : 'The dispute was resolved in favor of a client refund.',
            payload: { dispute_id: d.id, project_id: d.projId, outcome: resolveChoice }
          });
        }
      }

      d.status = 'resolved';
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'dispute_resolve', detail: `${d.project}: ${action}. Note: ${note}`, type: 'warn' });
      // Update dispute count
      const open = DISPUTES.filter(x => x.status === 'open').length;
      document.getElementById('stat-disputes').textContent = open;
      document.getElementById('nav-disputes-count').textContent = open;
      document.getElementById('dispute-open-cnt').textContent = open;
      if (document.getElementById('disputes-badge')) document.getElementById('disputes-badge').textContent = open + ' Active';
      renderDisputeCards('dash-disputes-list', 3);
      renderDisputeCards('disputes-full-list');
      closeModal('resolveDispute');
      await loadAdminData();
      toast(`Dispute resolved  ${resolveChoice === 'release' ? 'payment released to dev' : 'refund sent to client'}`);
    }

    //  Vault Controls 
    function freezeVault(pid) {
      const p = PROJECTS.find(x => x.id === pid);
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'escrow_freeze', detail: `Froze entire escrow for ${p.title}`, type: 'warn' });
      renderVault();
      toast(`${p.title}  escrow frozen`);
    }

    function unfreeze(pid) {
      const p = PROJECTS.find(x => x.id === pid);
      renderVault();
      toast(`${p.title}  escrow unfrozen`);
    }

    function forceRelease(pid) {
      const p = PROJECTS.find(x => x.id === pid);
      confirmDanger(`Force-release all held escrow funds for "${p.title}"? This bypasses client approval.`, () => {
        AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'dispute_resolve', detail: `Admin force-released escrow for ${p.title}`, type: 'danger' });
        renderVault();
        toast(`${p.title}  escrow force-released`);
      });
    }

    //  View Chat 
    async function viewChat(id) {
      const sb = window.sbClient;
      const chatTitle = document.getElementById('chat-modal-title');
      const chatBody = document.getElementById('chat-modal-content');
      if (!chatTitle || !chatBody) return;

      chatTitle.textContent = 'Project Chat - Admin View';
      chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">Loading messages...</div>';
      showModal('viewChat');

      if (!sb) {
        chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">Messaging unavailable.</div>';
        return;
      }

      let projectId = id;
      const dispute = DISPUTES.find(d => d.id === id);
      if (dispute?.projId) projectId = dispute.projId;
      const project = PROJECTS.find(p => p.id === projectId);

      if (!project) {
        chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">Project conversation not found.</div>';
        return;
      }

      chatTitle.textContent = `Project Chat - ${project.title}`;

      const participantIds = [project.clientId, project.devId, project.commissionerId].filter(Boolean);
      if (!participantIds.length) {
        chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">No participants found for this project.</div>';
        return;
      }

      const { data: msgs, error } = await sb
        .from('messages')
        .select(`
          id, content, created_at, sender_id, receiver_id,
          sender:profiles!messages_sender_id_fkey(first_name, last_name, email),
          receiver:profiles!messages_receiver_id_fkey(first_name, last_name, email)
        `)
        .in('sender_id', participantIds)
        .in('receiver_id', participantIds)
        .order('created_at', { ascending: true });

      if (error) {
        chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">Failed to load messages.</div>';
        return;
      }

      const relevant = (msgs || []).filter(m => participantIds.includes(m.sender_id) && participantIds.includes(m.receiver_id));
      if (!relevant.length) {
        chatBody.innerHTML = '<div style="padding:14px;text-align:center;color:var(--s5);font-size:12px;">No messages yet for this project conversation.</div>';
        return;
      }

      chatBody.innerHTML = relevant.map(m => {
        const senderName = m.sender ? `${m.sender.first_name || ''} ${m.sender.last_name || ''}`.trim() || m.sender.email : 'User';
        const receiverName = m.receiver ? `${m.receiver.first_name || ''} ${m.receiver.last_name || ''}`.trim() || m.receiver.email : 'User';
        const ts = m.created_at ? new Date(m.created_at).toLocaleString() : 'Unknown time';
        return `
    <div style="padding:10px 0;border-bottom:1px solid var(--bd0);">
      <div style="display:flex;align-items:baseline;gap:8px;margin-bottom:4px;flex-wrap:wrap;">
        <span style="font-size:12.5px;font-weight:700;color:var(--w)">${senderName}</span>
        <span style="font-size:10.5px;color:var(--s5)">to ${receiverName}</span>
        <span style="font-size:10.5px;color:var(--s5)">${ts}</span>
      </div>
      <div style="font-size:12.5px;color:var(--s3);line-height:1.5">${m.content || ''}</div>
    </div>`;
      }).join('');

      AUDIT_LOGS.unshift({
        time: now(),
        admin: currentAdminName,
        action: 'settings_change',
        detail: `Viewed project chat for ${project.title}`,
        type: 'info'
      });
    }

    //  Settings 
    function toggleSetting(el, warningMsg) {
      el.classList.toggle('on');
      if (warningMsg && el.classList.contains('on')) toast(warningMsg);
      AUDIT_LOGS.unshift({ time: now(), admin: currentAdminName, action: 'settings_change', detail: `Toggled platform setting: ${el.id}`, type: 'info' });
    }

    async function saveFees() {
      const patch = {
        fee_standard_pct: parseSettingNumber(document.getElementById('s-fee-standard')?.value, PLATFORM_SETTINGS_DEFAULTS.fee_standard_pct),
        fee_pro_pct: parseSettingNumber(document.getElementById('s-fee-pro')?.value, PLATFORM_SETTINGS_DEFAULTS.fee_pro_pct),
        commission_default_pct: parseSettingNumber(document.getElementById('s-commission')?.value, PLATFORM_SETTINGS_DEFAULTS.commission_default_pct),
      };
      const result = await persistPlatformSettings(patch, 'settings_change');
      if (!result.ok) {
        toast(`Failed to save fees: ${result.error || 'Database error'}`);
        return;
      }
      toast('Fees saved');
    }

    function resetFees() {
      document.getElementById('s-fee-standard').value = String(PLATFORM_SETTINGS_DEFAULTS.fee_standard_pct);
      document.getElementById('s-fee-pro').value = String(PLATFORM_SETTINGS_DEFAULTS.fee_pro_pct);
      document.getElementById('s-commission').value = String(PLATFORM_SETTINGS_DEFAULTS.commission_default_pct);
      toast('Fees reset to defaults');
    }

    async function saveSettings() {
      const patch = {
        require_developer_approval: document.getElementById('toggle-dev-approval')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.require_developer_approval,
        allow_client_disputes: document.getElementById('toggle-disputes')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.allow_client_disputes,
        auto_approve_milestones: document.getElementById('toggle-auto-approve')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.auto_approve_milestones,
        maintenance_mode: document.getElementById('toggle-maintenance')?.classList.contains('on') ?? PLATFORM_SETTINGS_DEFAULTS.maintenance_mode,
      };
      const result = await persistPlatformSettings(patch, 'settings_change');
      if (!result.ok) {
        toast(`Failed to save moderation controls: ${result.error || 'Database error'}`);
        return;
      }
      toast('Settings saved');
    }

    async function saveGoals() {
      const patch = {
        escrow_goal_ksh: parseSettingNumber(document.getElementById('s-escrow-goal')?.value, PLATFORM_SETTINGS_DEFAULTS.escrow_goal_ksh),
        max_projects_per_developer: parseSettingNumber(document.getElementById('s-max-projects')?.value, PLATFORM_SETTINGS_DEFAULTS.max_projects_per_developer),
      };
      const result = await persistPlatformSettings(patch, 'settings_change');
      if (!result.ok) {
        toast(`Failed to save goals: ${result.error || 'Database error'}`);
        return;
      }
      toast('Goals saved');
    }

    async function saveAllSettings() {
      await saveFees();
      await saveSettings();
      await saveGoals();
      toast('All settings saved');
    }

    //  CSV Export 
    function exportCSV(type = 'users') {
      let rows = [], filename = 'export.csv';
      if (type === 'users' || type === 'dashboard' || type === '') {
        rows = [['Name', 'Email', 'Role', 'Projects', 'Joined', 'Status'], ...USERS.map(u => [u.name, u.email, u.role, u.projects, u.joined, u.status])];
        filename = 'code-studio-ke-users.csv';
      } else if (type === 'projects') {
        rows = [['Title', 'Client', 'Developer', 'Sales', 'Value', 'Progress', 'Status'], ...PROJECTS.map(p => [p.title, p.client, p.dev, p.sales, p.value, p.progress + '%', p.status])];
        filename = 'code-studio-ke-projects.csv';
      } else if (type === 'ledger') {
        rows = [['ID', 'Type', 'From', 'To', 'Project', 'Amount', 'Date', 'Status'], ...TRANSACTIONS.map(t => [t.id, t.type, t.from, t.to, t.project, t.amount, t.date, t.status])];
        filename = 'code-studio-ke-ledger.csv';
      } else if (type === 'audit') {
        rows = [['Time', 'Admin', 'Action', 'Detail'], ...AUDIT_LOGS.map(a => [a.time, a.admin, a.action, a.detail])];
        filename = 'code-studio-ke-audit.csv';
      } else if (type === 'vault') {
        rows = [['Project', 'Client', 'Developer', 'Value', 'Status'], ...PROJECTS.map(p => [p.title, p.client, p.dev, p.value, p.status])];
        filename = 'code-studio-ke-vault.csv';
      } else if (type === 'analytics') {
        const paidCount = TRANSACTIONS.filter(t => t.status === 'paid').length;
        const successRate = PROJECTS.length ? `${Math.round((paidCount / Math.max(PROJECTS.length, 1)) * 100)}%` : '0%';
        const avgProjectValue = PROJECTS.length ? Math.round(PROJECTS.reduce((acc, p) => acc + Number(p.value || 0), 0) / PROJECTS.length) : 0;
        const activeDevelopers = new Set(PROJECTS.filter(p => p.devId).map(p => p.devId)).size;
        rows = [
          ['Metric', 'Value'],
          ['Total Escrow', `KSh ${Math.round(PROJECTS.reduce((acc, p) => acc + Number(p.value || 0), 0)).toLocaleString()}`],
          ['Active Projects', PROJECTS.length],
          ['Success Rate', successRate],
          ['Average Project Value', `KSh ${avgProjectValue.toLocaleString()}`],
          ['Active Developers', activeDevelopers]
        ];
        filename = 'code-studio-ke-analytics.csv';
      }
      const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      const a = document.createElement('a');
      a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      a.download = filename; a.click();
      toast(`Exported ${filename}`);
    }

    //  Danger Confirm 
    function confirmDanger(msg, action) {
      document.getElementById('danger-msg').textContent = msg;
      const btn = document.getElementById('danger-confirm-btn');
      btn.onclick = () => {
        if (typeof action === 'function') action();
        else {
          if (action === 'purgeArchive') toast('Archived data purge queued');
          else if (action === 'syncEscrow') toast('Escrow sync triggered  check logs');
          else if (action === 'broadcastEmail') toast(`Broadcast email queued for ${USERS.length} users`);
          else if (action === 'resetAll') { resetFees(); toast('Factory reset complete'); }
        }
        closeModal('danger');
      };
      showModal('danger');
    }

    function confirmBroadcastEmail() {
      confirmDanger(`Send platform-wide email to all ${USERS.length} users?`, 'broadcastEmail');
    }

    //  Charts (canvas-based, no lib) 
    function drawCharts() {
      const monthLabels = ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'];
      const volumeByMonth = monthLabels.map(() => 0);
      const usersByMonth = monthLabels.map(() => 0);
      const monthIndex = new Map(monthLabels.map((label, idx) => [label, idx]));

      TRANSACTIONS.forEach(t => {
        if (!t.date) return;
        const dt = new Date(t.date);
        if (Number.isNaN(dt.getTime())) return;
        const monthShort = dt.toLocaleDateString('en-US', { month: 'short' });
        const idx = monthIndex.get(monthShort);
        if (idx == null) return;
        volumeByMonth[idx] += Number(t.amount || 0);
      });

      USERS.forEach(u => {
        const parsed = new Date(u.joined);
        if (Number.isNaN(parsed.getTime())) return;
        const monthShort = parsed.toLocaleDateString('en-US', { month: 'short' });
        const idx = monthIndex.get(monthShort);
        if (idx == null) return;
        usersByMonth[idx] += 1;
      });

      drawBarChart('chart-volume', volumeByMonth, monthLabels, 'var(--green)');
      drawBarChart('chart-users', usersByMonth, monthLabels, 'var(--blue)');
      const rb = document.getElementById('revenue-breakdown');
      const fees = TRANSACTIONS
        .filter(t => t.type === 'fee' && t.status === 'paid')
        .reduce((acc, t) => acc + Number(t.amount || 0), 0);
      const commissions = TRANSACTIONS
        .filter(t => t.type === 'commission' && t.status === 'paid')
        .reduce((acc, t) => acc + Number(t.amount || 0), 0);
      const total = fees + commissions;
      const feePct = total > 0 ? Math.round((fees / total) * 100) : 0;
      const commPct = total > 0 ? Math.round((commissions / total) * 100) : 0;
      rb.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;padding:4px 0">
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px"><span style="color:var(--s4)">Platform Fees</span><span class="mono" style="color:var(--green)">KSh ${fees.toLocaleString()}</span></div>
        <div class="pbg"><div class="pf pf-g" style="width:${feePct}%"></div></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px"><span style="color:var(--s4)">Commissions</span><span class="mono" style="color:var(--blue)">KSh ${commissions.toLocaleString()}</span></div>
        <div class="pbg"><div class="pf" style="width:${commPct}%;background:var(--blue)"></div></div>
      </div>
      <div style="height:1px;background:var(--bd0)"></div>
      <div style="display:flex;justify-content:space-between;font-size:13px;font-weight:700">
        <span style="color:var(--s3)">Total Platform Revenue</span>
        <span class="mono" style="color:var(--w)">KSh ${total.toLocaleString()}</span>
      </div>
    </div>`;
    }

    function drawBarChart(id, data, labels, color) {
      const canvas = document.getElementById(id);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const W = canvas.offsetWidth || 600, H = canvas.height || 180;
      canvas.width = W; canvas.height = H;
      ctx.clearRect(0, 0, W, H);
      const pad = { t: 20, r: 20, b: 30, l: 55 };
      const max = Math.max(1, ...data) * 1.15;
      const cw = W - pad.l - pad.r, ch = H - pad.t - pad.b;
      const bw = cw / data.length * 0.55, gap = cw / data.length;
      // Grid lines
      ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) { const y = pad.t + ch * (1 - i / 4); ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke(); }
      // Y labels
      ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.font = '10px DM Mono,monospace'; ctx.textAlign = 'right';
      for (let i = 0; i <= 4; i++) { const v = Math.round(max * i / 4); const y = pad.t + ch * (1 - i / 4) + 3; ctx.fillText(v >= 1000 ? '$' + (v / 1000).toFixed(0) + 'k' : v, pad.l - 6, y); }
      // Bars
      data.forEach((v, i) => {
        const x = pad.l + gap * i + (gap - bw) / 2;
        const bh = ch * (v / max);
        const y = pad.t + ch - bh;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.roundRect ? ctx.roundRect(x, y, bw, bh, 3) : ctx.rect(x, y, bw, bh);
        ctx.fill();
        // Label
        ctx.fillStyle = 'rgba(255,255,255,0.45)'; ctx.textAlign = 'center'; ctx.font = '10px DM Sans,sans-serif';
        ctx.fillText(labels[i], x + bw / 2, H - 8);
      });
    }

    //  Modal Helpers 
    function showModal(name) { document.getElementById('modal-' + name)?.classList.add('show'); }
    function closeModal(name) { document.getElementById('modal-' + name)?.classList.remove('show'); }
    document.addEventListener('click', e => { if (e.target.classList.contains('overlay')) e.target.classList.remove('show'); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.overlay.show').forEach(o => o.classList.remove('show')); });

    //  Misc Helpers 
    async function signOut() {
      toast('Signing out&');
      if (window.sbClient) {
        await window.sbClient.auth.signOut();
      }
      window.location.href = 'landing_page.html';
    }
    function now() { return new Date().toISOString().replace('T', ' ').slice(0, 16); }

    let _toastTimer;
    window.toast = msg => window.showToast ? window.showToast(msg) : alert(msg);

    function isMissingTable(err, tableName) {
      if (!err) return false;
      const raw = `${err.code || ''} ${err.message || ''} ${err.details || ''}`.toLowerCase();
      const table = String(tableName || '').toLowerCase();
      return raw.includes('pgrst205')
        || raw.includes('42p01')
        || (raw.includes('schema cache') && (!table || raw.includes(table)))
        || (raw.includes('does not exist') && (!table || raw.includes(table)));
    }

    function isMissingColumn(err, columnName = '') {
      if (!err) return false;
      const raw = `${err.code || ''} ${err.message || ''} ${err.details || ''}`.toLowerCase();
      const column = String(columnName || '').toLowerCase();
      return raw.includes('42703')
        || (raw.includes('column') && raw.includes('does not exist') && (!column || raw.includes(column)));
    }

    async function insertNotificationCompat(sb, payload) {
      const primary = await sb.from('notifications').insert(payload);
      if (!primary.error) return primary;
      if (!(isMissingColumn(primary.error, 'body') || isMissingColumn(primary.error, 'payload'))) {
        return primary;
      }
      const fallback = {
        user_id: payload.user_id,
        type: payload.type || 'info',
        title: payload.title || 'Notification',
        content: payload.body || payload.content || 'Platform update',
        is_read: false
      };
      return sb.from('notifications').insert(fallback);
    }

    //  Theme 
    const MOON_SVG = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
    const SUN_SVG = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';

    function toggleTheme() {
      const h = document.documentElement;
      const isLight = h.classList.contains('light');
      const next = isLight ? 'dark' : 'light';

      if (window.setTheme) {
        window.setTheme(next);
      } else {
        h.classList.toggle('light');
        localStorage.setItem('theme', next);
      }

      const newIsLight = h.classList.contains('light');
      document.getElementById('theme-lbl').textContent = newIsLight ? 'Light' : 'Dark';
      document.getElementById('theme-icon').innerHTML = newIsLight ? SUN_SVG : MOON_SVG;

      // Redraw charts if analytics visible
      if (document.getElementById('sec-analytics').classList.contains('active')) {
        setTimeout(drawCharts, 50);
      }
    }

    function initThemeUI() {
      const isLight = document.documentElement.classList.contains('light');
      document.getElementById('theme-lbl').textContent = isLight ? 'Light' : 'Dark';
      document.getElementById('theme-icon').innerHTML = isLight ? SUN_SVG : MOON_SVG;
    }

    // Call initThemeUI after DOM load or script run
    initThemeUI();

    window.toast = msg => window.showToast ? window.showToast(msg) : alert(msg);

    async function loadAdminData() {
      const sb = window.sbClient;
      USERS = [];
      PROJECTS = [];
      TRANSACTIONS = [];
      DISPUTES = [];
      AUDIT_LOGS = [];
      LIVE_FEED = [];
      if (!sb) {
        if (window._L) _L.warn("Supabase client not found.");
        renderAll();
        if (window.hideLoader) hideLoader();
        return;
      }

      try {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
          if (window._L) _L.warn("No active user session.");
          renderAll();
          if (window.hideLoader) hideLoader();
          return;
        }
        currentAdminUserId = user.id;

        if (window._L) _L.info("Fetching real-time admin data from Supabase...");
        await loadPlatformSettings(sb);

        // 1. Fetch profiles for USERS
        const { data: profiles, error: profErr } = await sb
          .from('profiles')
          .select('*');

        if (!profErr && profiles && profiles.length > 0) {
          if (window._L) _L.debug(`Fetched ${profiles.length} profiles.`);
          USERS = profiles.map(p => ({
            id: p.id,
            name: `${p.first_name || ''} ${p.last_name || ''}`.trim() || (p.email || 'User').split('@')[0],
            email: p.email || 'unknown-email',
            role: p.role || 'client',
            projects: 0,
            joined: new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
            status: p.status || 'active',
            seed: p.first_name || 'User',
            initials: ((p.first_name?.[0] || '') + (p.last_name?.[0] || '')).toUpperCase() || 'U'
          }));

          const myProfile = profiles.find(p => p.id === user.id);
          if (myProfile) {
            currentAdminProfile = { ...myProfile };
            const fullName = `${myProfile.first_name || ''} ${myProfile.last_name || ''}`.trim() || myProfile.email || 'Administrator';
            currentAdminName = fullName;
            const sbName = document.getElementById('sb-name');
            if (sbName) sbName.textContent = fullName;
            const initials = ((myProfile.first_name?.[0] || '') + (myProfile.last_name?.[0] || '')).toUpperCase() || 'U';
            const sbInitials = document.getElementById('sb-initials');
            if (sbInitials) sbInitials.textContent = initials;
            const sbAv = document.getElementById('sb-av-img');
            if (sbAv && myProfile.avatar_url) {
              sbAv.src = myProfile.avatar_url;
              sbAv.style.display = 'block';
            }
            hydrateAdminProfileModal();
          }
        } else if (profErr) {
          if (window._L) _L.error("Error fetching profiles:", profErr);
        }

        // 2. Fetch projects for PROJECTS
        const { data: projs, error: projErr } = await sb
          .from('projects')
          .select(`
            *,
            client:profiles!projects_client_id_fkey(first_name, last_name, email),
            developer:profiles!projects_developer_id_fkey(first_name, last_name, email),
            commissioner:profiles!projects_commissioner_id_fkey(first_name, last_name, email),
            milestones(*)
          `);

        if (!projErr && projs && projs.length > 0) {
          if (window._L) _L.debug(`Fetched ${projs.length} projects.`);
          PROJECTS = projs.map(p => {
            let clientName = p.client ? `${p.client.first_name || ''} ${p.client.last_name || ''}`.trim() : 'Unknown';
            let devName = p.developer ? `${p.developer.first_name || ''} ${p.developer.last_name || ''}`.trim() : 'Unassigned';
            let salesName = p.commissioner ? `${p.commissioner.first_name || ''} ${p.commissioner.last_name || ''}`.trim() : 'Platform';
            let ms = Array.isArray(p.milestones) ? p.milestones : [];
            let approved = ms.filter(m => m.status === 'approved' || m.status === 'paid').reduce((acc, m) => acc + (m.amount || 0), 0);
            let progress = p.total_value > 0 ? Math.round((approved / p.total_value) * 100) : (p.progress || 0);

            // Update project count for users
            let cUser = USERS.find(u => u.id === p.client_id);
            if (cUser) cUser.projects++;
            let dUser = USERS.find(u => u.id === p.developer_id);
            if (dUser) dUser.projects++;
            let sUser = USERS.find(u => u.id === p.commissioner_id);
            if (sUser) sUser.projects++;

            return {
              id: p.id,
              title: p.title || 'Untitled Project',
              type: p.description?.slice(0, 30) || 'Project',
              client: clientName,
              clientId: p.client_id,
              dev: devName,
              devId: p.developer_id,
              sales: salesName || 'Platform',
              commissionerId: p.commissioner_id || null,
              value: p.total_value || 0,
              progress: progress,
              status: p.status || 'active',
              milestones: ms.sort((a, b) => new Date(a.due_date) - new Date(b.due_date)).map(m => ({
                id: m.id,
                name: m.title || 'Milestone',
                amount: m.amount || 0,
                status: m.status || 'locked',
                date: m.due_date ? new Date(m.due_date).toLocaleDateString() : 'TBD'
              }))
            };
          });
        } else if (projErr) {
          if (window._L) _L.error("Error fetching projects:", projErr);
        }

        // 3. Fetch financial transactions for ledger (with escrow_transactions fallback)
        let txRows = [];
        let ftxMode = 'financial_transactions';
        const { data: ftx, error: ftxErr } = await sb
          .from('financial_transactions')
          .select(`
            id, kind, status, amount, created_at, description,
            project:projects(title),
            payer:profiles!financial_transactions_payer_id_fkey(first_name, last_name, email),
            payee:profiles!financial_transactions_payee_id_fkey(first_name, last_name, email)
          `)
          .order('created_at', { ascending: false });

        if (!ftxErr && Array.isArray(ftx)) {
          txRows = ftx.map(t => {
            const payerName = t.payer ? `${t.payer.first_name || ''} ${t.payer.last_name || ''}`.trim() || t.payer.email : 'Platform';
            const payeeName = t.payee ? `${t.payee.first_name || ''} ${t.payee.last_name || ''}`.trim() || t.payee.email : 'Platform';
            return {
              id: String(t.id).slice(0, 12),
              type: t.kind || 'transaction',
              from: payerName || 'Platform',
              to: payeeName || 'Platform',
              project: t.project?.title || '',
              amount: Number(t.amount || 0),
              date: t.created_at ? new Date(t.created_at).toISOString().slice(0, 10) : '',
              status: t.status || 'pending'
            };
          });
        } else if (isMissingTable(ftxErr, 'financial_transactions')) {
          ftxMode = 'escrow_transactions';
          const { data: legacyTx, error: legacyErr } = await sb
            .from('escrow_transactions')
            .select(`
              id, type, status, amount, created_at, project_id, invoice_id, metadata,
              project:projects(title)
            `)
            .order('created_at', { ascending: false });
          if (!legacyErr && Array.isArray(legacyTx)) {
            txRows = legacyTx.map(t => {
              const meta = t.metadata && typeof t.metadata === 'object' ? t.metadata : {};
              const fromName = meta.from || meta.sender || 'Platform';
              const toName = meta.to || meta.receiver || 'Platform';
              return {
                id: String(t.id).slice(0, 12),
                type: t.type || 'escrow',
                from: fromName,
                to: toName,
                project: t.project?.title || '',
                amount: Number(t.amount || 0),
                date: t.created_at ? new Date(t.created_at).toISOString().slice(0, 10) : '',
                status: t.status || 'pending'
              };
            });
          } else if (legacyErr && window._L) {
            _L.warn('Error fetching escrow_transactions fallback:', legacyErr);
          }
        } else if (ftxErr && window._L) {
          _L.warn('Error fetching financial transactions:', ftxErr);
        }

        TRANSACTIONS = Array.isArray(txRows) ? txRows : [];
        LIVE_FEED = TRANSACTIONS.slice(0, 8).map(t => ({
          dot: t.status === 'paid' ? 'ld-g' : (t.status === 'failed' ? 'ld-r' : 'ld-a'),
          text: `${t.type} | ${t.from} -> ${t.to} | ${fmt(t.amount)}`,
          time: t.date || 'recent'
        }));
        if (ftxMode === 'escrow_transactions' && TRANSACTIONS.length) {
          AUDIT_LOGS.unshift({
            time: now(),
            admin: currentAdminName,
            action: 'schema_fallback',
            detail: 'Using escrow_transactions fallback for ledger data.',
            type: 'warn'
          });
        }

        const { data: disputesData, error: disputesErr } = await sb
          .from('disputes')
          .select('id, project_id, reason, status, created_at')
          .order('created_at', { ascending: false });

        if (!disputesErr && Array.isArray(disputesData)) {
          DISPUTES = disputesData.map(d => {
            const project = PROJECTS.find(p => p.id === d.project_id);
            const raisedAt = d.created_at ? new Date(d.created_at) : null;
            const daysOpen = raisedAt ? Math.floor((Date.now() - raisedAt.getTime()) / 86400000) : 0;
            const priority = daysOpen >= 7 ? 'high' : (daysOpen >= 3 ? 'medium' : 'low');
            return {
              id: d.id,
              projId: d.project_id,
              project: project?.title || 'Project',
              client: project?.client || 'Client',
              dev: project?.dev || 'Developer',
              amount: Number(project?.value || 0),
              reason: d.reason || 'Dispute raised',
              raised: raisedAt ? raisedAt.toLocaleDateString() : 'Unknown',
              priority,
              status: d.status || 'open'
            };
          });
        } else if (isMissingTable(disputesErr, 'disputes')) {
          const milestoneRows = PROJECTS.flatMap(p =>
            (Array.isArray(p.milestones) ? p.milestones : [])
              .filter(m => ['disputed', 'submitted'].includes(String(m.status || '').toLowerCase()))
              .map(m => ({
                id: m.id,
                project_id: p.id,
                reason: m.status === 'disputed' ? 'Milestone marked disputed' : 'Milestone awaiting client review',
                status: m.status === 'disputed' ? 'open' : 'review',
                created_at: null
              }))
          );
          DISPUTES = milestoneRows.map(d => {
            const project = PROJECTS.find(p => p.id === d.project_id);
            return {
              id: d.id,
              projId: d.project_id,
              project: project?.title || 'Project',
              client: project?.client || 'Client',
              dev: project?.dev || 'Developer',
              amount: Number(project?.value || 0),
              reason: d.reason,
              raised: 'Active',
              priority: d.status === 'open' ? 'high' : 'medium',
              status: d.status
            };
          });
        } else if (disputesErr) {
          if (window._L) _L.warn("Error fetching disputes:", disputesErr);
          DISPUTES = [];
        }

        const { data: auditRows, error: auditErr } = await sb
          .from('audit_logs')
          .select('action, target_table, target_id, created_at, actor:profiles!audit_logs_actor_id_fkey(first_name,last_name,email)')
          .order('created_at', { ascending: false })
          .limit(100);
        if (!auditErr && Array.isArray(auditRows)) {
          AUDIT_LOGS = auditRows.map(a => {
            const actorName = a.actor
              ? `${a.actor.first_name || ''} ${a.actor.last_name || ''}`.trim() || a.actor.email || 'Admin'
              : 'Admin';
            return {
              time: a.created_at ? new Date(a.created_at).toLocaleString() : now(),
              admin: actorName,
              action: a.action || 'activity',
              detail: `${a.action || 'activity'} on ${a.target_table || 'table'} ${a.target_id || ''}`.trim(),
              type: 'info'
            };
          });
        } else if (isMissingTable(auditErr, 'audit_logs')) {
          AUDIT_LOGS = [];
          const sysNow = now();
          AUDIT_LOGS.push({
            time: sysNow,
            admin: currentAdminName,
            action: 'system_notice',
            detail: 'audit_logs table not found. Showing live operational data only.',
            type: 'warn'
          });
          AUDIT_LOGS.push({
            time: sysNow,
            admin: currentAdminName,
            action: 'dataset_sync',
            detail: `Loaded ${USERS.length} users, ${PROJECTS.length} projects, ${TRANSACTIONS.length} ledger entries.`,
            type: 'info'
          });
        }
      } catch (err) {
        if (window._L) _L.error("Unexpected error in loadAdminData:", err);
      }

      renderAll();
      if (window.hideLoader) hideLoader();
    }

    function renderAll() {
      renderDashboard();
      renderUsers();
      renderProjects();
      renderVault();
      renderDisputeCards('disputes-full-list');
      renderLedger();
      renderAudit();

      // Update top-level dashboard counts if elements exist
      if (document.getElementById('stat-users')) document.getElementById('stat-users').innerText = USERS.length;
      if (document.getElementById('stat-projects')) document.getElementById('stat-projects').innerText = PROJECTS.length;
      const openDisputes = DISPUTES.filter(d => d.status === 'open').length;
      const totalEscrow = Math.round(PROJECTS.reduce((acc, p) => acc + Number(p.value || 0), 0));
      const pending = TRANSACTIONS.filter(t => t.status === 'pending' || t.status === 'held').length;
      if (document.getElementById('stat-disputes')) document.getElementById('stat-disputes').innerText = openDisputes;
      if (document.getElementById('dispute-open-cnt')) document.getElementById('dispute-open-cnt').innerText = openDisputes;
      if (document.getElementById('nav-disputes-count')) document.getElementById('nav-disputes-count').innerText = openDisputes;
      if (document.getElementById('disputes-badge')) document.getElementById('disputes-badge').textContent = `${openDisputes} Active`;
      if (document.getElementById('stat-escrow')) document.getElementById('stat-escrow').innerText = `KSh ${totalEscrow.toLocaleString()}`;
      if (document.getElementById('stat-pending')) document.getElementById('stat-pending').innerText = pending;
      if (document.getElementById('nav-users-count')) document.getElementById('nav-users-count').innerText = USERS.length;
      if (document.getElementById('nav-proj-count')) document.getElementById('nav-proj-count').innerText = PROJECTS.length;
      updateAnalyticsSummary();
      renderTopDevelopers();
    }

    // Initialize fetching
    loadAdminData();





    /* """""""""""""""""""""""""""""""""""""""""""""""""""
       UNIVERSAL SIDEBAR TOGGLE  desktop collapse + mobile overlay
    """"""""""""""""""""""""""""""""""""""""""""""""""" */
    (function () {
      const LS_KEY = 'sc-sb-state';

      function getToggleBtn() {
        return document.getElementById('sb-toggle-btn');
      }
      function getSidebar() {
        return document.querySelector('.sidebar');
      }
      function getBackdrop() {
        return document.getElementById('sb-backdrop');
      }

      function isMobile() {
        return window.innerWidth <= 900;
      }

      function openMobile() {
        if (window._L) _L.debug("Sidebar: Opening mobile overlay");
        getSidebar().classList.add('mob-open');
        getBackdrop().classList.add('open');
        getToggleBtn().classList.add('is-open');
        document.body.style.overflow = 'hidden';
      }

      function closeMobile() {
        if (window._L) _L.debug("Sidebar: Closing mobile overlay");
        getSidebar().classList.remove('mob-open');
        getBackdrop().classList.remove('open');
        getToggleBtn().classList.remove('is-open');
        document.body.style.overflow = '';
      }

      function collapseDesktop() {
        document.body.classList.add('sb-collapsed');
        localStorage.setItem(LS_KEY, 'collapsed');
      }

      function expandDesktop() {
        document.body.classList.remove('sb-collapsed');
        localStorage.setItem(LS_KEY, 'expanded');
      }

      function toggleSidebar() {
        if (isMobile()) {
          getSidebar().classList.contains('mob-open') ? closeMobile() : openMobile();
        } else {
          document.body.classList.contains('sb-collapsed') ? expandDesktop() : collapseDesktop();
        }
      }

      // Restore desktop state from localStorage
      const saved = localStorage.getItem(LS_KEY);
      if (!isMobile() && saved === 'collapsed') {
        document.body.classList.add('sb-collapsed');
      }

      // Inject toggle button into topbar
      function injectToggle() {
        const topbar = document.querySelector('.topbar');
        if (!topbar || document.getElementById('sb-toggle-btn')) return;

        const btn = document.createElement('button');
        btn.id = 'sb-toggle-btn';
        btn.className = 'sb-toggle';
        btn.setAttribute('aria-label', 'Toggle sidebar');
        btn.innerHTML = '<span class="sb-toggle-bar"></span><span class="sb-toggle-bar"></span><span class="sb-toggle-bar"></span>';
        btn.addEventListener('click', toggleSidebar);
        topbar.insertBefore(btn, topbar.firstChild);
      }

      // Inject backdrop
      function injectBackdrop() {
        if (document.getElementById('sb-backdrop')) return;
        const bd = document.createElement('div');
        bd.id = 'sb-backdrop';
        bd.className = 'sb-backdrop';
        bd.addEventListener('click', closeMobile);
        document.body.appendChild(bd);
      }

      // Close mobile sidebar on nav item click
      function wireNavItems() {
        document.querySelectorAll('.ni, [onclick*="showPage"], [onclick*="nav("]').forEach(el => {
          el.addEventListener('click', () => {
            if (isMobile()) closeMobile();
          });
        });
      }

      // Reset on resize
      window.addEventListener('resize', () => {
        if (!isMobile()) {
          closeMobile(); // clean up mobile classes
        }
      });

      // ESC to close
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && isMobile()) closeMobile();
      });

      // Init
      document.addEventListener('DOMContentLoaded', () => {
        injectToggle();
        injectBackdrop();
        wireNavItems();
      });
      // Also run now in case DOM is ready
      if (document.readyState !== 'loading') {
        injectToggle();
        injectBackdrop();
        wireNavItems();
      }
    })();

  </script>
</body>

</html>



